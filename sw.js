(function(){"use strict";const x="1.2.1",h=`ehagaki-cache-${x}`,u="ehagaki-profile-images",f="eHagakiSharedData",p=1;let i=null;const m=[{"revision":null,"url":"assets/en-DZKxnpLP.js"},{"revision":null,"url":"assets/index-DDF2sw2H.css"},{"revision":null,"url":"assets/index-DhE8OZJS.js"},{"revision":null,"url":"assets/index.esm-B6zogCv1.js"},{"revision":null,"url":"assets/ja-CWOkBzNq.js"},{"revision":null,"url":"assets/workbox-window.prod.es5-CwtvwXb3.js"},{"revision":"94ecebcfe3aa698e9933c9800c886fb8","url":"index.html"},{"revision":"babe63f1867bfda88a54ea48714bacbf","url":"apple-touch-icon.png"},{"revision":"6fed39e02d6fc688225eddfb47cfd401","url":"ehagaki_icon_x192.png"},{"revision":"85177035c770f4dd3355b5575874a7e1","url":"ehagaki_icon_x512.png"},{"revision":"781b26f1ca16ee34e2a08db520649eb4","url":"ehagaki_icon.svg"},{"revision":"8565f947bbd349fec9860aa811536476","url":"ehagaki_icon.webp"},{"revision":"2bada714d92f8ac2c4775c7dd160ae4b","url":"ehagaki_ogp.webp"},{"revision":"80772041a3d7706a49eaf42dac91f5ad","url":"favicon.ico"},{"revision":"167bddd35a0ac0c3aaa141d18493fc0b","url":"maskable_icon_x192.png"},{"revision":"7df370b1e96677f8862bc129b565156d","url":"maskable_icon_x512.png"},{"revision":"81b5daf7a062038ca927790a306a4f1d","url":"icons/circle-user-solid-full.svg"},{"revision":"97a01045245952c64a77bf467c91a979","url":"icons/gear-solid-full.svg"},{"revision":"37d5908dc78c990de67476170ee51443","url":"icons/github-mark.svg"},{"revision":"26330813975ae0a2c805089b709b4275","url":"icons/image-solid-full.svg"},{"revision":"433f5bd2615322b08560d787c499dc3d","url":"icons/language-solid-full.svg"},{"revision":"b02a88451d35ed40d647402c53868871","url":"icons/nostr-login.svg"},{"revision":"2cb73309bb43ea470508684c229ec40f","url":"icons/paper-plane-solid-full.svg"},{"revision":"8cff7ee8121e2dbc6a5ce539a9020bb7","url":"icons/rotate-right-solid-full.svg"},{"revision":"5ece31773493febdbafeb032624e8b67","url":"icons/trash-solid-full.svg"},{"revision":"75b796fdf72212cf9fbfd5cfa133267f","url":"icons/xmark-solid-full.svg"},{"revision":"cb4ae2f1d456008a99af7e37c18d0c9a","url":"manifest.webmanifest"}]||[];self.addEventListener("install",e=>{console.log("SW installing...",x),e.waitUntil((async()=>{if(m.length>0)try{const t=await caches.open(h),a=m.map(r=>r.url);await t.addAll(a),console.log("SW cached resources:",a.length)}catch(t){console.error("プリキャッシュエラー:",t)}console.log("SW installed, waiting for user action")})())}),self.addEventListener("activate",e=>{console.log("SW activating...",x),e.waitUntil((async()=>{try{const t=await caches.keys();await Promise.all(t.map(a=>{if(a!==h&&a!==u)return caches.delete(a)})),await self.clients.claim()}catch(t){console.error("アクティベートエラー:",t)}})())}),self.addEventListener("fetch",e=>{const t=new URL(e.request.url);w(e.request,t)&&t.origin===self.location.origin?e.respondWith(y(e.request)):D(e.request)?e.respondWith(I(e.request)):t.origin===self.location.origin&&e.respondWith(C(e.request))}),self.addEventListener("message",e=>{if(e.data?.type==="SKIP_WAITING"){console.log("SW received SKIP_WAITING, updating..."),self.skipWaiting();return}if(e.data?.type==="GET_VERSION"){e.ports?.[0]?.postMessage({version:x});return}e.data?.action==="getSharedImage"&&P(e),e.data?.action==="clearProfileCache"&&S().then(()=>{e.ports?.[0]?.postMessage({success:!0})}).catch(t=>{console.error("プロフィールキャッシュクリアエラー:",t),e.ports?.[0]?.postMessage({success:!1,error:t.message})}),e.data?.action==="cleanupDuplicateProfileCache"&&k().then(()=>{e.ports?.[0]?.postMessage({success:!0})}).catch(t=>{console.error("重複キャッシュクリーンアップエラー:",t),e.ports?.[0]?.postMessage({success:!1,error:t.message})})});function w(e,t){return e.method==="POST"&&(t.pathname.endsWith("/upload")||t.pathname.includes("/ehagaki/upload"))}async function y(e){try{const a=(await e.formData()).get("image");return a?(i={image:a,metadata:{name:a.name,type:a.type,size:a.size,timestamp:new Date().toISOString()}},U().catch(r=>console.error("IndexedDB保存エラー:",r)),await E()):c("/ehagaki/","no-image")}catch(t){return console.error("アップロード処理エラー:",t),c("/ehagaki/","processing-error")}}async function E(){try{const e=await self.clients.matchAll({type:"window",includeUncontrolled:!0});return e.length>0?await A(e[0]):await R()}catch(e){return console.error("クライアント処理エラー:",e),c("/ehagaki/","client-error")}}async function A(e){try{await e.focus();for(let t=0;t<3;t++)setTimeout(()=>{try{e.postMessage({type:"SHARED_IMAGE",data:i,timestamp:Date.now(),retry:t})}catch(a){console.error(`メッセージ送信エラー (retry: ${t}):`,a)}},t*1e3);return c("/ehagaki/","success")}catch(t){return console.error("既存クライアント処理エラー:",t),c("/ehagaki/","messaging-error")}}async function R(){try{const e=new URL("/ehagaki/?shared=true",self.location.origin).href;return await self.clients.openWindow(e)?new Response("",{status:200,headers:{"Content-Type":"text/plain"}}):c("/ehagaki/","window-error")}catch(e){return console.error("新しいウィンドウ作成エラー:",e),c("/ehagaki/","open-window-error")}}async function C(e){try{const t=await caches.open(h),a=await t.match(e);if(a)return a;const r=await fetch(e);return r.ok&&e.method==="GET"&&await t.put(e,r.clone()),r}catch(t){return console.error("キャッシュ戦略エラー:",t),new Response("Not Found",{status:404})}}function D(e){return e.method!=="GET"?!1:new URL(e.url).searchParams.get("profile")==="true"}async function I(e){try{const t=await caches.open(u),a=new URL(e.url),r=`${a.origin}${a.pathname}`,o=new Request(r,{method:e.method,headers:new Headers({Accept:"image/avif,image/webp,image/apng,image/svg+xml,image/*,*/*;q=0.8"}),mode:"cors",credentials:"omit"}),s=await t.match(o);if(s)return console.log("プロフィール画像をキャッシュから返却（ベースURL）:",r),s;const n=await t.match(e);if(n)return console.log("プロフィール画像をキャッシュから返却（元URL）:",e.url),n;if(navigator.onLine!==!1)try{const g=new Request(e.url,{method:"GET",headers:new Headers({Accept:"image/avif,image/webp,image/apng,image/svg+xml,image/*,*/*;q=0.8","Cache-Control":"no-cache"}),mode:"cors",credentials:"omit",cache:"no-cache"}),d=await fetch(g);if(d.ok&&d.status===200){const b=d.clone();return await t.put(o,b),console.log("プロフィール画像をキャッシュに保存（ベースURL）:",r),d}}catch(g){console.log("ネットワークエラー:",g.message)}const l=new Response(new Uint8Array([137,80,78,71,13,10,26,10,0,0,0,13,73,72,68,82,0,0,0,1,0,0,0,1,8,6,0,0,0,31,21,196,137,0,0,0,10,73,68,65,84,120,156,99,0,1,0,0,5,0,1,13,10,45,180,0,0,0,0,73,69,78,68,174,66,96,130]),{status:200,statusText:"OK",headers:{"Content-Type":"image/png","Cache-Control":"max-age=31536000","Access-Control-Allow-Origin":"*"}});return console.log("フォールバック画像を返却:",e.url),l}catch(t){return console.error("プロフィール画像処理エラー:",t),new Response(new Uint8Array([137,80,78,71,13,10,26,10,0,0,0,13,73,72,68,82,0,0,0,1,0,0,0,1,8,6,0,0,0,31,21,196,137,0,0,0,10,73,68,65,84,120,156,99,0,1,0,0,5,0,1,13,10,45,180,0,0,0,0,73,69,78,68,174,66,96,130]),{status:200,headers:{"Content-Type":"image/png","Access-Control-Allow-Origin":"*"}})}}async function S(){try{const e=await caches.delete(u);return console.log("プロフィール画像キャッシュクリア:",e),e}catch(e){throw console.error("プロフィール画像キャッシュクリアエラー:",e),e}}async function k(){try{const e=await caches.open(u),t=await e.keys(),a=new Set,r=[];t.forEach(s=>{const n=new URL(s.url),l=`${n.origin}${n.pathname}`;n.search?r.push(s):a.add(l)});let o=0;for(const s of r){const n=new URL(s.url),l=`${n.origin}${n.pathname}`;a.has(l)&&(await e.delete(s),o++,console.log("重複キャッシュを削除:",s.url))}return console.log(`重複プロフィールキャッシュクリーンアップ完了: ${o}件削除`),!0}catch(e){throw console.error("重複キャッシュクリーンアップエラー:",e),e}}function c(e,t=null){const a=new URL(e,self.location.origin);return t&&(a.searchParams.set("shared","true"),a.searchParams.set("error",t)),Response.redirect(a.href,303)}async function U(){return new Promise((e,t)=>{try{const a=indexedDB.open(f,p);a.onupgradeneeded=r=>{const o=r.target.result;o.objectStoreNames.contains("flags")||o.createObjectStore("flags",{keyPath:"id"})},a.onerror=()=>t(new Error("IndexedDB open failed")),a.onsuccess=r=>{try{const o=r.target.result,s=o.transaction(["flags"],"readwrite"),n=s.objectStore("flags");n.put({id:"sharedImage",timestamp:Date.now(),value:!0}).onsuccess=()=>{o.close(),e()},s.onerror=()=>{o.close(),t(new Error("Failed to store shared flag"))}}catch(o){t(o)}}}catch(a){t(a)}})}function P(e){const t=e.source,a=e.data.requestId||null,r={type:"SHARED_IMAGE",data:i,requestId:a,timestamp:Date.now()};e.ports?.[0]?e.ports[0].postMessage(r):t&&t.postMessage(r),i&&(i=null,N())}function N(){try{const e=indexedDB.open(f,p);e.onsuccess=t=>{try{const a=t.target.result;if(!a.objectStoreNames.contains("flags")){a.close();return}const r=a.transaction(["flags"],"readwrite"),o=r.objectStore("flags");o.delete("sharedImage").onsuccess=()=>a.close(),r.onerror=()=>a.close()}catch{}}}catch{}}})();

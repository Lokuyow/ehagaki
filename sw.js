(function(){"use strict";const t=(...e)=>console.log("[ServiceWorker]",...e),c=(...e)=>console.error("[ServiceWorker]",...e);let i=null;const h="ehagaki-cache-v0.1.8",g=[{"revision":null,"url":"assets/en-BmSzfbsb.js"},{"revision":null,"url":"assets/index-CfJZSx5r.js"},{"revision":null,"url":"assets/index-oi5e53eP.css"},{"revision":null,"url":"assets/ja-C0j-_ObD.js"},{"revision":"b15a2fbc06dea6468b764562ec25062a","url":"index.html"},{"revision":"8eb63de4f91d4fd83cd1bb6e20414ce3","url":"registerSW.js"},{"revision":"72cb1a250c643f80d5eb582a77786d9d","url":"hagaki_2mai.png"},{"revision":"b7c4e1df1ee4ac2162296f7fa9305656","url":"icons/circle-user-solid-full.svg"},{"revision":"97a01045245952c64a77bf467c91a979","url":"icons/gear-solid-full.svg"},{"revision":"37d5908dc78c990de67476170ee51443","url":"icons/github-mark.svg"},{"revision":"26330813975ae0a2c805089b709b4275","url":"icons/image-solid-full.svg"},{"revision":"0db89f4cdf2bcdabb6d369d82c013a97","url":"icons/language-solid.svg"},{"revision":"7569a819cc451dcfb3503e060b316838","url":"manifest.webmanifest"}];if(g&&g.length>0){const e=h;self.addEventListener("install",r=>{t("インストールされました - プリキャッシュ開始"),r.waitUntil((async()=>{try{const n=await caches.open(e),a=g.map(s=>s.url);await n.addAll(a),t("プリキャッシュ完了:",a)}catch(n){c("プリキャッシュ失敗:",n)}await self.skipWaiting()})())})}self.addEventListener("fetch",e=>{const r=new URL(e.request.url);e.request.method==="POST"&&(r.pathname.endsWith("/upload")||r.pathname.includes("/ehagaki/upload"))?e.respondWith((async()=>{t("画像アップロードリクエストをWorkboxで処理します",e.request.url);try{t("フォームデータを処理中...");const s=(await e.request.formData()).get("image");if(!s)return c("画像データがありません"),Response.redirect(new URL("/ehagaki/",self.location.origin).href,303);t("画像を受信しました:",s.name,`タイプ: ${s.type}`,`サイズ: ${Math.round(s.size/1024)}KB`),i={image:s,metadata:{name:s.name,type:s.type,size:s.size,timestamp:new Date().toISOString()}};try{await f(),t("IndexedDBに共有フラグを保存しました")}catch(o){c("IndexedDB保存エラー:",o)}const d=await self.clients.matchAll({type:"window",includeUncontrolled:!0});if(d.length>0){const o=d[0];t("既存のクライアントにフォーカス:",o.id);try{await o.focus();const l=(u=0)=>{try{o.postMessage({type:"SHARED_IMAGE",data:i,timestamp:Date.now(),retry:u}),t(`画像データ${u>0?"再":""}送信 (${u}回目)`)}catch(p){c("メッセージ送信エラー:",p)}};return l(),setTimeout(()=>l(1),1e3),setTimeout(()=>l(2),2e3),Response.redirect(new URL("/ehagaki/?shared=true",self.location.origin).href,303)}catch(l){return c("メッセージ送信エラー:",l),Response.redirect(new URL("/ehagaki/?shared=true&error=messaging",self.location.origin).href,303)}}else{t("クライアントがないので新規ウィンドウを開きます");try{const o=new URL("/ehagaki/?shared=true",self.location.origin).href;return t("新規ウィンドウを開きます:",o),await self.clients.openWindow(o)?(t("新しいウィンドウを開きました"),new Response("",{status:200,headers:{"Content-Type":"text/plain"}})):(c("新しいウィンドウを開けませんでした"),Response.redirect(new URL("/ehagaki/?shared=true&error=window",self.location.origin).href,303))}catch(o){return c("ウィンドウオープンエラー:",o),Response.redirect(new URL("/ehagaki/?shared=true&error=openWindow",self.location.origin).href,303)}}}catch(a){return c("画像処理エラー:",a),Response.redirect(new URL("/ehagaki/?shared=true&error=processing",self.location.origin).href,303)}})()):r.origin===self.location.origin?e.respondWith((async()=>{try{const a=await caches.open(h),s=await a.match(e.request);if(s)return t("キャッシュからレスポンス:",e.request.url),s;t("ネットワークからフェッチ:",e.request.url);const d=await fetch(e.request);if(d.ok&&e.request.method==="GET"){const o=d.clone();await a.put(e.request,o),t("ネットワーク応答をキャッシュに保存:",e.request.url)}return d}catch(a){return a("フェッチエラー:",e.request.url,a),new Response("Not Found",{status:404})}})()):e.respondWith(fetch(e.request))});async function f(){return new Promise((e,r)=>{try{const n=indexedDB.open("eHagakiSharedData",1);n.onupgradeneeded=a=>{const s=a.target.result;s.objectStoreNames.contains("flags")||s.createObjectStore("flags",{keyPath:"id"})},n.onerror=()=>r(new Error("IndexedDB open failed")),n.onsuccess=a=>{try{const o=a.target.result.transaction(["flags"],"readwrite").objectStore("flags"),l={id:"sharedImage",timestamp:Date.now(),value:!0},u=o.put(l);u.onsuccess=()=>e(),u.onerror=()=>r(new Error("Failed to store shared flag"))}catch(s){r(s)}}}catch(n){r(n)}})}self.addEventListener("install",e=>{t("インストールされました"),e.waitUntil(self.skipWaiting())}),self.addEventListener("activate",e=>{t("アクティブになりました - スコープ:",self.registration.scope),e.waitUntil((async()=>{const r=[h],n=await caches.keys();await Promise.all(n.map(a=>{if(!r.includes(a))return t("不要なキャッシュを削除:",a),caches.delete(a)})),await self.clients.claim()})())}),self.addEventListener("message",e=>{const r=e.source;if(t("メッセージ受信:",e.data?.action,"from client:",r?.id),e.data&&e.data.type==="SKIP_WAITING"){t("SKIP_WAITINGを受信、skipWaiting実行"),self.skipWaiting();return}if(e.data&&e.data.action==="getSharedImage"){t("クライアントに共有画像データのリクエストを受信");const n=e.data.requestId||null,a={type:"SHARED_IMAGE",data:i,requestId:n,timestamp:Date.now()};t("共有画像キャッシュ状態:",i?"あり":"なし"),i&&t("キャッシュ内容:",{imageName:i.image?.name,imageSize:i.image?.size,imageType:i.image?.type,metadata:i.metadata}),e.ports&&e.ports[0]?(e.ports[0].postMessage(a),t("MessageChannelでデータを送信")):r&&(r.postMessage(a),t("通常の応答でデータを送信")),i?(t("送信したデータ:",i.image?.name,i.metadata),setTimeout(()=>{i&&(t("共有画像キャッシュをクリアします"),i=null)},6e4)):t("共有画像キャッシュがありません")}})})();

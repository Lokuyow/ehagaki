(function(){"use strict";let c=null;const d="ehagaki-cache-v0.2.3",h=[{"revision":null,"url":"assets/en-V4vKRyQ1.js"},{"revision":null,"url":"assets/index-BY8hn3MZ.js"},{"revision":null,"url":"assets/index-D_m2ZHSX.css"},{"revision":null,"url":"assets/ja-tbId-BL3.js"},{"revision":"b3d28228eded9f0299b3bcf57c01b72f","url":"index.html"},{"revision":"8eb63de4f91d4fd83cd1bb6e20414ce3","url":"registerSW.js"},{"revision":"72cb1a250c643f80d5eb582a77786d9d","url":"hagaki_2mai.png"},{"revision":"b7c4e1df1ee4ac2162296f7fa9305656","url":"icons/circle-user-solid-full.svg"},{"revision":"97a01045245952c64a77bf467c91a979","url":"icons/gear-solid-full.svg"},{"revision":"37d5908dc78c990de67476170ee51443","url":"icons/github-mark.svg"},{"revision":"26330813975ae0a2c805089b709b4275","url":"icons/image-solid-full.svg"},{"revision":"0db89f4cdf2bcdabb6d369d82c013a97","url":"icons/language-solid.svg"},{"revision":"7569a819cc451dcfb3503e060b316838","url":"manifest.webmanifest"}];if(h&&h.length>0){const e=d;self.addEventListener("install",s=>{s.waitUntil((async()=>{try{const r=await caches.open(e),t=h.map(a=>a.url);await r.addAll(t)}catch{}await self.skipWaiting()})())})}self.addEventListener("fetch",e=>{const s=new URL(e.request.url);e.request.method==="POST"&&(s.pathname.endsWith("/upload")||s.pathname.includes("/ehagaki/upload"))?e.respondWith((async()=>{try{const a=(await e.request.formData()).get("image");if(!a)return Response.redirect(new URL("/ehagaki/",self.location.origin).href,303);c={image:a,metadata:{name:a.name,type:a.type,size:a.size,timestamp:new Date().toISOString()}};try{await u()}catch{}const i=await self.clients.matchAll({type:"window",includeUncontrolled:!0});if(i.length>0){const n=i[0];try{await n.focus();const o=(l=0)=>{try{n.postMessage({type:"SHARED_IMAGE",data:c,timestamp:Date.now(),retry:l})}catch{}};return o(),setTimeout(()=>o(1),1e3),setTimeout(()=>o(2),2e3),Response.redirect(new URL("/ehagaki/?shared=true",self.location.origin).href,303)}catch{return Response.redirect(new URL("/ehagaki/?shared=true&error=messaging",self.location.origin).href,303)}}else try{const n=new URL("/ehagaki/?shared=true",self.location.origin).href;return await self.clients.openWindow(n)?new Response("",{status:200,headers:{"Content-Type":"text/plain"}}):Response.redirect(new URL("/ehagaki/?shared=true&error=window",self.location.origin).href,303)}catch{return Response.redirect(new URL("/ehagaki/?shared=true&error=openWindow",self.location.origin).href,303)}}catch{return Response.redirect(new URL("/ehagaki/?shared=true&error=processing",self.location.origin).href,303)}})()):s.origin===self.location.origin?e.respondWith((async()=>{try{const t=await caches.open(d),a=await t.match(e.request);if(a)return a;const i=await fetch(e.request);if(i.ok&&e.request.method==="GET"){const n=i.clone();await t.put(e.request,n)}return i}catch{return new Response("Not Found",{status:404})}})()):e.respondWith(fetch(e.request))});async function u(){return new Promise((e,s)=>{try{const r=indexedDB.open("eHagakiSharedData",1);r.onupgradeneeded=t=>{const a=t.target.result;a.objectStoreNames.contains("flags")||a.createObjectStore("flags",{keyPath:"id"})},r.onerror=()=>s(new Error("IndexedDB open failed")),r.onsuccess=t=>{try{const n=t.target.result.transaction(["flags"],"readwrite").objectStore("flags"),o={id:"sharedImage",timestamp:Date.now(),value:!0},l=n.put(o);l.onsuccess=()=>e(),l.onerror=()=>s(new Error("Failed to store shared flag"))}catch(a){s(a)}}}catch(r){s(r)}})}self.addEventListener("install",e=>{e.waitUntil(self.skipWaiting())}),self.addEventListener("activate",e=>{e.waitUntil((async()=>{const s=[d],r=await caches.keys();await Promise.all(r.map(t=>{if(!s.includes(t))return caches.delete(t)})),await self.clients.claim()})())}),self.addEventListener("message",e=>{const s=e.source;if(e.data&&e.data.type==="SKIP_WAITING"){self.skipWaiting();return}if(e.data&&e.data.action==="getSharedImage"){const r=e.data.requestId||null,t={type:"SHARED_IMAGE",data:c,requestId:r,timestamp:Date.now()};e.ports&&e.ports[0]?e.ports[0].postMessage(t):s&&s.postMessage(t),c&&setTimeout(()=>{c=null},3e4)}})})();

(function(){"use strict";const u="1.12.0",x=`ehagaki-cache-${u}`,g="ehagaki-profile-images",C="eHagakiSharedData",I=1,A=100*1024*1024,B=(()=>{const e=self.location.pathname.split("/").filter(a=>a&&a!=="sw.js");return e.length>0?"/"+e.join("/")+"/":"/"})();let p=[];try{p=[{"revision":"0038a604f0aea52a481bf133f72f8b99","url":"index.html"},{"revision":"19d26463a5c5da7616a183919dcbd7d0","url":"ffmpeg-core/ffmpeg-core.js"},{"revision":"5eba628f590b7260839d355d273d778a","url":"assets/worker-DYSz7Krg.js"},{"revision":"07d1c6099570f23c79273d95d440dd66","url":"assets/workbox-window.prod.es5-BIl4cyR9.js"},{"revision":"364b6688097cfc537a05b99ae0456faa","url":"assets/vendor-zap-DuBBJg9r.js"},{"revision":"b7301c92831bf1e2d05d1d9b28b74ef2","url":"assets/vendor-video-BBTp-AV6.js"},{"revision":"1d00f00283ff52463db3eaa2322b77ce","url":"assets/vendor-ui-Dfbvke9w.js"},{"revision":"62e01ece890e58dc70b757a029f276a5","url":"assets/vendor-ui-BpcL6yKj.css"},{"revision":"b6146f85cc08d366d68df17e3e957060","url":"assets/vendor-nostr-CSSTtp-a.js"},{"revision":"5f2cc315f43db8a0434dc50f78108be3","url":"assets/vendor-image-DhZoa7y2.js"},{"revision":"e5c9202d6e3a1c45eeb3d062a4bfe6c0","url":"assets/vendor-editor-DymEIdpa.js"},{"revision":"4d2e1e8aec2f7e696e01191c253c799b","url":"assets/mediabunnyCompression-DhaELIzK.js"},{"revision":"65e3fa503e5eaf66f11ad11a21a2d8ea","url":"assets/ja-Wg-rpho_.js"},{"revision":"5b2946f3bb1609fdf70a7ce56b98533b","url":"assets/index.esm-ocKONXP9.js"},{"revision":"b8ca3cc896ce0a3b56282a968c1c7c6c","url":"assets/index-tWXHFDH-.js"},{"revision":"f38e117e1aa6c10fa755cbfbf69be65f","url":"assets/index-ByrdEVdw.css"},{"revision":"9c95019f4cbf095a4205618c8c137832","url":"assets/ffmpegCompression-D4sZOaeN.js"},{"revision":"241a5c9219aa6ed1c7cad25284ef1b4c","url":"assets/en-Dk7iqH7D.js"},{"revision":"d0595dd20f0fd10c45b6bf2c6fe3473a","url":"assets/baseCompression-DqFYQzC2.js"},{"revision":"7df370b1e96677f8862bc129b565156d","url":"maskable_icon_x512.png"},{"revision":"167bddd35a0ac0c3aaa141d18493fc0b","url":"maskable_icon_x192.png"},{"revision":"80772041a3d7706a49eaf42dac91f5ad","url":"favicon.ico"},{"revision":"2bada714d92f8ac2c4775c7dd160ae4b","url":"ehagaki_ogp.webp"},{"revision":"85177035c770f4dd3355b5575874a7e1","url":"ehagaki_icon_x512.png"},{"revision":"6fed39e02d6fc688225eddfb47cfd401","url":"ehagaki_icon_x192.png"},{"revision":"29bad677c14a3d64f60f0a3aa18d8457","url":"ehagaki_icon_circle.webp"},{"revision":"36d39867bd2ebbff838ffab6f7536435","url":"ehagaki_icon.webp"},{"revision":"781b26f1ca16ee34e2a08db520649eb4","url":"ehagaki_icon.svg"},{"revision":"babe63f1867bfda88a54ea48714bacbf","url":"apple-touch-icon.png"},{"revision":"75b796fdf72212cf9fbfd5cfa133267f","url":"icons/xmark-solid-full.svg"},{"revision":"5ece31773493febdbafeb032624e8b67","url":"icons/trash-solid-full.svg"},{"revision":"2945f4b3263a387ea0451669a86279c5","url":"icons/thumbtack-solid-full.svg"},{"revision":"fcdc7cbbd132691024ff21612440cebc","url":"icons/thumbtack-slash-solid-full.svg"},{"revision":"a13d78cfd398431709a77fa7170e53a5","url":"icons/stop-solid-full.svg"},{"revision":"8cff7ee8121e2dbc6a5ce539a9020bb7","url":"icons/rotate-right-solid-full.svg"},{"revision":"25a643b44573514dcccc6505269b7dd2","url":"icons/play_pause_24dp_000000_FILL0_wght400_GRAD0_opsz24.svg"},{"revision":"2cb73309bb43ea470508684c229ec40f","url":"icons/paper-plane-solid-full.svg"},{"revision":"b02a88451d35ed40d647402c53868871","url":"icons/nostr-login.svg"},{"revision":"0045fae966e1215be6b4c3db1431fc91","url":"icons/list-solid-full.svg"},{"revision":"433f5bd2615322b08560d787c499dc3d","url":"icons/language-solid-full.svg"},{"revision":"26330813975ae0a2c805089b709b4275","url":"icons/image-solid-full.svg"},{"revision":"9e76afe18ba3c520ed4c2f06573e24db","url":"icons/hashtag-solid-full.svg"},{"revision":"37d5908dc78c990de67476170ee51443","url":"icons/github-mark.svg"},{"revision":"97a01045245952c64a77bf467c91a979","url":"icons/gear-solid-full.svg"},{"revision":"6cdac536eb730828f21fa0dcf3fd4814","url":"icons/floppy-disk-solid-full.svg"},{"revision":"2c0bf03c27d835675c5a7b3020521939","url":"icons/eye-slash-solid-full.svg"},{"revision":"cfe7c3589a1fd3dd297a0e12849d26f2","url":"icons/expand-solid-full.svg"},{"revision":"bb07a82a78fb6c0880c35878d14c3fc9","url":"icons/copy-solid-full.svg"},{"revision":"81b5daf7a062038ca927790a306a4f1d","url":"icons/circle-user-solid-full.svg"},{"revision":"d592924a3c8cbd0f6b6102b4af1e9e0b","url":"icons/circle-question-solid-full.svg"},{"revision":"7bc2c70c1c45f1665dd3eff02957c2fd","url":"icons/circle-info-solid-full.svg"},{"revision":"fb4dff8289f12362c787b40070e54130","url":"manifest.webmanifest"}]||[],p.length===0?console.warn("SW: Precache manifest is empty"):console.log(`SW: Precache manifest loaded with ${p.length} entries`)}catch(r){console.error("SW: Failed to load precache manifest:",r),p=[]}const d={sharedMediaCache:null,precacheManifest:p,getSharedMediaCache(){return this.sharedMediaCache},setSharedMediaCache(r){this.sharedMediaCache=r},clearSharedMediaCache(){this.sharedMediaCache=null}},n={caches:self.caches,indexedDB:self.indexedDB,clients:self.clients,fetch:self.fetch.bind(self),console:self.console,location:self.location,navigator:self.navigator,setTimeout:self.setTimeout.bind(self)},F=new Uint8Array([137,80,78,71,13,10,26,10,0,0,0,13,73,72,68,82,0,0,0,1,0,0,0,1,8,6,0,0,0,31,21,196,137,0,0,0,10,73,68,65,84,120,156,99,0,1,0,0,5,0,1,13,10,45,180,0,0,0,0,73,69,78,68,174,66,96,130]),i={createTransparentImageResponse(r=200){return new Response(F,{status:r,statusText:r===200?"OK":"Error",headers:{"Content-Type":"image/png","Cache-Control":r===200?"max-age=31536000":"no-cache","Access-Control-Allow-Origin":"*"}})},createCorsRequest(r,e={}){const a=e.mode||"cors",s=new Headers({Accept:"image/avif,image/webp,image/apng,image/svg+xml,image/*,*/*;q=0.8",...e.headers||{}});return new Request(r,{method:"GET",headers:s,mode:a,credentials:"omit",cache:e.cache||"default",redirect:"follow",...e})},getBaseUrl(r){const e=new URL(r);return`${e.origin}${e.pathname}`},createRedirectResponse(r=B,e=null,a=n.location){const s=new URL(r,a.origin);return e&&(s.searchParams.set("shared","true"),s.searchParams.set("error",e)),Response.redirect(s.href,303)},isUploadRequest(r,e){return r.method==="POST"&&(e.pathname.endsWith("/upload")||e.pathname.includes("/upload"))},isProfileImageRequest(r){return r.method!=="GET"?!1:new URL(r.url).searchParams.get("profile")==="true"},async extractMediaFromFormData(r){const e=r.getAll("media");if(!e||e.length===0)return null;const a=e.filter(s=>s instanceof File&&s.size>0);return a.length===0?null:{images:a,metadata:a.map(s=>({name:s.name,type:s.type,size:s.size,timestamp:new Date().toISOString()}))}}};class m{constructor(e=n){this.indexedDB=e.indexedDB,this.console=e.console}async executeOperation(e){return new Promise((a,s)=>{try{const t=this.indexedDB.open(C,I);t.onupgradeneeded=o=>{const c=o.target.result;c.objectStoreNames.contains("flags")||c.createObjectStore("flags",{keyPath:"id"})},t.onerror=()=>s(new Error("IndexedDB open failed")),t.onsuccess=o=>{const c=o.target.result;try{e(c,a,s)}catch(l){c.close(),s(l)}}}catch(t){s(t)}})}async saveSharedFlag(){return this.executeOperation((e,a,s)=>{const t=e.transaction(["flags"],"readwrite"),o=t.objectStore("flags");o.put({id:"sharedMedia",timestamp:Date.now(),value:!0}).onsuccess=()=>{e.close(),a()},t.onerror=()=>{e.close(),s(new Error("Failed to store shared flag"))}})}async clearSharedFlag(){try{await this.executeOperation((e,a)=>{if(!e.objectStoreNames.contains("flags")){e.close(),a();return}const s=e.transaction(["flags"],"readwrite"),t=s.objectStore("flags");t.delete("sharedMedia").onsuccess=()=>{e.close(),a()},s.onerror=()=>{e.close(),a()}})}catch(e){this.console.error("IndexedDB error:",e)}}}class M{constructor(e=n){this.caches=e.caches,this.fetch=e.fetch,this.console=e.console}async precacheResources(e){if(!e||e.length===0){this.console.warn("SW: No resources to precache");return}try{const a=await this.caches.open(x),s=e.map(t=>typeof t=="string"?t:t&&typeof t=="object"&&t.url?t.url:(this.console.warn("SW: Invalid manifest entry:",t),null)).filter(Boolean);if(s.length>0){for(let o=0;o<s.length;o+=10){const c=s.slice(o,o+10);try{await a.addAll(c),this.console.log(`SW: Cached batch ${Math.floor(o/10)+1}: ${c.length} resources`)}catch(l){this.console.error(`SW: Failed to cache batch ${Math.floor(o/10)+1}:`,l);for(const f of c)try{await a.add(f)}catch(S){this.console.error(`SW: Failed to cache individual resource: ${f}`,S)}}}this.console.log(`SW: Successfully cached ${s.length} resources`)}else this.console.warn("SW: No valid URLs to cache")}catch(a){this.console.error("SW: Precache error:",a)}}async cleanupOldCaches(){try{const e=await this.caches.keys();await Promise.all(e.map(a=>{if(a!==x&&a!==g)return this.caches.delete(a)}))}catch(e){this.console.error("キャッシュクリーンアップエラー:",e)}}async handleCacheFirst(e){try{const a=await this.caches.open(x),s=await a.match(e);if(s)return s;const t=await this.fetch(e);return t.ok&&e.method==="GET"&&await a.put(e,t.clone()),t}catch(a){return this.console.error("キャッシュ戦略エラー:",a),new Response("Not Found",{status:404})}}async handleProfileImageCache(e){try{const a=await this.caches.open(g),s=i.getBaseUrl(e.url),t=i.createCorsRequest(s,{mode:"no-cors"}),o=await a.match(t);if(o)return this.console.log("プロフィール画像をキャッシュから返却（ベースURL）:",s),o;const c=await a.match(e);return c?(this.console.log("プロフィール画像をキャッシュから返却（元URL）:",e.url),c):null}catch(a){return this.console.error("プロフィールキャッシュエラー:",a),null}}async fetchAndCacheProfileImage(e){if(n.navigator&&n.navigator.onLine===!1)return null;try{const a=i.getBaseUrl(e.url),s=i.createCorsRequest(a,{mode:"no-cors",headers:{"Cache-Control":"no-cache"},cache:"no-cache"});this.console.log("プロフィール画像をネットワークから取得中:",a);const t=await this.fetch(s);if(t&&(t.ok||t.type==="opaque")){const o=await this.caches.open(g),c=i.createCorsRequest(a,{mode:"no-cors"});try{await o.put(c,t.clone()),this.console.log("プロフィール画像をキャッシュに保存完了:",a)}catch(l){this.console.warn("プロフィール画像のキャッシュ保存に失敗:",l,a)}return t}else this.console.warn("プロフィール画像の取得に失敗または非OKレスポンス:",t&&t.type,t&&t.status,t&&t.statusText)}catch(a){this.console.log("プロフィール画像のネットワークエラー:",a&&a.message)}return null}async clearProfileCache(){try{const e=await this.caches.delete(g);return this.console.log("プロフィール画像キャッシュクリア:",e),{success:!0}}catch(e){return this.console.error("プロフィールキャッシュクリアエラー:",e),{success:!1,error:e.message}}}async cleanupDuplicateProfileCache(){try{const e=await this.caches.open(g),a=await e.keys(),s=new Set,t=[];a.forEach(c=>{const l=new URL(c.url),f=i.getBaseUrl(c.url);l.search?t.push(c):s.add(f)});let o=0;for(const c of t){const l=i.getBaseUrl(c.url);s.has(l)&&(await e.delete(c),o++,this.console.log("重複キャッシュを削除:",c.url))}return this.console.log(`重複プロフィールキャッシュクリーンアップ完了: ${o}件削除`),{success:!0,deletedCount:o}}catch(e){return this.console.error("重複キャッシュクリーンアップエラー:",e),{success:!1,error:e.message}}}}class D{constructor(e=n){this.clients=e.clients,this.console=e.console,this.location=e.location,this.setTimeout=e.setTimeout}async redirectClient(){try{const e=await this.clients.matchAll({type:"window",includeUncontrolled:!0});return e.length>0?await this.focusAndNotifyClient(e[0]):await this.openNewClient()}catch(e){return this.console.error("クライアント処理エラー:",e),i.createRedirectResponse(void 0,"client-error",this.location)}}async focusAndNotifyClient(e){try{await e.focus();const a=d.getSharedMediaCache();if(this.console.log("SW: Attempting to notify client",{hasClient:!!e,hasPostMessage:typeof e.postMessage=="function",hasSharedCache:!!a,clientId:e.id||"unknown"}),a)try{const s=new m;await this.persistSharedMediaToIndexedDB(a,s),this.console.log("SW: Shared media persisted to IndexedDB for fallback")}catch(s){this.console.warn("SW: Failed to persist shared media to IndexedDB:",s)}if(e&&typeof e.postMessage=="function")try{e.postMessage({type:"SHARED_MEDIA",data:a,timestamp:Date.now(),requestId:`sw-${Date.now()}`}),this.console.log("SW: Message sent to client successfully")}catch(s){this.console.warn("SW: Failed to send message to client (will rely on IndexedDB fallback):",s)}return i.createRedirectResponse()}catch(a){return this.console.error("SW: Client focus/notification error:",a),i.createRedirectResponse(void 0,"client-error",this.location)}}async persistSharedMediaToIndexedDB(e,a){return a.executeOperation(async(s,t,o)=>{try{const c=e.images||(e.image?[e.image]:[]),l=await Promise.all(c.map(async h=>{const y={name:h.name,type:h.type,size:h.size,_isFile:!0};if(h instanceof File){if(h.size>A)return this.console.warn(`SW: File too large for IndexedDB persistence (${h.size} bytes), storing metadata only: ${h.name}`),y;try{const P=await h.arrayBuffer();return{...y,arrayBuffer:P}}catch{return y}}return y})),f={id:"sharedMediaData",timestamp:Date.now(),data:{images:l,metadata:e.metadata}},S=s.transaction(["flags"],"readwrite"),T=S.objectStore("flags");T.put(f).onsuccess=()=>{s.close(),t()},S.onerror=()=>{s.close(),o(new Error("Failed to persist shared media data"))}}catch(c){s.close(),o(c)}})}}class R{constructor(e=new m,a=n){this.indexedDBManager=e,this.console=a.console}respondSharedMedia(e){const a=e.source,s=e.data.requestId||null,t=d.getSharedMediaCache(),o={type:"SHARED_MEDIA",data:t,requestId:s,timestamp:Date.now()};e.ports?.[0]?e.ports[0].postMessage(o):a&&a.postMessage(o),t&&(d.clearSharedMediaCache(),this.indexedDBManager.clearSharedFlag())}respondSharedMediaForce(e){const a=e.source,s=e.data.requestId||null,t=d.getSharedMediaCache();t||this.console.log("SW: No shared cache, client should try IndexedDB fallback");const o={type:"SHARED_MEDIA",data:t,requestId:s,timestamp:Date.now(),fallbackRequired:!t};e.ports?.[0]?e.ports[0].postMessage(o):a&&a.postMessage(o)}}class E{constructor(e=new M,a=new D,s=new m,t=n){this.cacheManager=e,this.clientManager=a,this.indexedDBManager=s,this.console=t.console,this.location=t.location}async handleUploadRequest(e){try{this.console.log("SW: Processing upload request",e.url);const a=await e.formData(),s=await i.extractMediaFromFormData(a);if(!s)return this.console.warn("SW: No media data found in FormData"),i.createRedirectResponse(void 0,"no-image",this.location);this.console.log("SW: Media data extracted successfully",{hasImages:!!s.images,imageCount:s.images?.length,firstImageType:s.images?.[0]?.type,firstImageSize:s.images?.[0]?.size}),d.setSharedMediaCache(s);try{await this.indexedDBManager.saveSharedFlag(),this.console.log("SW: Shared flag saved to IndexedDB")}catch(t){this.console.error("SW: IndexedDB save error:",t)}return await this.clientManager.redirectClient()}catch(a){return this.console.error("SW: Upload processing error:",a),i.createRedirectResponse(void 0,"processing-error",this.location)}}async handleProfileImageRequest(e){try{this.console.log("プロフィール画像リクエスト処理開始:",e.url);const a=await this.cacheManager.handleProfileImageCache(e);if(a)return this.console.log("プロフィール画像をキャッシュから返却:",e.url),a;const s=await this.cacheManager.fetchAndCacheProfileImage(e);return s?(this.console.log("プロフィール画像をネットワークから返却:",e.url),s):(this.console.log("フォールバック画像を返却:",e.url),i.createTransparentImageResponse())}catch(a){return this.console.error("プロフィール画像処理エラー:",a),i.createTransparentImageResponse(404)}}}class W{constructor(){this.cacheManager=new M,this.indexedDBManager=new m,this.clientManager=new D,this.messageHandler=new R(this.indexedDBManager),this.requestHandler=new E(this.cacheManager,this.clientManager,this.indexedDBManager)}async handleInstall(e){n.console.log("SW installing...",u),await this.cacheManager.precacheResources(d.precacheManifest),n.console.log("SW installed, waiting for user action")}async handleActivate(e){n.console.log("SW activating...",u),await this.cacheManager.cleanupOldCaches(),await n.clients.claim()}async handleFetch(e){const a=new URL(e.request.url);return i.isUploadRequest(e.request,a)?(n.console.log("SW: 内部アップロードリクエストを処理",a.href),await this.requestHandler.handleUploadRequest(e.request)):i.isProfileImageRequest(e.request)?await this.requestHandler.handleProfileImageRequest(e.request):await this.cacheManager.handleCacheFirst(e.request)}async handleMessage(e){const a={SKIP_WAITING:()=>{n.console.log("SW received SKIP_WAITING, updating..."),self.skipWaiting()},GET_VERSION:()=>{e.ports?.[0]?.postMessage({version:u})},PING_TEST:()=>{const c={type:"PONG",timestamp:Date.now(),version:u};try{e.ports?.[0]?(e.ports[0].postMessage(c),n.console.log("SW: PING_TEST responded via MessageChannel")):e.source?(e.source.postMessage(c),n.console.log("SW: PING_TEST responded via source")):n.console.warn("SW: PING_TEST no response channel available")}catch(l){n.console.error("SW: PING_TEST response error:",l)}}},s={getSharedMedia:()=>this.messageHandler.respondSharedMedia(e),getSharedMediaForce:()=>this.messageHandler.respondSharedMediaForce(e),clearProfileCache:async()=>{const c=await this.cacheManager.clearProfileCache();e.ports?.[0]?.postMessage(c)},cleanupDuplicateProfileCache:async()=>{const c=await this.cacheManager.cleanupDuplicateProfileCache();e.ports?.[0]?.postMessage(c)}},{type:t,action:o}=e.data||{};t&&a[t]?a[t]():o&&s[o]&&await s[o]()}}const w=new W;self.addEventListener("install",r=>{r.waitUntil(w.handleInstall(r))}),self.addEventListener("activate",r=>{r.waitUntil(w.handleActivate(r))}),self.addEventListener("fetch",r=>{if(new URL(r.request.url),new URL(r.request.url).origin===self.location.origin){const e=w.handleFetch(r);e!==void 0&&r.respondWith(e)}else i.isProfileImageRequest(r.request)&&(n.console.log("SW: 外部プロフィール画像リクエストを処理:",r.request.url),r.respondWith(w.requestHandler.handleProfileImageRequest(r.request)))}),self.addEventListener("message",r=>{w.handleMessage(r)}),typeof module<"u"&&module.exports&&(module.exports={ServiceWorkerCore:W,ServiceWorkerState:d,ServiceWorkerDependencies:n,Utilities:i,IndexedDBManager:m,CacheManager:M,ClientManager:D,MessageHandler:R,RequestHandler:E,PRECACHE_VERSION:u,PRECACHE_NAME:x,PROFILE_CACHE_NAME:g,INDEXEDDB_NAME:C,INDEXEDDB_VERSION:I})})();

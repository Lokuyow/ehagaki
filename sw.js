(function(){"use strict";let l=null;const g="ehagaki-cache-v0.1.13",u=[{"revision":null,"url":"assets/en-V4vKRyQ1.js"},{"revision":null,"url":"assets/index-11IrE2ji.css"},{"revision":null,"url":"assets/index-BuwRQFXu.js"},{"revision":null,"url":"assets/ja-tbId-BL3.js"},{"revision":"42ca659ded55f3adfbb7a9dd1a482540","url":"index.html"},{"revision":"8eb63de4f91d4fd83cd1bb6e20414ce3","url":"registerSW.js"},{"revision":"72cb1a250c643f80d5eb582a77786d9d","url":"hagaki_2mai.png"},{"revision":"b7c4e1df1ee4ac2162296f7fa9305656","url":"icons/circle-user-solid-full.svg"},{"revision":"97a01045245952c64a77bf467c91a979","url":"icons/gear-solid-full.svg"},{"revision":"37d5908dc78c990de67476170ee51443","url":"icons/github-mark.svg"},{"revision":"26330813975ae0a2c805089b709b4275","url":"icons/image-solid-full.svg"},{"revision":"0db89f4cdf2bcdabb6d369d82c013a97","url":"icons/language-solid.svg"},{"revision":"d95a177579018f67aac88c5b30e6de93","url":"manifest.webmanifest"}];if(u&&u.length>0){const e=g;self.addEventListener("install",r=>{r.waitUntil((async()=>{try{const n=await caches.open(e),s=u.map(a=>a.url);await n.addAll(s)}catch{}await self.skipWaiting()})())})}self.addEventListener("fetch",e=>{const r=new URL(e.request.url);e.request.method==="POST"&&(r.pathname.endsWith("/upload")||r.pathname.includes("/ehagaki/upload"))?e.respondWith((async()=>{try{const s=await e.request.formData(),a=[],i=s.getAll("images");if(i&&i.length>0)for(const t of i)t&&t.type&&t.type.startsWith("image/")&&a.push(t);const o=s.get("image");o&&o.type&&o.type.startsWith("image/")&&a.push(o);const f=s.getAll("images[]");if(f&&f.length>0)for(const t of f)t&&t.type&&t.type.startsWith("image/")&&a.push(t);const d=s.getAll("files[]");if(d&&d.length>0)for(const t of d)t&&t.type&&t.type.startsWith("image/")&&a.push(t);const h=[],p=new Set;for(const t of a){const c=`${t.name}-${t.size}-${t.type}`;p.has(c)||(p.add(c),h.push(t))}if(h.length===0)return Response.redirect(new URL("/ehagaki/",self.location.origin).href,303);const y=s.get("title")||"",R=s.get("text")||"";l={images:h,metadata:{count:h.length,timestamp:new Date().toISOString(),title:y,text:R}},h.length===1&&(l.image=h[0]);try{await m()}catch(t){console.error("共有フラグの保存に失敗しました:",t)}const w=await self.clients.matchAll({type:"window",includeUncontrolled:!0});if(w.length>0){const t=w[0];try{await t.focus();const c=(E=0)=>{try{t.postMessage({type:"SHARED_IMAGE",data:l,timestamp:Date.now(),retry:E})}catch(I){console.error("メッセージ送信エラー:",I)}};return c(),setTimeout(()=>c(1),1e3),setTimeout(()=>c(2),2e3),Response.redirect(new URL("/ehagaki/?shared=true",self.location.origin).href,303)}catch{return Response.redirect(new URL("/ehagaki/?shared=true&error=messaging",self.location.origin).href,303)}}else try{const t=new URL("/ehagaki/?shared=true",self.location.origin).href;return await self.clients.openWindow(t)?new Response("",{status:200,headers:{"Content-Type":"text/plain"}}):Response.redirect(new URL("/ehagaki/?shared=true&error=window",self.location.origin).href,303)}catch{return Response.redirect(new URL("/ehagaki/?shared=true&error=openWindow",self.location.origin).href,303)}}catch{return Response.redirect(new URL("/ehagaki/?shared=true&error=processing",self.location.origin).href,303)}})()):r.origin===self.location.origin?e.respondWith((async()=>{try{const s=await caches.open(g),a=await s.match(e.request);if(a)return a;const i=await fetch(e.request);if(i.ok&&e.request.method==="GET"){const o=i.clone();await s.put(e.request,o)}return i}catch{return new Response("Not Found",{status:404})}})()):e.respondWith(fetch(e.request))});async function m(){return new Promise((e,r)=>{try{const n=indexedDB.open("eHagakiSharedData",1);n.onupgradeneeded=s=>{const a=s.target.result;a.objectStoreNames.contains("flags")||a.createObjectStore("flags",{keyPath:"id"})},n.onerror=()=>r(new Error("IndexedDB open failed")),n.onsuccess=s=>{try{const o=s.target.result.transaction(["flags"],"readwrite").objectStore("flags"),f={id:"sharedImage",timestamp:Date.now(),value:!0},d=o.put(f);d.onsuccess=()=>e(),d.onerror=()=>r(new Error("Failed to store shared flag"))}catch(a){r(a)}}}catch(n){r(n)}})}self.addEventListener("install",e=>{e.waitUntil(self.skipWaiting())}),self.addEventListener("activate",e=>{e.waitUntil((async()=>{const r=[g],n=await caches.keys();await Promise.all(n.map(s=>{if(!r.includes(s))return caches.delete(s)})),await self.clients.claim()})())}),self.addEventListener("message",e=>{if(e.data&&e.data.type==="SKIP_WAITING"){self.skipWaiting();return}const r=e.source;if(e.data&&e.data.action==="getSharedImage"){const n=e.data.requestId||null,s={type:"SHARED_IMAGE",data:l,requestId:n,timestamp:Date.now()};e.ports&&e.ports[0]?e.ports[0].postMessage(s):r&&r.postMessage(s),l&&setTimeout(()=>{l=null},3e4)}})})();

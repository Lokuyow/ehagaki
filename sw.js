(function(){"use strict";const t=(...e)=>console.log("[ServiceWorker]",...e),i=(...e)=>console.error("[ServiceWorker]",...e);let l=null;const h=[{"revision":null,"url":"assets/en-CZbNxhCG.js"},{"revision":null,"url":"assets/index-C0MBH4vZ.css"},{"revision":null,"url":"assets/index-DtUZU0lo.js"},{"revision":null,"url":"assets/ja-D03mjtjc.js"},{"revision":"8295e753681053efeb441fdb6987ec23","url":"index.html"},{"revision":"8eb63de4f91d4fd83cd1bb6e20414ce3","url":"registerSW.js"},{"revision":"72cb1a250c643f80d5eb582a77786d9d","url":"hagaki_2mai.png"},{"revision":"b7c4e1df1ee4ac2162296f7fa9305656","url":"icons/circle-user-solid-full.svg"},{"revision":"97a01045245952c64a77bf467c91a979","url":"icons/gear-solid-full.svg"},{"revision":"26330813975ae0a2c805089b709b4275","url":"icons/image-solid-full.svg"},{"revision":"0db89f4cdf2bcdabb6d369d82c013a97","url":"icons/language-solid.svg"},{"revision":"7569a819cc451dcfb3503e060b316838","url":"manifest.webmanifest"}];if(h&&h.length>0){const e="precache-v1";self.addEventListener("install",r=>{t("インストールされました - プリキャッシュ開始"),r.waitUntil((async()=>{try{const o=await caches.open(e),a=h.map(s=>s.url);await o.addAll(a),t("プリキャッシュ完了:",a)}catch(o){i("プリキャッシュ失敗:",o)}await self.skipWaiting()})())})}self.addEventListener("fetch",e=>{const r=new URL(e.request.url);e.request.method==="POST"&&(r.pathname.endsWith("/upload")||r.pathname.includes("/ehagaki/upload"))?e.respondWith((async()=>{t("画像アップロードリクエストをWorkboxで処理します",e.request.url);try{t("フォームデータを処理中...");const s=(await e.request.formData()).get("image");if(!s)return i("画像データがありません"),Response.redirect(new URL("/ehagaki/",self.location.origin).href,303);t("画像を受信しました:",s.name,`タイプ: ${s.type}`,`サイズ: ${Math.round(s.size/1024)}KB`),l={image:s,metadata:{name:s.name,type:s.type,size:s.size,timestamp:new Date().toISOString()}};try{await f(),t("IndexedDBに共有フラグを保存しました")}catch(n){i("IndexedDB保存エラー:",n)}const d=await self.clients.matchAll({type:"window",includeUncontrolled:!0});if(d.length>0){const n=d[0];t("既存のクライアントにフォーカス:",n.id);try{await n.focus();const c=(u=0)=>{try{n.postMessage({type:"SHARED_IMAGE",data:l,timestamp:Date.now(),retry:u}),t(`画像データ${u>0?"再":""}送信 (${u}回目)`)}catch(p){i("メッセージ送信エラー:",p)}};return c(),setTimeout(()=>c(1),1e3),setTimeout(()=>c(2),2e3),Response.redirect(new URL("/ehagaki/?shared=true",self.location.origin).href,303)}catch(c){return i("メッセージ送信エラー:",c),Response.redirect(new URL("/ehagaki/?shared=true&error=messaging",self.location.origin).href,303)}}else{t("クライアントがないので新規ウィンドウを開きます");try{const n=new URL("/ehagaki/?shared=true",self.location.origin).href;return t("新規ウィンドウを開きます:",n),await self.clients.openWindow(n)?(t("新しいウィンドウを開きました"),new Response("",{status:200,headers:{"Content-Type":"text/plain"}})):(i("新しいウィンドウを開けませんでした"),Response.redirect(new URL("/ehagaki/?shared=true&error=window",self.location.origin).href,303))}catch(n){return i("ウィンドウオープンエラー:",n),Response.redirect(new URL("/ehagaki/?shared=true&error=openWindow",self.location.origin).href,303)}}}catch(a){return i("画像処理エラー:",a),Response.redirect(new URL("/ehagaki/?shared=true&error=processing",self.location.origin).href,303)}})()):r.origin===self.location.origin?e.respondWith((async()=>{try{const a=await caches.open("precache-v1"),s=await a.match(e.request);if(s)return t("キャッシュからレスポンス:",e.request.url),s;t("ネットワークからフェッチ:",e.request.url);const d=await fetch(e.request);if(d.ok&&e.request.method==="GET"){const n=d.clone();await a.put(e.request,n),t("ネットワーク応答をキャッシュに保存:",e.request.url)}return d}catch(a){return a("フェッチエラー:",e.request.url,a),new Response("Not Found",{status:404})}})()):e.respondWith(fetch(e.request))});async function f(){return new Promise((e,r)=>{try{const o=indexedDB.open("eHagakiSharedData",1);o.onupgradeneeded=a=>{const s=a.target.result;s.objectStoreNames.contains("flags")||s.createObjectStore("flags",{keyPath:"id"})},o.onerror=()=>r(new Error("IndexedDB open failed")),o.onsuccess=a=>{try{const n=a.target.result.transaction(["flags"],"readwrite").objectStore("flags"),c={id:"sharedImage",timestamp:Date.now(),value:!0},u=n.put(c);u.onsuccess=()=>e(),u.onerror=()=>r(new Error("Failed to store shared flag"))}catch(s){r(s)}}}catch(o){r(o)}})}self.addEventListener("install",e=>{t("インストールされました"),e.waitUntil(self.skipWaiting())}),self.addEventListener("activate",e=>{t("アクティブになりました - スコープ:",self.registration.scope),e.waitUntil(self.clients.claim())}),self.addEventListener("message",e=>{const r=e.source;if(t("メッセージ受信:",e.data?.action,"from client:",r?.id),e.data&&e.data.type==="SKIP_WAITING"){t("SKIP_WAITINGを受信、skipWaiting実行"),self.skipWaiting();return}if(e.data&&e.data.action==="getSharedImage"){t("クライアントに共有画像データのリクエストを受信");const o=e.data.requestId||null,a={type:"SHARED_IMAGE",data:l,requestId:o,timestamp:Date.now()};e.ports&&e.ports[0]?(e.ports[0].postMessage(a),t("MessageChannelでデータを送信")):r&&(r.postMessage(a),t("通常の応答でデータを送信")),l?(t("送信したデータ:",l.image?.name,l.metadata),setTimeout(()=>{l=null,t("共有画像キャッシュをクリアしました")},3e4)):t("共有画像キャッシュがありません")}})})();

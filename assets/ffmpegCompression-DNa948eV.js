import{F as f,f as u}from"./vendor-video-BBTp-AV6.js";import{d as g,u as m,c}from"./index-BNG84_vA.js";import{B as h}from"./baseCompression-DThwcD4_.js";import"./vendor-ui-Dfbvke9w.js";import"./vendor-nostr-CSSTtp-a.js";import"./vendor-zap-DuBBJg9r.js";import"./vendor-editor-DymEIdpa.js";import"./vendor-image-DhZoa7y2.js";class S extends h{ffmpeg=null;isLoaded=!1;loadPromise=null;isCompressing=!1;constructor(){super("FFmpegCompression")}abort(){if(this.log("Abort requested"),this.resetProgress(),this.ffmpeg&&this.isCompressing){this.log("Terminating FFmpeg");try{this.ffmpeg.terminate()}catch(e){g(this.context,"Error terminating FFmpeg:",e)}}}async loadFFmpeg(){if(!this.isLoaded)return this.loadPromise?this.loadPromise:(this.loadPromise=(async()=>{this.log("Loading FFmpeg from node_modules"),this.ffmpeg=new f,this.ffmpeg.on("log",({message:e})=>{console.log("[FFmpeg]",e)}),this.ffmpeg.on("progress",({progress:e})=>{this.updateProgress(e*100)});try{const e="/ehagaki/",a=new URL(e,window.location.origin).href,t=new URL("ffmpeg-core/ffmpeg-core.js",a).href,i=new URL("ffmpeg-core/ffmpeg-core.wasm",a).href;this.log("Base URL:",a),this.log("Core URL:",t),this.log("WASM URL:",i),await this.ffmpeg.load({coreURL:t,wasmURL:i}),this.isLoaded=!0,this.log("FFmpeg loaded successfully")}catch(e){throw g(this.context,"Failed to load FFmpeg:",e),e}})(),this.loadPromise)}async mergeVideoAndAudioWithFFmpeg(e,a){const t="mediabunny-video.mp4",i="mediabunny-audio-source.mp4",r="mediabunny-merged.mp4",o=async s=>{if(!s)return;const n=[t,i,r];for(const l of n)try{await s.deleteFile(l)}catch{}};try{if(m.value)return this.log("Abort detected before audio mux"),null;await this.loadFFmpeg();const s=this.ffmpeg;if(!s)return g(this.context,"FFmpeg instance unavailable for audio mux"),null;await s.writeFile(t,await u(e)),await s.writeFile(i,await u(a));const n=["-i",t,"-i",i,"-map","0:v:0","-map","1:a:0","-c:v","copy","-c:a","copy","-movflags","+faststart","-shortest","-y",r];if(this.log("Executing FFmpeg audio mux with args:",n),this.isCompressing=!0,await s.exec(n),m.value)return this.log("Abort detected during audio mux"),await o(s),null;const l=await s.readFile(r),p=new Blob([l],{type:"video/mp4"});return await o(s),p}catch(s){return m.value?this.log("Audio mux aborted, returning null"):g(this.context,"Failed to mux audio with FFmpeg copy:",s),await o(this.ffmpeg),null}finally{this.isCompressing=!1}}buildFFmpegArgs(e,a,t){const i=["-i",e,"-c:v","libx264","-crf",String(t.crf),"-preset",t.preset,"-c:a","aac","-b:a",t.audioBitrate||"128k"];if(t.audioSampleRate&&i.push("-ar",String(t.audioSampleRate)),t.audioChannels&&i.push("-ac",String(t.audioChannels)),t.maxSize){const r=`scale='if(gte(iw,ih),min(${t.maxSize},iw),-2)':'if(lt(iw,ih),min(${t.maxSize},ih),-2)'`;i.push("-vf",r)}return i.push("-movflags","+faststart","-y",a),i}async compressWithFFmpeg(e,a){try{this.log("Loading FFmpeg..."),await this.loadFFmpeg();const t=this.checkAbort(e);if(t)return t;if(!this.ffmpeg)throw new Error("FFmpeg not loaded");const i="input.mp4",r="output.mp4";await this.ffmpeg.writeFile(i,await u(e));const o=this.buildFFmpegArgs(i,r,a),s=this.checkAbort(e);if(s)return await this.ffmpeg.deleteFile(i),s;this.log("Starting compression with args:",o),this.isCompressing=!0;try{await this.ffmpeg.exec(o)}catch(p){if(m.value)this.log("Compression aborted during execution");else throw console.error("[FFmpegCompression] FFmpeg execution error:",p),p}finally{this.isCompressing=!1}if(m.value){this.log("Cleaning up after abort");try{await this.ffmpeg.deleteFile(i),await this.ffmpeg.deleteFile(r)}catch{}return{file:e,wasCompressed:!1,wasSkipped:!0,aborted:!0}}const n=await this.ffmpeg.readFile(r),l=new Blob([n],{type:"video/mp4"});return await this.ffmpeg.deleteFile(i),await this.ffmpeg.deleteFile(r),c(l,e,this.context)}catch(t){return this.isCompressing=!1,m.value?(this.log("Compression aborted, using original file"),{file:e,wasCompressed:!1,wasSkipped:!0,aborted:!0}):(console.error("[FFmpegCompression] Compression failed:",t),{file:e,wasCompressed:!1,wasSkipped:!0})}}async cleanup(){if(this.ffmpeg&&this.isLoaded)try{this.isLoaded=!1,this.ffmpeg=null,this.loadPromise=null}catch(e){console.error("[FFmpegCompression] Cleanup error:",e)}}}export{S as FFmpegCompression};

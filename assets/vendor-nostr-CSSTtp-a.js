var Xa=Object.defineProperty,Ja=(t,e,n)=>e in t?Xa(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,k=(t,e,n)=>(Ja(t,typeof e!="symbol"?e+"":e,n),n);class De extends Error{}let ki=class extends De{constructor(e){super(`RxNostrWebSocketError: WebSocket was closed with code ${e} by relay.`),this.code=e,this.name="RxNostrWebSocketError"}};class en extends De{constructor(e){super(`RxNostrInvalidUsageError: ${e}`),this.name="RxNostrInvalidUsageError"}}let jn=class extends De{constructor(e){super(`RxNostrEnvironmentError: ${e}`),this.name="RxNostrEnvironmentError"}},Ao=class extends De{constructor(){super("RxNostrLogicError: This is rx-nostr's internal bug. Please report to the author of the library."),this.name="RxNostrLogicError"}},Ut=class extends De{constructor(){super("RxNostrAlreadyDisposedError: Attempted to access a disposed resource."),this.name="RxNostrAlreadyDisposedError"}};const Me=(t,e)=>({...e,...t});function Qa(t){if(typeof t.id!="string"||typeof t.sig!="string"||typeof t.kind!="number"||typeof t.pubkey!="string"||typeof t.content!="string"||typeof t.created_at!="number"||!Array.isArray(t.tags))return!1;for(let e=0;e<t.tags.length;e++){const n=t.tags[e];if(!Array.isArray(n))return!1;for(let r=0;r<n.length;r++)if(typeof n[r]=="object")return!1}return!0}function zn(t){throw t}function tc(t){return{async signEvent(e){var n,r;const i={...e,pubkey:e.pubkey??await((n=window?.nostr)==null?void 0:n.getPublicKey())??zn(new jn("window.nostr.getPublicKey() is not found")),tags:[...e.tags??[]],created_at:e.created_at??Math.floor(Date.now()/1e3)};return Qa(i)?i:await((r=window?.nostr)==null?void 0:r.signEvent(i))??zn(new jn("window.nostr.signEvent() is not found"))},getPublicKey(){var e;return((e=window?.nostr)==null?void 0:e.getPublicKey())??zn(new jn("window.nostr.getPublicKey() is not found"))}}}const ec=t=>Me(t,{signer:tc(),connectionStrategy:"lazy",retry:{strategy:"exponential",maxCount:5,initialDelay:1e3},disconnectTimeout:1e4,eoseTimeout:30*1e3,okTimeout:30*1e3,authTimeout:30*1e3,skipVerify:!1,skipValidateFilterMatching:!1,skipExpirationCheck:!1,skipFetchNip11:!1});function nc(t){return"length"in t?t.map(Ri):[Ri(t)]}function Ri(t){return{...t,since:t.since?Ti(t.since):void 0,until:t.until?Ti(t.until):void 0}}function Ti(t){return typeof t=="number"?t:t()}async function rc(t){try{const e=new URL(t);return e.protocol=e.protocol.replace(/^ws(s?):/,"http$1:"),await(await fetch(e.toString(),{headers:{Accept:"application/nostr+json"}})).json()}catch{return{}}}function Li(t,e){try{return t()}catch(n){return e instanceof Function?e(n):e}}function Ct(t){let e="";try{e=t.trim();const n=new URL(e);n.hash="",n.pathname=Li(()=>decodeURI(n.pathname),n.pathname),n.pathname=n.pathname.replace(/\/$/,""),n.hostname=n.hostname.replace(/\.$/,""),n.searchParams.sort(),n.search=Li(()=>decodeURIComponent(n.search),n.search);let r=n.toString();return n.search||(r=r.replace(/\/$/,"")),r}catch{return e}}class Ee extends Map{constructor(e){if(super(),!!e)for(const[n,r]of Object.entries(e))this.set(Ct(n),r)}get(e){return super.get(Ct(e))}getMany(e){const n=[];for(const r of new Set(e.map(Ct))){const i=this.get(r);i!==void 0&&n.push(i)}return n}set(e,n){return super.set(Ct(e),n)}has(e){return super.has(Ct(e))}delete(e){return super.delete(Ct(e))}toObject(){const e={};for(const[n,r]of this.entries())e[n]=r;return e}toKeys(){return[...super.keys()]}toValues(){return[...super.values()]}copy(){return new Ee(this.toObject())}}class sn{static async getValue(e,n,r){if(!(r!=null&&r.skipCache)){const i=await this.cache.get(e);if(i)return n(i)}if(!(r!=null&&r.skipFetch)){const i=await this.fetch(e);if(i)return n(i)}return n(this.default)}static get(e){const n=this.cache.get(e);if(n&&!(n instanceof Promise))return n}static async fetch(e){const n=rc(e);return this.cache.set(e,n),n.then(r=>{this.cache.set(e,r)}),n}static async getOrFetch(e){return this.cache.get(e)??this.fetch(e)}static set(e,n){this.cache.set(e,n)}static getDefault(){return this.default}static setDefault(e){this.default=e}static forget(e){this.cache.delete(e)}static forgetAll(){this.cache.clear()}}k(sn,"cache",new Ee),k(sn,"default",{});new Uint8Array(new Uint32Array([287454020]).buffer)[0];function ic(t,e,n){return Array.isArray(e)?e.some(r=>Ni(t,r)):Ni(t,e)}function Ni(t,e,n){const{sinceInclusive:r,untilInclusive:i}=Me({},{sinceInclusive:!0,untilInclusive:!0});if(e.ids&&e.ids.every(o=>!t.id.startsWith(o))||e.kinds&&!e.kinds.includes(t.kind)||e.authors&&e.authors.every(o=>!t.pubkey.startsWith(o))||e.since&&(r&&!(e.since<=t.created_at)||!r&&!(e.since<t.created_at))||e.until&&(i&&!(t.created_at<=e.until)||!i&&!(t.created_at<e.until)))return!1;for(const[o,s]of Object.entries(e)){if(!o.startsWith("#")||!Array.isArray(s))continue;const c=o.slice(1);if(!t.tags.find(([a,u])=>c===a&&s.includes(u)))return!1}return!0}function oc(t,e){const n=t.tags.find(r=>r[0]==="expiration");if(!n)return!1;try{const r=Number(n[1]);return Number.isInteger(r)?r<=(e??Math.floor(Date.now()/1e3)):!1}catch{return!1}}var fr=function(t,e){return fr=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,r){n.__proto__=r}||function(n,r){for(var i in r)Object.prototype.hasOwnProperty.call(r,i)&&(n[i]=r[i])},fr(t,e)};function zt(t,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");fr(t,e);function n(){this.constructor=t}t.prototype=e===null?Object.create(e):(n.prototype=e.prototype,new n)}function sc(t,e,n,r){function i(o){return o instanceof n?o:new n(function(s){s(o)})}return new(n||(n=Promise))(function(o,s){function c(l){try{u(r.next(l))}catch(f){s(f)}}function a(l){try{u(r.throw(l))}catch(f){s(f)}}function u(l){l.done?o(l.value):i(l.value).then(c,a)}u((r=r.apply(t,[])).next())})}function $o(t,e){var n={label:0,sent:function(){if(o[0]&1)throw o[1];return o[1]},trys:[],ops:[]},r,i,o,s;return s={next:c(0),throw:c(1),return:c(2)},typeof Symbol=="function"&&(s[Symbol.iterator]=function(){return this}),s;function c(u){return function(l){return a([u,l])}}function a(u){if(r)throw new TypeError("Generator is already executing.");for(;s&&(s=0,u[0]&&(n=0)),n;)try{if(r=1,i&&(o=u[0]&2?i.return:u[0]?i.throw||((o=i.return)&&o.call(i),0):i.next)&&!(o=o.call(i,u[1])).done)return o;switch(i=0,o&&(u=[u[0]&2,o.value]),u[0]){case 0:case 1:o=u;break;case 4:return n.label++,{value:u[1],done:!1};case 5:n.label++,i=u[1],u=[0];continue;case 7:u=n.ops.pop(),n.trys.pop();continue;default:if(o=n.trys,!(o=o.length>0&&o[o.length-1])&&(u[0]===6||u[0]===2)){n=0;continue}if(u[0]===3&&(!o||u[1]>o[0]&&u[1]<o[3])){n.label=u[1];break}if(u[0]===6&&n.label<o[1]){n.label=o[1],o=u;break}if(o&&n.label<o[2]){n.label=o[2],n.ops.push(u);break}o[2]&&n.ops.pop(),n.trys.pop();continue}u=e.call(t,n)}catch(l){u=[6,l],i=0}finally{r=o=0}if(u[0]&5)throw u[1];return{value:u[0]?u[1]:void 0,done:!0}}}function Ae(t){var e=typeof Symbol=="function"&&Symbol.iterator,n=e&&t[e],r=0;if(n)return n.call(t);if(t&&typeof t.length=="number")return{next:function(){return t&&r>=t.length&&(t=void 0),{value:t&&t[r++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function $e(t,e){var n=typeof Symbol=="function"&&t[Symbol.iterator];if(!n)return t;var r=n.call(t),i,o=[],s;try{for(;(e===void 0||e-- >0)&&!(i=r.next()).done;)o.push(i.value)}catch(c){s={error:c}}finally{try{i&&!i.done&&(n=r.return)&&n.call(r)}finally{if(s)throw s.error}}return o}function Be(t,e,n){if(arguments.length===2)for(var r=0,i=e.length,o;r<i;r++)(o||!(r in e))&&(o||(o=Array.prototype.slice.call(e,0,r)),o[r]=e[r]);return t.concat(o||Array.prototype.slice.call(e))}function xe(t){return this instanceof xe?(this.v=t,this):new xe(t)}function ac(t,e,n){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var r=n.apply(t,e||[]),i,o=[];return i={},s("next"),s("throw"),s("return"),i[Symbol.asyncIterator]=function(){return this},i;function s(p){r[p]&&(i[p]=function(b){return new Promise(function(g,h){o.push([p,b,g,h])>1||c(p,b)})})}function c(p,b){try{a(r[p](b))}catch(g){f(o[0][3],g)}}function a(p){p.value instanceof xe?Promise.resolve(p.value.v).then(u,l):f(o[0][2],p)}function u(p){c("next",p)}function l(p){c("throw",p)}function f(p,b){p(b),o.shift(),o.length&&c(o[0][0],o[0][1])}}function cc(t){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var e=t[Symbol.asyncIterator],n;return e?e.call(t):(t=typeof Ae=="function"?Ae(t):t[Symbol.iterator](),n={},r("next"),r("throw"),r("return"),n[Symbol.asyncIterator]=function(){return this},n);function r(o){n[o]=t[o]&&function(s){return new Promise(function(c,a){s=t[o](s),i(c,a,s.done,s.value)})}}function i(o,s,c,a){Promise.resolve(a).then(function(u){o({value:u,done:c})},s)}}function Z(t){return typeof t=="function"}function Sn(t){var e=function(r){Error.call(r),r.stack=new Error().stack},n=t(e);return n.prototype=Object.create(Error.prototype),n.prototype.constructor=n,n}var Dn=Sn(function(t){return function(e){t(this),this.message=e?e.length+` errors occurred during unsubscription:
`+e.map(function(n,r){return r+1+") "+n.toString()}).join(`
  `):"",this.name="UnsubscriptionError",this.errors=e}});function an(t,e){if(t){var n=t.indexOf(e);0<=n&&t.splice(n,1)}}var Ve=(function(){function t(e){this.initialTeardown=e,this.closed=!1,this._parentage=null,this._finalizers=null}return t.prototype.unsubscribe=function(){var e,n,r,i,o;if(!this.closed){this.closed=!0;var s=this._parentage;if(s)if(this._parentage=null,Array.isArray(s))try{for(var c=Ae(s),a=c.next();!a.done;a=c.next()){var u=a.value;u.remove(this)}}catch(h){e={error:h}}finally{try{a&&!a.done&&(n=c.return)&&n.call(c)}finally{if(e)throw e.error}}else s.remove(this);var l=this.initialTeardown;if(Z(l))try{l()}catch(h){o=h instanceof Dn?h.errors:[h]}var f=this._finalizers;if(f){this._finalizers=null;try{for(var p=Ae(f),b=p.next();!b.done;b=p.next()){var g=b.value;try{Ui(g)}catch(h){o=o??[],h instanceof Dn?o=Be(Be([],$e(o)),$e(h.errors)):o.push(h)}}}catch(h){r={error:h}}finally{try{b&&!b.done&&(i=p.return)&&i.call(p)}finally{if(r)throw r.error}}}if(o)throw new Dn(o)}},t.prototype.add=function(e){var n;if(e&&e!==this)if(this.closed)Ui(e);else{if(e instanceof t){if(e.closed||e._hasParent(this))return;e._addParent(this)}(this._finalizers=(n=this._finalizers)!==null&&n!==void 0?n:[]).push(e)}},t.prototype._hasParent=function(e){var n=this._parentage;return n===e||Array.isArray(n)&&n.includes(e)},t.prototype._addParent=function(e){var n=this._parentage;this._parentage=Array.isArray(n)?(n.push(e),n):n?[n,e]:e},t.prototype._removeParent=function(e){var n=this._parentage;n===e?this._parentage=null:Array.isArray(n)&&an(n,e)},t.prototype.remove=function(e){var n=this._finalizers;n&&an(n,e),e instanceof t&&e._removeParent(this)},t.EMPTY=(function(){var e=new t;return e.closed=!0,e})(),t})(),Bo=Ve.EMPTY;function Oo(t){return t instanceof Ve||t&&"closed"in t&&Z(t.remove)&&Z(t.add)&&Z(t.unsubscribe)}function Ui(t){Z(t)?t():t.unsubscribe()}var uc={Promise:void 0},lc={setTimeout:function(t,e){for(var n=[],r=2;r<arguments.length;r++)n[r-2]=arguments[r];return setTimeout.apply(void 0,Be([t,e],$e(n)))},clearTimeout:function(t){return clearTimeout(t)},delegate:void 0};function _o(t){lc.setTimeout(function(){throw t})}function hr(){}function nn(t){t()}var Nr=(function(t){zt(e,t);function e(n){var r=t.call(this)||this;return r.isStopped=!1,n?(r.destination=n,Oo(n)&&n.add(r)):r.destination=dc,r}return e.create=function(n,r,i){return new cn(n,r,i)},e.prototype.next=function(n){this.isStopped||this._next(n)},e.prototype.error=function(n){this.isStopped||(this.isStopped=!0,this._error(n))},e.prototype.complete=function(){this.isStopped||(this.isStopped=!0,this._complete())},e.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,t.prototype.unsubscribe.call(this),this.destination=null)},e.prototype._next=function(n){this.destination.next(n)},e.prototype._error=function(n){try{this.destination.error(n)}finally{this.unsubscribe()}},e.prototype._complete=function(){try{this.destination.complete()}finally{this.unsubscribe()}},e})(Ve),fc=(function(){function t(e){this.partialObserver=e}return t.prototype.next=function(e){var n=this.partialObserver;if(n.next)try{n.next(e)}catch(r){Xe(r)}},t.prototype.error=function(e){var n=this.partialObserver;if(n.error)try{n.error(e)}catch(r){Xe(r)}else Xe(e)},t.prototype.complete=function(){var e=this.partialObserver;if(e.complete)try{e.complete()}catch(n){Xe(n)}},t})(),cn=(function(t){zt(e,t);function e(n,r,i){var o=t.call(this)||this,s;return Z(n)||!n?s={next:n??void 0,error:r??void 0,complete:i??void 0}:s=n,o.destination=new fc(s),o}return e})(Nr);function Xe(t){_o(t)}function hc(t){throw t}var dc={closed:!0,next:hr,error:hc,complete:hr},Ur=(function(){return typeof Symbol=="function"&&Symbol.observable||"@@observable"})();function Dt(t){return t}function pc(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return Io(t)}function Io(t){return t.length===0?Dt:t.length===1?t[0]:function(e){return t.reduce(function(n,r){return r(n)},e)}}var lt=(function(){function t(e){e&&(this._subscribe=e)}return t.prototype.lift=function(e){var n=new t;return n.source=this,n.operator=e,n},t.prototype.subscribe=function(e,n,r){var i=this,o=yc(e)?e:new cn(e,n,r);return nn(function(){var s=i,c=s.operator,a=s.source;o.add(c?c.call(o,a):a?i._subscribe(o):i._trySubscribe(o))}),o},t.prototype._trySubscribe=function(e){try{return this._subscribe(e)}catch(n){e.error(n)}},t.prototype.forEach=function(e,n){var r=this;return n=Ci(n),new n(function(i,o){var s=new cn({next:function(c){try{e(c)}catch(a){o(a),s.unsubscribe()}},error:o,complete:i});r.subscribe(s)})},t.prototype._subscribe=function(e){var n;return(n=this.source)===null||n===void 0?void 0:n.subscribe(e)},t.prototype[Ur]=function(){return this},t.prototype.pipe=function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];return Io(e)(this)},t.prototype.toPromise=function(e){var n=this;return e=Ci(e),new e(function(r,i){var o;n.subscribe(function(s){return o=s},function(s){return i(s)},function(){return r(o)})})},t.create=function(e){return new t(e)},t})();function Ci(t){var e;return(e=t??uc.Promise)!==null&&e!==void 0?e:Promise}function gc(t){return t&&Z(t.next)&&Z(t.error)&&Z(t.complete)}function yc(t){return t&&t instanceof Nr||gc(t)&&Oo(t)}function bc(t){return Z(t?.lift)}function ot(t){return function(e){if(bc(e))return e.lift(function(n){try{return t(n,this)}catch(r){this.error(r)}});throw new TypeError("Unable to lift unknown Observable type")}}function tt(t,e,n,r,i){return new wc(t,e,n,r,i)}var wc=(function(t){zt(e,t);function e(n,r,i,o,s,c){var a=t.call(this,n)||this;return a.onFinalize=s,a.shouldUnsubscribe=c,a._next=r?function(u){try{r(u)}catch(l){n.error(l)}}:t.prototype._next,a._error=o?function(u){try{o(u)}catch(l){n.error(l)}finally{this.unsubscribe()}}:t.prototype._error,a._complete=i?function(){try{i()}catch(u){n.error(u)}finally{this.unsubscribe()}}:t.prototype._complete,a}return e.prototype.unsubscribe=function(){var n;if(!this.shouldUnsubscribe||this.shouldUnsubscribe()){var r=this.closed;t.prototype.unsubscribe.call(this),!r&&((n=this.onFinalize)===null||n===void 0||n.call(this))}},e})(Nr),mc=Sn(function(t){return function(){t(this),this.name="ObjectUnsubscribedError",this.message="object unsubscribed"}}),M=(function(t){zt(e,t);function e(){var n=t.call(this)||this;return n.closed=!1,n.currentObservers=null,n.observers=[],n.isStopped=!1,n.hasError=!1,n.thrownError=null,n}return e.prototype.lift=function(n){var r=new Pi(this,this);return r.operator=n,r},e.prototype._throwIfClosed=function(){if(this.closed)throw new mc},e.prototype.next=function(n){var r=this;nn(function(){var i,o;if(r._throwIfClosed(),!r.isStopped){r.currentObservers||(r.currentObservers=Array.from(r.observers));try{for(var s=Ae(r.currentObservers),c=s.next();!c.done;c=s.next()){var a=c.value;a.next(n)}}catch(u){i={error:u}}finally{try{c&&!c.done&&(o=s.return)&&o.call(s)}finally{if(i)throw i.error}}}})},e.prototype.error=function(n){var r=this;nn(function(){if(r._throwIfClosed(),!r.isStopped){r.hasError=r.isStopped=!0,r.thrownError=n;for(var i=r.observers;i.length;)i.shift().error(n)}})},e.prototype.complete=function(){var n=this;nn(function(){if(n._throwIfClosed(),!n.isStopped){n.isStopped=!0;for(var r=n.observers;r.length;)r.shift().complete()}})},e.prototype.unsubscribe=function(){this.isStopped=this.closed=!0,this.observers=this.currentObservers=null},Object.defineProperty(e.prototype,"observed",{get:function(){var n;return((n=this.observers)===null||n===void 0?void 0:n.length)>0},enumerable:!1,configurable:!0}),e.prototype._trySubscribe=function(n){return this._throwIfClosed(),t.prototype._trySubscribe.call(this,n)},e.prototype._subscribe=function(n){return this._throwIfClosed(),this._checkFinalizedStatuses(n),this._innerSubscribe(n)},e.prototype._innerSubscribe=function(n){var r=this,i=this,o=i.hasError,s=i.isStopped,c=i.observers;return o||s?Bo:(this.currentObservers=null,c.push(n),new Ve(function(){r.currentObservers=null,an(c,n)}))},e.prototype._checkFinalizedStatuses=function(n){var r=this,i=r.hasError,o=r.thrownError,s=r.isStopped;i?n.error(o):s&&n.complete()},e.prototype.asObservable=function(){var n=new lt;return n.source=this,n},e.create=function(n,r){return new Pi(n,r)},e})(lt),Pi=(function(t){zt(e,t);function e(n,r){var i=t.call(this)||this;return i.destination=n,i.source=r,i}return e.prototype.next=function(n){var r,i;(i=(r=this.destination)===null||r===void 0?void 0:r.next)===null||i===void 0||i.call(r,n)},e.prototype.error=function(n){var r,i;(i=(r=this.destination)===null||r===void 0?void 0:r.error)===null||i===void 0||i.call(r,n)},e.prototype.complete=function(){var n,r;(r=(n=this.destination)===null||n===void 0?void 0:n.complete)===null||r===void 0||r.call(n)},e.prototype._subscribe=function(n){var r,i;return(i=(r=this.source)===null||r===void 0?void 0:r.subscribe(n))!==null&&i!==void 0?i:Bo},e})(M),vc=(function(t){zt(e,t);function e(n){var r=t.call(this)||this;return r._value=n,r}return Object.defineProperty(e.prototype,"value",{get:function(){return this.getValue()},enumerable:!1,configurable:!0}),e.prototype._subscribe=function(n){var r=t.prototype._subscribe.call(this,n);return!r.closed&&n.next(this._value),r},e.prototype.getValue=function(){var n=this,r=n.hasError,i=n.thrownError,o=n._value;if(r)throw i;return this._throwIfClosed(),o},e.prototype.next=function(n){t.prototype.next.call(this,this._value=n)},e})(M),Ec={now:function(){return Date.now()}},xc=(function(t){zt(e,t);function e(n,r){return t.call(this)||this}return e.prototype.schedule=function(n,r){return this},e})(Ve),dr={setInterval:function(t,e){for(var n=[],r=2;r<arguments.length;r++)n[r-2]=arguments[r];var i=dr.delegate;return i!=null&&i.setInterval?i.setInterval.apply(i,Be([t,e],$e(n))):setInterval.apply(void 0,Be([t,e],$e(n)))},clearInterval:function(t){return clearInterval(t)},delegate:void 0},Sc=(function(t){zt(e,t);function e(n,r){var i=t.call(this,n,r)||this;return i.scheduler=n,i.work=r,i.pending=!1,i}return e.prototype.schedule=function(n,r){var i;if(r===void 0&&(r=0),this.closed)return this;this.state=n;var o=this.id,s=this.scheduler;return o!=null&&(this.id=this.recycleAsyncId(s,o,r)),this.pending=!0,this.delay=r,this.id=(i=this.id)!==null&&i!==void 0?i:this.requestAsyncId(s,this.id,r),this},e.prototype.requestAsyncId=function(n,r,i){return i===void 0&&(i=0),dr.setInterval(n.flush.bind(n,this),i)},e.prototype.recycleAsyncId=function(n,r,i){if(i===void 0&&(i=0),i!=null&&this.delay===i&&this.pending===!1)return r;r!=null&&dr.clearInterval(r)},e.prototype.execute=function(n,r){if(this.closed)return new Error("executing a cancelled action");this.pending=!1;var i=this._execute(n,r);if(i)return i;this.pending===!1&&this.id!=null&&(this.id=this.recycleAsyncId(this.scheduler,this.id,null))},e.prototype._execute=function(n,r){var i=!1,o;try{this.work(n)}catch(s){i=!0,o=s||new Error("Scheduled action threw falsy error")}if(i)return this.unsubscribe(),o},e.prototype.unsubscribe=function(){if(!this.closed){var n=this,r=n.id,i=n.scheduler,o=i.actions;this.work=this.state=this.scheduler=null,this.pending=!1,an(o,this),r!=null&&(this.id=this.recycleAsyncId(i,r,null)),this.delay=null,t.prototype.unsubscribe.call(this)}},e})(xc),qi=(function(){function t(e,n){n===void 0&&(n=t.now),this.schedulerActionCtor=e,this.now=n}return t.prototype.schedule=function(e,n,r){return n===void 0&&(n=0),new this.schedulerActionCtor(this,e).schedule(r,n)},t.now=Ec.now,t})(),Ac=(function(t){zt(e,t);function e(n,r){r===void 0&&(r=qi.now);var i=t.call(this,n,r)||this;return i.actions=[],i._active=!1,i}return e.prototype.flush=function(n){var r=this.actions;if(this._active){r.push(n);return}var i;this._active=!0;do if(i=n.execute(n.state,n.delay))break;while(n=r.shift());if(this._active=!1,i){for(;n=r.shift();)n.unsubscribe();throw i}},e})(qi),ko=new Ac(Sc),$c=ko,Fe=new lt(function(t){return t.complete()});function Bc(t){return t&&Z(t.schedule)}function Cr(t){return t[t.length-1]}function Oc(t){return Z(Cr(t))?t.pop():void 0}function Pr(t){return Bc(Cr(t))?t.pop():void 0}function _c(t,e){return typeof Cr(t)=="number"?t.pop():e}var Ro=function(t){return t&&typeof t.length=="number"&&typeof t!="function"};function To(t){return Z(t?.then)}function Lo(t){return Z(t[Ur])}function No(t){return Symbol.asyncIterator&&Z(t?.[Symbol.asyncIterator])}function Uo(t){return new TypeError("You provided "+(t!==null&&typeof t=="object"?"an invalid object":"'"+t+"'")+" where a stream was expected. You can provide an Observable, Promise, ReadableStream, Array, AsyncIterable, or Iterable.")}function Ic(){return typeof Symbol!="function"||!Symbol.iterator?"@@iterator":Symbol.iterator}var Co=Ic();function Po(t){return Z(t?.[Co])}function qo(t){return ac(this,arguments,function(){var e,n,r,i;return $o(this,function(o){switch(o.label){case 0:e=t.getReader(),o.label=1;case 1:o.trys.push([1,,9,10]),o.label=2;case 2:return[4,xe(e.read())];case 3:return n=o.sent(),r=n.value,i=n.done,i?[4,xe(void 0)]:[3,5];case 4:return[2,o.sent()];case 5:return[4,xe(r)];case 6:return[4,o.sent()];case 7:return o.sent(),[3,2];case 8:return[3,10];case 9:return e.releaseLock(),[7];case 10:return[2]}})})}function Ho(t){return Z(t?.getReader)}function It(t){if(t instanceof lt)return t;if(t!=null){if(Lo(t))return kc(t);if(Ro(t))return Rc(t);if(To(t))return Tc(t);if(No(t))return jo(t);if(Po(t))return Lc(t);if(Ho(t))return Nc(t)}throw Uo(t)}function kc(t){return new lt(function(e){var n=t[Ur]();if(Z(n.subscribe))return n.subscribe(e);throw new TypeError("Provided object does not correctly implement Symbol.observable")})}function Rc(t){return new lt(function(e){for(var n=0;n<t.length&&!e.closed;n++)e.next(t[n]);e.complete()})}function Tc(t){return new lt(function(e){t.then(function(n){e.closed||(e.next(n),e.complete())},function(n){return e.error(n)}).then(null,_o)})}function Lc(t){return new lt(function(e){var n,r;try{for(var i=Ae(t),o=i.next();!o.done;o=i.next()){var s=o.value;if(e.next(s),e.closed)return}}catch(c){n={error:c}}finally{try{o&&!o.done&&(r=i.return)&&r.call(i)}finally{if(n)throw n.error}}e.complete()})}function jo(t){return new lt(function(e){Uc(t,e).catch(function(n){return e.error(n)})})}function Nc(t){return jo(qo(t))}function Uc(t,e){var n,r,i,o;return sc(this,void 0,void 0,function(){var s,c;return $o(this,function(a){switch(a.label){case 0:a.trys.push([0,5,6,11]),n=cc(t),a.label=1;case 1:return[4,n.next()];case 2:if(r=a.sent(),!!r.done)return[3,4];if(s=r.value,e.next(s),e.closed)return[2];a.label=3;case 3:return[3,1];case 4:return[3,11];case 5:return c=a.sent(),i={error:c},[3,11];case 6:return a.trys.push([6,,9,10]),r&&!r.done&&(o=n.return)?[4,o.call(n)]:[3,8];case 7:a.sent(),a.label=8;case 8:return[3,10];case 9:if(i)throw i.error;return[7];case 10:return[7];case 11:return e.complete(),[2]}})})}function Ot(t,e,n,r,i){r===void 0&&(r=0),i===void 0&&(i=!1);var o=e.schedule(function(){n(),i?t.add(this.schedule(null,r)):this.unsubscribe()},r);if(t.add(o),!i)return o}function zo(t,e){return e===void 0&&(e=0),ot(function(n,r){n.subscribe(tt(r,function(i){return Ot(r,t,function(){return r.next(i)},e)},function(){return Ot(r,t,function(){return r.complete()},e)},function(i){return Ot(r,t,function(){return r.error(i)},e)}))})}function Do(t,e){return e===void 0&&(e=0),ot(function(n,r){r.add(t.schedule(function(){return n.subscribe(r)},e))})}function Cc(t,e){return It(t).pipe(Do(e),zo(e))}function Pc(t,e){return It(t).pipe(Do(e),zo(e))}function qc(t,e){return new lt(function(n){var r=0;return e.schedule(function(){r===t.length?n.complete():(n.next(t[r++]),n.closed||this.schedule())})})}function Hc(t,e){return new lt(function(n){var r;return Ot(n,e,function(){r=t[Co](),Ot(n,e,function(){var i,o,s;try{i=r.next(),o=i.value,s=i.done}catch(c){n.error(c);return}s?n.complete():n.next(o)},0,!0)}),function(){return Z(r?.return)&&r.return()}})}function Mo(t,e){if(!t)throw new Error("Iterable cannot be null");return new lt(function(n){Ot(n,e,function(){var r=t[Symbol.asyncIterator]();Ot(n,e,function(){r.next().then(function(i){i.done?n.complete():n.next(i.value)})},0,!0)})})}function jc(t,e){return Mo(qo(t),e)}function zc(t,e){if(t!=null){if(Lo(t))return Cc(t,e);if(Ro(t))return qc(t,e);if(To(t))return Pc(t,e);if(No(t))return Mo(t,e);if(Po(t))return Hc(t,e);if(Ho(t))return jc(t,e)}throw Uo(t)}function Ke(t,e){return e?zc(t,e):It(t)}function Vo(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var n=Pr(t);return Ke(t,n)}var qr=Sn(function(t){return function(){t(this),this.name="EmptyError",this.message="no elements in sequence"}});function Fo(t,e){return new Promise(function(n,r){var i=new cn({next:function(o){n(o),i.unsubscribe()},error:r,complete:function(){r(new qr)}});t.subscribe(i)})}function Ko(t){return t instanceof Date&&!isNaN(t)}var Wo=Sn(function(t){return function(e){e===void 0&&(e=null),t(this),this.message="Timeout has occurred",this.name="TimeoutError",this.info=e}});function Zo(t,e){var n=Ko(t)?{first:t}:typeof t=="number"?{each:t}:t,r=n.first,i=n.each,o=n.with,s=o===void 0?Dc:o,c=n.scheduler,a=c===void 0?ko:c,u=n.meta,l=u===void 0?null:u;if(r==null&&i==null)throw new TypeError("No timeout provided.");return ot(function(f,p){var b,g,h=null,d=0,y=function(v){g=Ot(p,a,function(){try{b.unsubscribe(),It(s({meta:l,lastValue:h,seen:d})).subscribe(p)}catch(S){p.error(S)}},v)};b=f.subscribe(tt(p,function(v){g?.unsubscribe(),d++,p.next(h=v),i>0&&y(i)},void 0,void 0,function(){g!=null&&g.closed||g==null||g.unsubscribe(),h=null})),!d&&y(r!=null?typeof r=="number"?r:+r-a.now():i)})}function Dc(t){throw new Wo(t)}function ee(t,e){return ot(function(n,r){var i=0;n.subscribe(tt(r,function(o){r.next(t.call(e,o,i++))}))})}var Mc=Array.isArray;function Vc(t,e){return Mc(e)?t.apply(void 0,Be([],$e(e))):t(e)}function Fc(t){return ee(function(e){return Vc(t,e)})}var Kc=Array.isArray,Wc=Object.getPrototypeOf,Zc=Object.prototype,Gc=Object.keys;function Yc(t){if(t.length===1){var e=t[0];if(Kc(e))return{args:e,keys:null};if(Xc(e)){var n=Gc(e);return{args:n.map(function(r){return e[r]}),keys:n}}}return{args:t,keys:null}}function Xc(t){return t&&typeof t=="object"&&Wc(t)===Zc}function Jc(t,e){return t.reduce(function(n,r,i){return n[r]=e[i],n},{})}function Qc(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var n=Pr(t),r=Oc(t),i=Yc(t),o=i.args,s=i.keys;if(o.length===0)return Ke([],n);var c=new lt(tu(o,n,s?function(a){return Jc(s,a)}:Dt));return r?c.pipe(Fc(r)):c}function tu(t,e,n){return n===void 0&&(n=Dt),function(r){Hi(e,function(){for(var i=t.length,o=new Array(i),s=i,c=i,a=function(l){Hi(e,function(){var f=Ke(t[l],e),p=!1;f.subscribe(tt(r,function(b){o[l]=b,p||(p=!0,c--),c||r.next(n(o.slice()))},function(){--s||r.complete()}))},r)},u=0;u<i;u++)a(u)},r)}}function Hi(t,e,n){t?Ot(n,t,e):e()}function eu(t,e,n,r,i,o,s,c){var a=[],u=0,l=0,f=!1,p=function(){f&&!a.length&&!u&&e.complete()},b=function(h){return u<r?g(h):a.push(h)},g=function(h){u++;var d=!1;It(n(h,l++)).subscribe(tt(e,function(y){e.next(y)},function(){d=!0},void 0,function(){if(d)try{u--;for(var y=function(){var v=a.shift();s?Ot(e,s,function(){return g(v)}):g(v)};a.length&&u<r;)y();p()}catch(v){e.error(v)}}))};return t.subscribe(tt(e,b,function(){f=!0,p()})),function(){}}function un(t,e,n){return n===void 0&&(n=1/0),Z(e)?un(function(r,i){return ee(function(o,s){return e(r,o,i,s)})(It(t(r,i)))},n):(typeof e=="number"&&(n=e),ot(function(r,i){return eu(r,i,t,n)}))}function Go(t){return t===void 0&&(t=1/0),un(Dt,t)}function ji(t,e,n){return t===void 0&&(t=0),n===void 0&&(n=$c),new lt(function(r){var i=Ko(t)?+t-n.now():t;i<0&&(i=0);var o=0;return n.schedule(function(){r.closed||(r.next(o++),r.complete())},i)})}function nu(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var n=Pr(t),r=_c(t,1/0),i=t;return i.length?i.length===1?It(i[0]):Go(r)(Ke(i,n)):Fe}function bt(t,e){return ot(function(n,r){var i=0;n.subscribe(tt(r,function(o){return t.call(e,o,i++)&&r.next(o)}))})}function Yo(t){return ot(function(e,n){var r=null,i=!1,o;r=e.subscribe(tt(n,void 0,void 0,function(s){o=It(t(s,Yo(t)(e))),r?(r.unsubscribe(),r=null,o.subscribe(n)):i=!0})),i&&(r.unsubscribe(),r=null,o.subscribe(n))})}function ru(t){return ot(function(e,n){var r=!1;e.subscribe(tt(n,function(i){r=!0,n.next(i)},function(){r||n.next(t),n.complete()}))})}function iu(t){return t<=0?function(){return Fe}:ot(function(e,n){var r=0;e.subscribe(tt(n,function(i){++r<=t&&(n.next(i),t<=r&&n.complete())}))})}function ou(t,e){return e===void 0&&(e=Dt),t=t??su,ot(function(n,r){var i,o=!0;n.subscribe(tt(r,function(s){var c=e(s);(o||!t(i,c))&&(o=!1,i=c,r.next(s))}))})}function su(t,e){return t===e}function au(t){return t===void 0&&(t=cu),ot(function(e,n){var r=!1;e.subscribe(tt(n,function(i){r=!0,n.next(i)},function(){return r?n.complete():n.error(t())}))})}function cu(){return new qr}function Mn(t){return ot(function(e,n){try{e.subscribe(n)}finally{n.add(t)}})}function pr(t,e){var n=arguments.length>=2;return function(r){return r.pipe(t?bt(function(i,o){return t(i,o,r)}):Dt,iu(1),n?ru(e):au(function(){return new qr}))}}function uu(t,e){return ot(function(n,r){var i=null,o=0,s=!1,c=function(){return s&&!i&&r.complete()};n.subscribe(tt(r,function(a){i?.unsubscribe();var u=0,l=o++;It(t(a,l)).subscribe(i=tt(r,function(f){return r.next(e?e(a,f,l,u++):f)},function(){i=null,c()}))},function(){s=!0,c()}))})}function lu(){return uu(Dt)}function Ce(t){return ot(function(e,n){It(t).subscribe(tt(n,function(){return n.complete()},hr)),!n.closed&&e.subscribe(n)})}function fu(t,e){return ot(function(n,r){var i=0;n.subscribe(tt(r,function(o){var s=t(o,i++);(s||e)&&r.next(o),!s&&r.complete()}))})}function Je(t,e,n){var r=Z(t)||e||n?{next:t,error:e,complete:n}:t;return r?ot(function(i,o){var s;(s=r.subscribe)===null||s===void 0||s.call(r);var c=!0;i.subscribe(tt(o,function(a){var u;(u=r.next)===null||u===void 0||u.call(r,a),o.next(a)},function(){var a;c=!1,(a=r.complete)===null||a===void 0||a.call(r),o.complete()},function(a){var u;c=!1,(u=r.error)===null||u===void 0||u.call(r,a),o.error(a)},function(){var a,u;c&&((a=r.unsubscribe)===null||a===void 0||a.call(r)),(u=r.finalize)===null||u===void 0||u.call(r)}))}):Dt}function hu(t){return un((e,n)=>Ke(t(e,n)).pipe(un(r=>r?Vo(e):Fe)))}function zi(t){return pc(Zo(t),Yo(e=>{if(e instanceof Wo)return Fe;throw e}))}function Vn(t,e){const{not:n}=Me(e,{not:!1});return bt(r=>du(r.subId===t,n))}function du(t,e){return!t&&e||t&&!e}class pu{constructor(e){k(this,"relay"),k(this,"config"),k(this,"authenticator"),k(this,"ongoings",new Set),k(this,"authResult$",new M),k(this,"disposed",!1),this.relay=e.relay,this.config=e.config,this.authenticator=e.authenticator;const n=this.relay.getOKObservable().subscribe(i=>{const{eventId:o,ok:s}=i;this.ongoings.has(o)&&(this.ongoings.delete(o),this.authResult$.next(s),s||(n.unsubscribe(),r.unsubscribe()))}),r=this.relay.getAUTHObservable().subscribe(({challenge:i})=>{this.challenge(i)})}getAuthResultObservable(){return this.authResult$.asObservable()}async challenge(e){try{const n=await this.signer.signEvent({kind:22242,content:"",tags:[["relay",this.relay.url],["challenge",e]]});this.ongoings.add(n.id),this.relay.send(["AUTH",n])}catch{this.authResult$.next(!1)}}get signer(){return this.authenticator.signer??this.config.signer}dispose(){this[Symbol.dispose]()}[Symbol.dispose](){if(this.disposed)return;this.disposed=!0;const e=[this.authResult$];for(const n of e)n.complete()}}let Xo=class extends vc{constructor(e){super(e??0)}increment(){this.next(this.getValue()+1)}decrement(){this.next(this.getValue()-1)}next(e){typeof e=="number"?super.next(e):super.next(e(this.getValue()))}};class gu extends M{waitNext(){return Fo(this.pipe(pr(null,void 0)))}}class yu{constructor(e){k(this,"relay"),k(this,"authProxy"),k(this,"pubs",new Map),k(this,"authRequiredPubs",new Set),k(this,"count$",new Xo(0)),k(this,"ok$",new M),k(this,"disposed",!1);var n;this.relay=e.relay,this.authProxy=e.authProxy,this.relay.getReconnectedObservable().subscribe(r=>{for(const[i,o]of r)i==="EVENT"&&this.pubs.has(o.id)&&this.sendEVENT(o)}),this.relay.getOKObservable().subscribe(async r=>{const{eventId:i,notice:o}=r;this.pubs.get(i)&&(this.authProxy&&o!=null&&o.startsWith("auth-required:")?(this.authRequiredPubs.add(i),this.ok$.next({...r,done:!1})):(this.ok$.next({...r,done:!0}),this.confirmOK(i)))}),(n=this.authProxy)==null||n.getAuthResultObservable().subscribe(r=>{if(r)for(const i of this.authRequiredPubs){const o=this.pubs.get(i);o&&this.sendEVENT(o)}else for(const i of this.authRequiredPubs)this.confirmOK(i);this.authRequiredPubs.clear()})}async publish(e){if(!this.disposed)return this.pubs.has(e.id)||(this.pubs.set(e.id,e),this.count$.increment()),this.sendEVENT(e)}confirmOK(e){this.disposed||this.pubs.has(e)||(this.pubs.delete(e),this.count$.decrement())}getOkAgainstEventObservable(){return this.ok$.asObservable()}getLogicalConnectionSizeObservable(){return this.count$.asObservable()}dispose(){this[Symbol.dispose]()}[Symbol.dispose](){if(this.disposed)return;this.disposed=!0;const e=[this.count$,this.ok$];for(const n of e)n.complete()}sendEVENT(e){return this.relay.send(["EVENT",e])}}const Di={OPEN:1};class bu{constructor(e,n){k(this,"socket",null),k(this,"buffer",[]),k(this,"unsent",[]),k(this,"reconnected$",new M),k(this,"outgoing$",new M),k(this,"message$",new M),k(this,"error$",new M),k(this,"retryTimer",null),k(this,"sendAttempted$",new gu),k(this,"isFirstTry",!0),k(this,"maybeDown",!1),k(this,"disposed",!1),k(this,"state$",new M),k(this,"_state","initialized"),this.url=e,this.config=n,n.skipFetchNip11||sn.getOrFetch(e),this.setState("initialized")}get state(){return this._state}setState(e){this._state=e,this.state$.next(e)}connectManually(){this.connect()}connect(e){if(this.state==="terminated")return;const n=typeof e=="number";(this.state==="initialized"||this.state==="dormant"||this.state==="error"||this.state==="rejected"||n)&&(this.socket=this.createSocket(e??0))}createSocket(e){const n=this.isFirstTry;this.isFirstTry=!1;let r=!1;const i=e>0,o=!i&&(this.state==="error"||this.state==="rejected");i?this.setState("retrying"):this.setState("connecting");const s=async()=>{if(this.state==="terminated"){l?.close(me.RX_NOSTR_DISPOSED);return}this.setState("connected"),r=!0,e=0,(i||o)&&(this.reconnected$.next(this.unsent),this.unsent=[]);try{for(const f of this.buffer)this.send(f)}catch(f){this.error$.next(f)}finally{this.buffer=[]}},c=({data:f})=>{if(this.state!=="terminated")try{this.message$.next(this.pack(JSON.parse(f)))}catch(p){this.error$.next(p)}},a=({code:f})=>{var p;if(l?.removeEventListener("open",s),l?.removeEventListener("message",c),l?.removeEventListener("close",a),this.socket===l&&(this.socket=null),this.state==="terminated"||f===me.RX_NOSTR_DISPOSED){this.unsent=[],this.buffer=[];return}if(f===me.RX_NOSTR_IDLE)this.setState("dormant"),this.buffer.length>0&&this.connect();else if(f===me.DONT_RETRY)this.unsent=[],this.buffer=[],this.error$.next(new ki(f)),this.setState("rejected");else{n&&!r&&(this.maybeDown=!0),this.unsent.push(...this.buffer),this.buffer=[],this.error$.next(new ki(f));const b=e+1;this.config.retry.strategy!=="off"&&!(this.config.retry.polite&&this.maybeDown)&&b<=this.config.retry.maxCount?(this.setState("waiting-for-retrying"),(p=this.retryTimer)==null||p.unsubscribe(),this.retryTimer=wu(this.config.retry,b).subscribe(()=>{this.disposed||this.connect(b)})):this.setState("error")}},u=this.config.websocketCtor??globalThis.WebSocket;if(!u)throw new en("WebSocket constructor is missing");const l=(()=>{try{return new u(this.url)}catch{return a({code:0}),null}})();return l?.addEventListener("open",s),l?.addEventListener("message",c),l?.addEventListener("close",a),l}pack(e){const n=e[0],r=this.url;switch(n){case"EVENT":return{from:r,type:n,message:e,subId:e[1],event:e[2]};case"EOSE":return{from:r,type:n,message:e,subId:e[1]};case"OK":return{from:r,type:n,message:e,eventId:e[1],ok:e[2],notice:e[3]};case"CLOSED":return{from:r,type:n,message:e,subId:e[1],notice:e[2]};case"NOTICE":return{from:r,type:n,message:e,notice:e[1]};case"AUTH":return{from:r,type:n,message:e,challenge:e[1]};case"COUNT":return{from:r,type:n,message:e,subId:e[1],count:e[2]};default:return{from:r,type:"unknown",message:e}}}disconnect(e){var n;((n=this.socket)==null?void 0:n.readyState)===Di.OPEN&&this.socket.close(e)}send(e){const n=this.sendAttempted$.waitNext();switch(this.state){case"terminated":case"rejected":return this.sendAttempted$.next(),n;case"initialized":case"connecting":case"dormant":return this.buffer.push(e),this.connect(),n;case"connected":{if(!this.socket)throw new Ao;return this.socket.readyState===Di.OPEN?(this.outgoing$.next({to:this.url,message:e}),this.socket.send(JSON.stringify(e)),this.sendAttempted$.next(),n):(this.buffer.push(e),n)}case"waiting-for-retrying":case"retrying":case"error":return this.sendAttempted$.next(),this.unsent.push(e),n}}getEVENTObservable(){return this.message$.pipe(bt(e=>e.type==="EVENT"))}getEOSEObservable(){return this.message$.pipe(bt(e=>e.type==="EOSE"))}getCLOSEDObservable(){return this.message$.pipe(bt(e=>e.type==="CLOSED"))}getOKObservable(){return this.message$.pipe(bt(e=>e.type==="OK"))}getAUTHObservable(){return this.message$.pipe(bt(e=>e.type==="AUTH"))}getAllMessageObservable(){return this.message$.asObservable()}getOutgoingMessageObservable(){return this.outgoing$.asObservable()}getReconnectedObservable(){return this.reconnected$.asObservable()}getConnectionStateObservable(){return this.state$.pipe(ou(),ee(e=>({from:this.url,state:e})))}getErrorObservable(){return this.error$.asObservable()}dispose(){this[Symbol.dispose]()}[Symbol.dispose](){var e,n;if(this.disposed)return;this.disposed=!0,this.setState("terminated"),(e=this.retryTimer)==null||e.unsubscribe(),(n=this.socket)==null||n.close(me.RX_NOSTR_DISPOSED),this.socket=null;const r=[this.state$,this.outgoing$,this.message$,this.error$,this.reconnected$,this.sendAttempted$];for(const i of r)i.complete()}}function wu(t,e){switch(t.strategy){case"exponential":{const n=Math.max(t.initialDelay*2**(e-1)+(Math.random()-.5)*1e3,1e3);return ji(n)}case"immediately":return Vo(0);case"linear":return ji(t.interval);case"off":return Fe}}const me={DONT_RETRY:4e3,RX_NOSTR_IDLE:4537,RX_NOSTR_DISPOSED:4538};class mu{constructor(e){k(this,"relay"),k(this,"authProxy"),k(this,"config"),k(this,"subs",new Map),k(this,"authRequiredSubs",new Set),k(this,"fin$",new M),k(this,"disposed",!1),k(this,"queue");var n;this.relay=e.relay,this.authProxy=e.authProxy,this.config=e.config,this.queue=new vu(this.relay.url,this.config),this.queue.getActivationObservable().subscribe(r=>{for(const{req:i}of r)this.sendREQ(i)}),this.relay.getReconnectedObservable().subscribe(()=>{for(const{req:r}of this.queue.ongoings)this.sendREQ(r)}),this.relay.getEOSEObservable().subscribe(({subId:r})=>{var i;(i=this.subs.get(r))!=null&&i.autoclose&&this.unsubscribe(r)}),this.relay.getCLOSEDObservable().subscribe(async({subId:r,notice:i})=>{this.subs.get(r)&&(this.authProxy&&i!=null&&i.startsWith("auth-required:")?this.authRequiredSubs.add(r):this.fin(r))}),(n=this.authProxy)==null||n.getAuthResultObservable().subscribe(r=>{var i;if(r)for(const o of this.authRequiredSubs){const s=(i=this.subs.get(o))==null?void 0:i.req;s&&this.sendREQ(s)}else for(const o of this.authRequiredSubs)this.fin(o);this.authRequiredSubs.clear()})}subscribe(e,n){if(this.disposed)return;const r=e[1],i={subId:r,req:e,autoclose:n};this.subs.set(r,i),this.queue.enqueue(i)}unsubscribe(e){this.disposed||(this.subs.has(e)&&this.sendCLOSE(e),this.fin(e))}isOngoingOrQueued(e){return this.subs.has(e)}getEventObservable(){return this.relay.getEVENTObservable().pipe(bt(({subId:e,event:n})=>{var r;const i=(r=this.subs.get(e))==null?void 0:r.filters;return i?this.config.skipValidateFilterMatching||ic(n,i):!1}))}getFinObservable(){return this.fin$.asObservable()}getLogicalConnectionSizeObservable(){return this.queue.getSizeObservable()}dispose(){this[Symbol.dispose]()}[Symbol.dispose](){if(this.disposed)return;this.disposed=!0;const e=[this.fin$];for(const n of e)n.complete();this.queue.dispose()}sendREQ([,e,...n]){const r=nc(n),i=this.subs.get(e);i&&(i.filters=r,this.relay.send(["REQ",e,...r]))}sendCLOSE(e){this.relay.send(["CLOSE",e])}fin(e){this.subs.delete(e),this.queue.drop(e),this.fin$.next({from:this.relay.url,subId:e})}}class vu{constructor(e,n){k(this,"_queuings",[]),k(this,"_ongoings",[]),k(this,"activated$",new M),k(this,"count$",new Xo),this.url=e,this.config=n}get queuings(){return this._queuings}set queuings(e){this._queuings=e}get ongoings(){return this._ongoings}set ongoings(e){this._ongoings=e}enqueue(e){this.queuings=[...this.queuings,e],this.count$.increment(),this.shift()}drop(e){const n=(c,a)=>{const u=c.length,l=c.filter(p=>p.subId!==a),f=u-l.length;return[l,f]},[r,i]=n(this.queuings,e),[o,s]=n(this.ongoings,e);this.queuings=r,this.ongoings=o,this.count$.next(c=>c-(i+s)),this.shift()}getActivationObservable(){return this.activated$.asObservable()}getSizeObservable(){return this.count$.asObservable()}dispose(){const e=[this.activated$,this.count$];for(const n of e)n.complete()}async shift(){const e=await this.capacity(),n=[...this.ongoings,...this.queuings],r=n.slice(0,e),i=n.slice(e),o=this.queuings.slice(0,e-this.ongoings.length);this.ongoings=r,this.queuings=i,o.length>0&&this.activated$.next(o)}async capacity(){return await sn.getValue(this.url,e=>{var n;return(n=e.limitation)==null?void 0:n.max_subscriptions},{skipFetch:this.config.skipFetchNip11})??1/0}}class Eu{constructor(e,n){k(this,"relay"),k(this,"pubProxy"),k(this,"subProxy"),k(this,"defaultSubscriptionIds",new Set),k(this,"communicating",!1),k(this,"strategy","lazy"),k(this,"disconnectTimeout"),k(this,"disconnectTimer"),k(this,"isDefaultRelay",!1),k(this,"disposed",!1),k(this,"_url"),this._url=Ct(e);const r=xu(e,n),i=new bu(this.url,n),o=r?new pu({relay:i,config:n,authenticator:r}):null,s=new yu({relay:i,authProxy:o}),c=new mu({relay:i,authProxy:o,config:n});this.relay=i,this.pubProxy=s,this.subProxy=c,this.disconnectTimeout=n.disconnectTimeout,Qc([this.pubProxy.getLogicalConnectionSizeObservable(),this.subProxy.getLogicalConnectionSizeObservable()]).pipe(ee(([a,u])=>a+u)).subscribe(a=>{this.communicating=a>0,this.resetConnection()})}get url(){return this._url}setConnectionStrategy(e){this.disposed||(this.strategy=e,this.resetConnection())}resetConnection(){let e=this.strategy;switch(this.isDefaultRelay||(e="lazy"),e){case"lazy":{const n=()=>{this.communicating||this.relay.disconnect(me.RX_NOSTR_IDLE)};this.disconnectTimeout>0?(this.disconnectTimeout&&(clearTimeout(this.disconnectTimer),this.disconnectTimer=void 0),this.disconnectTimer=setTimeout(n,this.disconnectTimeout)):n();break}case"lazy-keep":break;case"aggressive":{(this.connectionState==="initialized"||this.connectionState==="dormant")&&this.relay.connectManually();break}}}markAsDefault(e){if(!this.disposed){if(this.isDefaultRelay=e,!this.isDefaultRelay){for(const n of this.defaultSubscriptionIds)this.subProxy.unsubscribe(n);this.defaultSubscriptionIds.clear()}this.resetConnection()}}async publish(e){if(!this.disposed)return this.pubProxy.publish(e)}confirmOK(e){this.disposed||this.pubProxy.confirmOK(e)}subscribe(e,n){if(this.disposed)return;const{mode:r,overwrite:i,autoclose:o}=Me(n??{},{overwrite:!1,autoclose:!1,mode:"default"}),[,s]=e;r==="default"&&!this.isDefaultRelay||!i&&this.subProxy.isOngoingOrQueued(s)||(r==="default"&&this.defaultSubscriptionIds.add(s),this.subProxy.subscribe(e,o))}unsubscribe(e){this.disposed||(this.defaultSubscriptionIds.delete(e),this.subProxy.unsubscribe(e))}getEventObservable(){if(this.disposed)throw new Ut;return this.subProxy.getEventObservable()}getFinObservable(){if(this.disposed)throw new Ut;return this.subProxy.getFinObservable()}getOkAgainstEventObservable(){if(this.disposed)throw new Ut;return this.pubProxy.getOkAgainstEventObservable()}getAllMessageObservable(){if(this.disposed)throw new Ut;return this.relay.getAllMessageObservable()}getOutgoingMessageObservable(){if(this.disposed)throw new Ut;return this.relay.getOutgoingMessageObservable()}getConnectionStateObservable(){if(this.disposed)throw new Ut;return this.relay.getConnectionStateObservable()}get connectionState(){return this.relay.state}getErrorObservable(){if(this.disposed)throw new Ut;return this.relay.getErrorObservable().pipe(ee(e=>({from:this.url,reason:e})))}connectManually(){this.relay.connectManually()}dispose(){this[Symbol.dispose]()}[Symbol.dispose](){this.disposed||(this.disposed=!0,this.disconnectTimer&&clearTimeout(this.disconnectTimer),this.disconnectTimer=void 0,this.relay.dispose(),this.pubProxy.dispose(),this.subProxy.dispose())}}function xu(t,e){const n=e.authenticator;if(!n)return;const r=n instanceof Function?n(t):n;return r==="auto"?{}:r}function Su(t,e){return t.filter(n=>!e.includes(n))}function Au(t){const{rxReq:e,index:n}=t,{rxReqId:r,strategy:i}=e;return`${r}:${i==="backward"?n:0}`}function $u(t){const{rxReq:e,filters:n,index:r}=t;return["REQ",Au({rxReq:e,index:r}),...n]}function Mi(t){if(Array.isArray(t)){const e=t.map(n=>{let r="",i=!1,o=!1;if(typeof n=="string")r=n,i=!0,o=!0;else if(Array.isArray(n)){const s=n[2];r=n[1],i=!s||s==="read",o=!s||s==="write"}else r=n.url,i=n.read,o=n.write;return{url:r,read:i,write:o}});return Object.fromEntries(e.map(n=>[n.url,n]))}else{const e=Object.entries(t).map(([n,r])=>({url:n,...r}));return Object.fromEntries(e.map(n=>[n.url,n]))}}function Vi(t,e){const n=new Set;if(e!=null&&e.on){const r=e.on;if(!r.defaultReadRelays&&!r.defaultWriteRelays&&!r.relays)return;const i=t.getDefaultRelays();if(r.defaultReadRelays)for(const{url:o}of Object.values(i).filter(s=>s.read))n.add(o);if(r.defaultWriteRelays)for(const{url:o}of Object.values(i).filter(s=>s.write))n.add(o);if(r.relays)for(const o of r.relays)n.add(Ct(o));return[...n]}else if(e!=null&&e.relays){for(const r of e.relays)n.add(Ct(r));return[...n]}else return}function ty(t){return new Bu(ec(t??{}))}class Bu{constructor(e){k(this,"connections",new Ee),k(this,"defaultRelays",new Ee),k(this,"defaultSubscriptions",new Map),k(this,"event$",new M),k(this,"fin$",new M),k(this,"ok$",new M),k(this,"all$",new M),k(this,"error$",new M),k(this,"connectionState$",new M),k(this,"outgoing$",new M),k(this,"dispose$",new M),k(this,"disposed",!1),this.config=e}get defaultReadableConnections(){const e=[];for(const{url:n,read:r}of this.defaultRelays.values()){const i=this.connections.get(n);r&&i&&e.push(i)}return e}get defaultWritableConnections(){const e=[];for(const{url:n,write:r}of this.defaultRelays.values()){const i=this.connections.get(n);r&&i&&e.push(i)}return e}getDefaultRelays(){if(this.disposed)throw new Ut;return this.defaultRelays.toObject()}getDefaultRelay(e){return this.defaultRelays.get(e)}setDefaultRelays(e){if(this.disposed)throw new Ut;const n=new Ee(Mi(e)),r=[];for(const{read:i,url:o}of n.values()){const s=this.ensureNostrConnection(o);s.setConnectionStrategy(this.config.connectionStrategy),i&&r.push(s)}this.updateDefaultSubscriptions(r),this.defaultRelays=n}ensureNostrConnection(e){let n=this.connections.get(e);return n||(n=new Eu(e,this.config),this.attachNostrConnection(n),this.connections.set(e,n),n)}attachNostrConnection(e){e.getEventObservable().subscribe(this.event$),e.getFinObservable().subscribe(this.fin$),e.getOkAgainstEventObservable().subscribe(this.ok$),e.getAllMessageObservable().subscribe(this.all$),e.getConnectionStateObservable().subscribe(this.connectionState$),e.getErrorObservable().subscribe(this.error$),e.getOutgoingMessageObservable().subscribe(this.outgoing$)}updateDefaultSubscriptions(e){const n=Su(this.defaultReadableConnections,e);for(const r of n)r.markAsDefault(!1);for(const r of e){r.markAsDefault(!0);for(const{req:i,autoclose:o}of this.defaultSubscriptions.values())r?.subscribe(i,{mode:"default",overwrite:!1,autoclose:o})}}addDefaultRelays(e){const n=Mi(e);this.setDefaultRelays({...this.defaultRelays.toObject(),...n})}removeDefaultRelays(e){const n=this.defaultRelays.copy(),r=Array.isArray(e)?e:[e];for(const i of r)n.delete(i);this.setDefaultRelays(n.toObject())}getAllRelayStatus(){return Object.fromEntries(Array.from(this.connections.values()).map(e=>[e.url,{connection:e.connectionState}]))}getRelayStatus(e){const n=this.connections.get(e);if(n)return{connection:n.connectionState}}reconnect(e){const n=this.getDefaultRelay(e);if(!n)throw new en(`The relay (${e}) is not a default relay. \`reconnect()\` can be used only for a readable default relay.`);if(!n.read)throw new en(`The relay (${e}) is not readable. \`reconnect()\` can be used only for a readable default relay.`);const r=this.connections.get(e);if(!r)throw new Ao;(r.connectionState==="error"||r.connectionState==="rejected")&&r.connectManually()}use(e,n){const r=Vi(this,n),i=({filters:l,relays:f},p)=>{var b;const g=e.strategy==="backward"?f:void 0,h=$u({rxReq:e,filters:l,index:p});return{subId:h[1],req:h,targetConnections:((b=g??r)==null?void 0:b.map(d=>this.ensureNostrConnection(d)))??this.defaultReadableConnections,mode:g===void 0&&r===void 0?"default":"temporary"}},o=({req:l,targetConnections:f,mode:p})=>{this.startSubscription({req:l,targetConnections:f,mode:p,overwrite:e.strategy==="forward",autoclose:e.strategy==="backward"})},s=({subId:l,targetConnections:f,mode:p})=>{this.teardownSubscription({subId:l,targetConnections:f,mode:p})},c=({req:l,targetConnections:f})=>e.strategy==="forward"?this.createForwardEventObservable({req:l}).pipe(Ce(this.dispose$)):this.createBackwardEventObservable({req:l,targetConnections:f}).pipe(Ce(this.dispose$)),a=e.getReqPacketObservable().pipe(bt(({filters:l})=>l.length>0),ee(i),Ce(this.dispose$)),u=()=>hu(async({event:l})=>(this.config.skipVerify||await this.config.verifier(l))&&(this.config.skipExpirationCheck||!oc(l)));if(e.strategy==="forward"){let l;return a.pipe(Je(f=>{l=f}),Je(o),ee(c),Mn(()=>{l&&s(l)}),lu(),u())}else return a.pipe(Je(o),ee(l=>c(l).pipe(Mn(()=>{s(l)}))),Go(),u())}createForwardEventObservable(e){const{req:n}=e,r=n[1];return this.event$.pipe(Vn(r))}createBackwardEventObservable(e){const{req:n,targetConnections:r}=e,i=n[1],o=new Set,s=l=>l==="error"||l==="rejected"||l==="terminated",c=()=>r.every(({connectionState:l,url:f})=>s(l)||o.has(f)),a=this.fin$.pipe(Vn(i),Je(({from:l})=>{o.add(l)})),u=nu(a,this.connectionState$.asObservable()).pipe(bt(()=>c()),pr(null,void 0));return this.event$.pipe(Ce(u),zi(this.config.eoseTimeout),Vn(i),bt(l=>!o.has(l.from)))}startSubscription(e){const{req:n,targetConnections:r,mode:i,overwrite:o,autoclose:s}=e,c=n[1];i==="default"&&this.defaultSubscriptions.set(c,{req:n,autoclose:s});for(const a of r)a.subscribe(n,{mode:i,overwrite:o,autoclose:s})}teardownSubscription(e){const{subId:n,targetConnections:r,mode:i}=e;i==="default"&&this.defaultSubscriptions.delete(n);for(const o of r)o.unsubscribe(n)}createAllEventObservable(){return this.event$.asObservable()}createAllErrorObservable(){return this.error$.asObservable()}createAllMessageObservable(){return this.all$.asObservable()}createConnectionStateObservable(){return this.connectionState$.asObservable()}createOutgoingMessageObservable(){return this.outgoing$.asObservable()}send(e,n){const{signer:r,errorOnTimeout:i,completeOn:o}=Me(n??{},{signer:this.config.signer,errorOnTimeout:!1,completeOn:"all-ok"}),s=Vi(this,n),c=s===void 0?this.defaultWritableConnections:s.map(b=>this.ensureNostrConnection(b)),a=new M,u=new Set;let l="";const f=()=>{a.closed||a.complete();for(const b of c)b.confirmOK(l)};r.signEvent(e).then(async b=>{a.closed||(l=b.id,this.ok$.pipe(bt(({eventId:g})=>g===b.id)).subscribe(a),await Promise.all(c.map(g=>g.publish(b))),o==="sent"&&a.complete())}).catch(b=>{throw f(),new en(b instanceof Error?b.message:"Failed to sign the given event")});const p=(()=>{switch(o){case"sent":return Dt;case"all-ok":return fu(({from:b,done:g})=>(g&&u.add(b),u.size<c.length),!0);case"any-ok":return pr(b=>b.ok)}})();return a.pipe(p,Ce(this.dispose$),i?Zo(this.config.okTimeout):zi(this.config.okTimeout),Mn(f))}async cast(e,n){await Fo(this.send(e,{...n,completeOn:"sent"}))}dispose(){this[Symbol.dispose]()}[Symbol.dispose](){if(this.disposed)return;this.disposed=!0;for(const n of this.connections.values())n.dispose();this.connections.clear();const e=[this.event$,this.ok$,this.fin$,this.all$,this.connectionState$,this.error$,this.outgoing$];for(const n of e)n.complete();this.dispose$.next(),this.dispose$.complete()}}const Jo=t=>{const{strategy:e}=t,n=t.operators??[],r=t.rxReqId??Ou(),i=t.subject??new M;return{strategy:e,rxReqId:r,getReqPacketObservable(){return i.pipe(...n)},pipe(...o){return Jo({strategy:e,rxReqId:r,operators:[...n,...o],subject:i})},emit(o,s){i.next({filters:Iu(o),...s??{}})},over(){i.complete()}}};function ey(t){return Jo({strategy:"backward",rxReqId:t})}function Ou(){return`${Math.floor(Math.random()*1e6)}`}function _u(t){var e,n;const r={},i=o=>/^#[a-zA-Z]$/.test(o);for(const o of Object.keys(t)){if(o==="limit"&&(t[o]??-1)>=0){r[o]=t[o];continue}if(o==="since"||o==="until"){const s=t[o];if(typeof s!="number"||(s??-1)>=0){r[o]=s;continue}}if((i(o)||o==="ids"||o==="authors")&&t[o]!==void 0&&(((e=t[o])==null?void 0:e.length)??-1)>0){r[o]=t[o];continue}if(o==="kinds"&&t[o]!==void 0&&(((n=t[o])==null?void 0:n.length)??-1)>0){r[o]=t[o];continue}if(o==="search"&&t[o]!==void 0){r[o]=t[o];continue}}return typeof r.since!="number"||typeof r.until!="number"||r.since<=r.until?r:null}function Iu(t){return(Array.isArray(t)?t:[t]).map(e=>_u(e)).filter(e=>e!==null)}function Fi(t){if(!Number.isSafeInteger(t)||t<0)throw new Error(`positive integer expected, not ${t}`)}function ku(t){return t instanceof Uint8Array||t!=null&&typeof t=="object"&&t.constructor.name==="Uint8Array"}function We(t,...e){if(!ku(t))throw new Error("Uint8Array expected");if(e.length>0&&!e.includes(t.length))throw new Error(`Uint8Array expected of length ${e}, not of length=${t.length}`)}function Ru(t){if(typeof t!="function"||typeof t.create!="function")throw new Error("Hash should be wrapped by utils.wrapConstructor");Fi(t.outputLen),Fi(t.blockLen)}function ln(t,e=!0){if(t.destroyed)throw new Error("Hash instance has been destroyed");if(e&&t.finished)throw new Error("Hash#digest() has already been called")}function Tu(t,e){We(t);const n=e.outputLen;if(t.length<n)throw new Error(`digestInto() expects output buffer of length at least ${n}`)}const Fn=typeof globalThis=="object"&&"crypto"in globalThis?globalThis.crypto:void 0;const Kn=t=>new DataView(t.buffer,t.byteOffset,t.byteLength),vt=(t,e)=>t<<32-e|t>>>e;new Uint8Array(new Uint32Array([287454020]).buffer)[0];const Lu=Array.from({length:256},(t,e)=>e.toString(16).padStart(2,"0"));function fn(t){We(t);let e="";for(let n=0;n<t.length;n++)e+=Lu[t[n]];return e}function Nu(t){if(typeof t!="string")throw new Error(`utf8ToBytes expected string, got ${typeof t}`);return new Uint8Array(new TextEncoder().encode(t))}function Hr(t){return typeof t=="string"&&(t=Nu(t)),We(t),t}function Uu(...t){let e=0;for(let r=0;r<t.length;r++){const i=t[r];We(i),e+=i.length}const n=new Uint8Array(e);for(let r=0,i=0;r<t.length;r++){const o=t[r];n.set(o,i),i+=o.length}return n}let Qo=class{clone(){return this._cloneInto()}};function Cu(t){const e=r=>t().update(Hr(r)).digest(),n=t();return e.outputLen=n.outputLen,e.blockLen=n.blockLen,e.create=()=>t(),e}function ts(t=32){if(Fn&&typeof Fn.getRandomValues=="function")return Fn.getRandomValues(new Uint8Array(t));throw new Error("crypto.getRandomValues must be defined")}function Pu(t,e,n,r){if(typeof t.setBigUint64=="function")return t.setBigUint64(e,n,r);const i=BigInt(32),o=BigInt(4294967295),s=Number(n>>i&o),c=Number(n&o),a=r?4:0,u=r?0:4;t.setUint32(e+a,s,r),t.setUint32(e+u,c,r)}const qu=(t,e,n)=>t&e^~t&n,Hu=(t,e,n)=>t&e^t&n^e&n;class ju extends Qo{constructor(e,n,r,i){super(),this.blockLen=e,this.outputLen=n,this.padOffset=r,this.isLE=i,this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.buffer=new Uint8Array(e),this.view=Kn(this.buffer)}update(e){ln(this);const{view:n,buffer:r,blockLen:i}=this;e=Hr(e);const o=e.length;for(let s=0;s<o;){const c=Math.min(i-this.pos,o-s);if(c===i){const a=Kn(e);for(;i<=o-s;s+=i)this.process(a,s);continue}r.set(e.subarray(s,s+c),this.pos),this.pos+=c,s+=c,this.pos===i&&(this.process(n,0),this.pos=0)}return this.length+=e.length,this.roundClean(),this}digestInto(e){ln(this),Tu(e,this),this.finished=!0;const{buffer:n,view:r,blockLen:i,isLE:o}=this;let{pos:s}=this;n[s++]=128,this.buffer.subarray(s).fill(0),this.padOffset>i-s&&(this.process(r,0),s=0);for(let f=s;f<i;f++)n[f]=0;Pu(r,i-8,BigInt(this.length*8),o),this.process(r,0);const c=Kn(e),a=this.outputLen;if(a%4)throw new Error("_sha2: outputLen should be aligned to 32bit");const u=a/4,l=this.get();if(u>l.length)throw new Error("_sha2: outputLen bigger than state");for(let f=0;f<u;f++)c.setUint32(4*f,l[f],o)}digest(){const{buffer:e,outputLen:n}=this;this.digestInto(e);const r=e.slice(0,n);return this.destroy(),r}_cloneInto(e){e||(e=new this.constructor),e.set(...this.get());const{blockLen:n,buffer:r,length:i,finished:o,destroyed:s,pos:c}=this;return e.length=i,e.pos=c,e.finished=o,e.destroyed=s,i%n&&e.buffer.set(r),e}}const zu=new Uint32Array([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),Zt=new Uint32Array([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),Gt=new Uint32Array(64);class Du extends ju{constructor(){super(64,32,8,!1),this.A=Zt[0]|0,this.B=Zt[1]|0,this.C=Zt[2]|0,this.D=Zt[3]|0,this.E=Zt[4]|0,this.F=Zt[5]|0,this.G=Zt[6]|0,this.H=Zt[7]|0}get(){const{A:e,B:n,C:r,D:i,E:o,F:s,G:c,H:a}=this;return[e,n,r,i,o,s,c,a]}set(e,n,r,i,o,s,c,a){this.A=e|0,this.B=n|0,this.C=r|0,this.D=i|0,this.E=o|0,this.F=s|0,this.G=c|0,this.H=a|0}process(e,n){for(let f=0;f<16;f++,n+=4)Gt[f]=e.getUint32(n,!1);for(let f=16;f<64;f++){const p=Gt[f-15],b=Gt[f-2],g=vt(p,7)^vt(p,18)^p>>>3,h=vt(b,17)^vt(b,19)^b>>>10;Gt[f]=h+Gt[f-7]+g+Gt[f-16]|0}let{A:r,B:i,C:o,D:s,E:c,F:a,G:u,H:l}=this;for(let f=0;f<64;f++){const p=vt(c,6)^vt(c,11)^vt(c,25),b=l+p+qu(c,a,u)+zu[f]+Gt[f]|0,g=(vt(r,2)^vt(r,13)^vt(r,22))+Hu(r,i,o)|0;l=u,u=a,a=c,c=s+b|0,s=o,o=i,i=r,r=b+g|0}r=r+this.A|0,i=i+this.B|0,o=o+this.C|0,s=s+this.D|0,c=c+this.E|0,a=a+this.F|0,u=u+this.G|0,l=l+this.H|0,this.set(r,i,o,s,c,a,u,l)}roundClean(){Gt.fill(0)}destroy(){this.set(0,0,0,0,0,0,0,0),this.buffer.fill(0)}}const hn=Cu(()=>new Du);const es=BigInt(0),An=BigInt(1),Mu=BigInt(2);function he(t){return t instanceof Uint8Array||t!=null&&typeof t=="object"&&t.constructor.name==="Uint8Array"}function Ze(t){if(!he(t))throw new Error("Uint8Array expected")}const Vu=Array.from({length:256},(t,e)=>e.toString(16).padStart(2,"0"));function Oe(t){Ze(t);let e="";for(let n=0;n<t.length;n++)e+=Vu[t[n]];return e}function ns(t){const e=t.toString(16);return e.length&1?`0${e}`:e}function jr(t){if(typeof t!="string")throw new Error("hex string expected, got "+typeof t);return BigInt(t===""?"0":`0x${t}`)}const Tt={_0:48,_9:57,_A:65,_F:70,_a:97,_f:102};function Ki(t){if(t>=Tt._0&&t<=Tt._9)return t-Tt._0;if(t>=Tt._A&&t<=Tt._F)return t-(Tt._A-10);if(t>=Tt._a&&t<=Tt._f)return t-(Tt._a-10)}function _e(t){if(typeof t!="string")throw new Error("hex string expected, got "+typeof t);const e=t.length,n=e/2;if(e%2)throw new Error("padded hex string expected, got unpadded hex of length "+e);const r=new Uint8Array(n);for(let i=0,o=0;i<n;i++,o+=2){const s=Ki(t.charCodeAt(o)),c=Ki(t.charCodeAt(o+1));if(s===void 0||c===void 0){const a=t[o]+t[o+1];throw new Error('hex string expected, got non-hex character "'+a+'" at index '+o)}r[i]=s*16+c}return r}function ct(t){return jr(Oe(t))}function zr(t){return Ze(t),jr(Oe(Uint8Array.from(t).reverse()))}function re(t,e){return _e(t.toString(16).padStart(e*2,"0"))}function Dr(t,e){return re(t,e).reverse()}function Fu(t){return _e(ns(t))}function nt(t,e,n){let r;if(typeof e=="string")try{r=_e(e)}catch(o){throw new Error(`${t} must be valid hex string, got "${e}". Cause: ${o}`)}else if(he(e))r=Uint8Array.from(e);else throw new Error(`${t} must be hex string or Uint8Array`);const i=r.length;if(typeof n=="number"&&i!==n)throw new Error(`${t} expected ${n} bytes, got ${i}`);return r}function de(...t){let e=0;for(let r=0;r<t.length;r++){const i=t[r];Ze(i),e+=i.length}const n=new Uint8Array(e);for(let r=0,i=0;r<t.length;r++){const o=t[r];n.set(o,i),i+=o.length}return n}function Ku(t,e){if(t.length!==e.length)return!1;let n=0;for(let r=0;r<t.length;r++)n|=t[r]^e[r];return n===0}function Wu(t){if(typeof t!="string")throw new Error(`utf8ToBytes expected string, got ${typeof t}`);return new Uint8Array(new TextEncoder().encode(t))}function Zu(t){let e;for(e=0;t>es;t>>=An,e+=1);return e}function Gu(t,e){return t>>BigInt(e)&An}function Yu(t,e,n){return t|(n?An:es)<<BigInt(e)}const Mr=t=>(Mu<<BigInt(t-1))-An,Wn=t=>new Uint8Array(t),Wi=t=>Uint8Array.from(t);function rs(t,e,n){if(typeof t!="number"||t<2)throw new Error("hashLen must be a number");if(typeof e!="number"||e<2)throw new Error("qByteLen must be a number");if(typeof n!="function")throw new Error("hmacFn must be a function");let r=Wn(t),i=Wn(t),o=0;const s=()=>{r.fill(1),i.fill(0),o=0},c=(...l)=>n(i,r,...l),a=(l=Wn())=>{i=c(Wi([0]),l),r=c(),l.length!==0&&(i=c(Wi([1]),l),r=c())},u=()=>{if(o++>=1e3)throw new Error("drbg: tried 1000 values");let l=0;const f=[];for(;l<e;){r=c();const p=r.slice();f.push(p),l+=r.length}return de(...f)};return(l,f)=>{s(),a(l);let p;for(;!(p=f(u()));)a();return s(),p}}const Xu={bigint:t=>typeof t=="bigint",function:t=>typeof t=="function",boolean:t=>typeof t=="boolean",string:t=>typeof t=="string",stringOrUint8Array:t=>typeof t=="string"||he(t),isSafeInteger:t=>Number.isSafeInteger(t),array:t=>Array.isArray(t),field:(t,e)=>e.Fp.isValid(t),hash:t=>typeof t=="function"&&Number.isSafeInteger(t.outputLen)};function Ge(t,e,n={}){const r=(i,o,s)=>{const c=Xu[o];if(typeof c!="function")throw new Error(`Invalid validator "${o}", expected function`);const a=t[i];if(!(s&&a===void 0)&&!c(a,t))throw new Error(`Invalid param ${String(i)}=${a} (${typeof a}), expected ${o}`)};for(const[i,o]of Object.entries(e))r(i,o,!1);for(const[i,o]of Object.entries(n))r(i,o,!0);return t}const Ju=Object.freeze(Object.defineProperty({__proto__:null,abytes:Ze,bitGet:Gu,bitLen:Zu,bitMask:Mr,bitSet:Yu,bytesToHex:Oe,bytesToNumberBE:ct,bytesToNumberLE:zr,concatBytes:de,createHmacDrbg:rs,ensureBytes:nt,equalBytes:Ku,hexToBytes:_e,hexToNumber:jr,isBytes:he,numberToBytesBE:re,numberToBytesLE:Dr,numberToHexUnpadded:ns,numberToVarBytesBE:Fu,utf8ToBytes:Wu,validateObject:Ge},Symbol.toStringTag,{value:"Module"}));const Y=BigInt(0),K=BigInt(1),ce=BigInt(2),Qu=BigInt(3),gr=BigInt(4),Zi=BigInt(5),Gi=BigInt(8);BigInt(9);BigInt(16);function J(t,e){const n=t%e;return n>=Y?n:e+n}function tl(t,e,n){if(n<=Y||e<Y)throw new Error("Expected power/modulo > 0");if(n===K)return Y;let r=K;for(;e>Y;)e&K&&(r=r*t%n),t=t*t%n,e>>=K;return r}function dt(t,e,n){let r=t;for(;e-- >Y;)r*=r,r%=n;return r}function yr(t,e){if(t===Y||e<=Y)throw new Error(`invert: expected positive integers, got n=${t} mod=${e}`);let n=J(t,e),r=e,i=Y,o=K;for(;n!==Y;){const s=r/n,c=r%n,a=i-o*s;r=n,n=c,i=o,o=a}if(r!==K)throw new Error("invert: does not exist");return J(i,e)}function el(t){const e=(t-K)/ce;let n,r,i;for(n=t-K,r=0;n%ce===Y;n/=ce,r++);for(i=ce;i<t&&tl(i,e,t)!==t-K;i++);if(r===1){const s=(t+K)/gr;return function(c,a){const u=c.pow(a,s);if(!c.eql(c.sqr(u),a))throw new Error("Cannot find square root");return u}}const o=(n+K)/ce;return function(s,c){if(s.pow(c,e)===s.neg(s.ONE))throw new Error("Cannot find square root");let a=r,u=s.pow(s.mul(s.ONE,i),n),l=s.pow(c,o),f=s.pow(c,n);for(;!s.eql(f,s.ONE);){if(s.eql(f,s.ZERO))return s.ZERO;let p=1;for(let g=s.sqr(f);p<a&&!s.eql(g,s.ONE);p++)g=s.sqr(g);const b=s.pow(u,K<<BigInt(a-p-1));u=s.sqr(b),l=s.mul(l,b),f=s.mul(f,u),a=p}return l}}function nl(t){if(t%gr===Qu){const e=(t+K)/gr;return function(n,r){const i=n.pow(r,e);if(!n.eql(n.sqr(i),r))throw new Error("Cannot find square root");return i}}if(t%Gi===Zi){const e=(t-Zi)/Gi;return function(n,r){const i=n.mul(r,ce),o=n.pow(i,e),s=n.mul(r,o),c=n.mul(n.mul(s,ce),o),a=n.mul(s,n.sub(c,n.ONE));if(!n.eql(n.sqr(a),r))throw new Error("Cannot find square root");return a}}return el(t)}const rl=["create","isValid","is0","neg","inv","sqrt","sqr","eql","add","sub","mul","pow","div","addN","subN","mulN","sqrN"];function il(t){const e={ORDER:"bigint",MASK:"bigint",BYTES:"isSafeInteger",BITS:"isSafeInteger"},n=rl.reduce((r,i)=>(r[i]="function",r),e);return Ge(t,n)}function ol(t,e,n){if(n<Y)throw new Error("Expected power > 0");if(n===Y)return t.ONE;if(n===K)return e;let r=t.ONE,i=e;for(;n>Y;)n&K&&(r=t.mul(r,i)),i=t.sqr(i),n>>=K;return r}function sl(t,e){const n=new Array(e.length),r=e.reduce((o,s,c)=>t.is0(s)?o:(n[c]=o,t.mul(o,s)),t.ONE),i=t.inv(r);return e.reduceRight((o,s,c)=>t.is0(s)?o:(n[c]=t.mul(o,n[c]),t.mul(o,s)),i),n}function is(t,e){const n=e!==void 0?e:t.toString(2).length,r=Math.ceil(n/8);return{nBitLength:n,nByteLength:r}}function al(t,e,n=!1,r={}){if(t<=Y)throw new Error(`Expected Field ORDER > 0, got ${t}`);const{nBitLength:i,nByteLength:o}=is(t,e);if(o>2048)throw new Error("Field lengths over 2048 bytes are not supported");const s=nl(t),c=Object.freeze({ORDER:t,BITS:i,BYTES:o,MASK:Mr(i),ZERO:Y,ONE:K,create:a=>J(a,t),isValid:a=>{if(typeof a!="bigint")throw new Error(`Invalid field element: expected bigint, got ${typeof a}`);return Y<=a&&a<t},is0:a=>a===Y,isOdd:a=>(a&K)===K,neg:a=>J(-a,t),eql:(a,u)=>a===u,sqr:a=>J(a*a,t),add:(a,u)=>J(a+u,t),sub:(a,u)=>J(a-u,t),mul:(a,u)=>J(a*u,t),pow:(a,u)=>ol(c,a,u),div:(a,u)=>J(a*yr(u,t),t),sqrN:a=>a*a,addN:(a,u)=>a+u,subN:(a,u)=>a-u,mulN:(a,u)=>a*u,inv:a=>yr(a,t),sqrt:r.sqrt||(a=>s(c,a)),invertBatch:a=>sl(c,a),cmov:(a,u,l)=>l?u:a,toBytes:a=>n?Dr(a,o):re(a,o),fromBytes:a=>{if(a.length!==o)throw new Error(`Fp.fromBytes: expected ${o}, got ${a.length}`);return n?zr(a):ct(a)}});return Object.freeze(c)}function os(t){if(typeof t!="bigint")throw new Error("field order must be bigint");const e=t.toString(2).length;return Math.ceil(e/8)}function ss(t){const e=os(t);return e+Math.ceil(e/2)}function cl(t,e,n=!1){const r=t.length,i=os(e),o=ss(e);if(r<16||r<o||r>1024)throw new Error(`expected ${o}-1024 bytes of input, got ${r}`);const s=n?ct(t):zr(t),c=J(s,e-K)+K;return n?Dr(c,i):re(c,i)}const ul=BigInt(0),Zn=BigInt(1);function ll(t,e){const n=(i,o)=>{const s=o.negate();return i?s:o},r=i=>{const o=Math.ceil(e/i)+1,s=2**(i-1);return{windows:o,windowSize:s}};return{constTimeNegate:n,unsafeLadder(i,o){let s=t.ZERO,c=i;for(;o>ul;)o&Zn&&(s=s.add(c)),c=c.double(),o>>=Zn;return s},precomputeWindow(i,o){const{windows:s,windowSize:c}=r(o),a=[];let u=i,l=u;for(let f=0;f<s;f++){l=u,a.push(l);for(let p=1;p<c;p++)l=l.add(u),a.push(l);u=l.double()}return a},wNAF(i,o,s){const{windows:c,windowSize:a}=r(i);let u=t.ZERO,l=t.BASE;const f=BigInt(2**i-1),p=2**i,b=BigInt(i);for(let g=0;g<c;g++){const h=g*a;let d=Number(s&f);s>>=b,d>a&&(d-=p,s+=Zn);const y=h,v=h+Math.abs(d)-1,S=g%2!==0,_=d<0;d===0?l=l.add(n(S,o[y])):u=u.add(n(_,o[v]))}return{p:u,f:l}},wNAFCached(i,o,s,c){const a=i._WINDOW_SIZE||1;let u=o.get(i);return u||(u=this.precomputeWindow(i,a),a!==1&&o.set(i,c(u))),this.wNAF(a,u,s)}}}function as(t){return il(t.Fp),Ge(t,{n:"bigint",h:"bigint",Gx:"field",Gy:"field"},{nBitLength:"isSafeInteger",nByteLength:"isSafeInteger"}),Object.freeze({...is(t.n,t.nBitLength),...t,p:t.Fp.ORDER})}function fl(t){const e=as(t);Ge(e,{a:"field",b:"field"},{allowedPrivateKeyLengths:"array",wrapPrivateKey:"boolean",isTorsionFree:"function",clearCofactor:"function",allowInfinityPoint:"boolean",fromBytes:"function",toBytes:"function"});const{endo:n,Fp:r,a:i}=e;if(n){if(!r.eql(i,r.ZERO))throw new Error("Endomorphism can only be defined for Koblitz curves that have a=0");if(typeof n!="object"||typeof n.beta!="bigint"||typeof n.splitScalar!="function")throw new Error("Expected endomorphism with beta: bigint and splitScalar: function")}return Object.freeze({...e})}const{bytesToNumberBE:hl,hexToBytes:dl}=Ju,le={Err:class extends Error{constructor(t=""){super(t)}},_parseInt(t){const{Err:e}=le;if(t.length<2||t[0]!==2)throw new e("Invalid signature integer tag");const n=t[1],r=t.subarray(2,n+2);if(!n||r.length!==n)throw new e("Invalid signature integer: wrong length");if(r[0]&128)throw new e("Invalid signature integer: negative");if(r[0]===0&&!(r[1]&128))throw new e("Invalid signature integer: unnecessary leading zero");return{d:hl(r),l:t.subarray(n+2)}},toSig(t){const{Err:e}=le,n=typeof t=="string"?dl(t):t;Ze(n);let r=n.length;if(r<2||n[0]!=48)throw new e("Invalid signature tag");if(n[1]!==r-2)throw new e("Invalid signature: incorrect length");const{d:i,l:o}=le._parseInt(n.subarray(2)),{d:s,l:c}=le._parseInt(o);if(c.length)throw new e("Invalid signature: left bytes after parsing");return{r:i,s}},hexFromSig(t){const e=u=>Number.parseInt(u[0],16)&8?"00"+u:u,n=u=>{const l=u.toString(16);return l.length&1?`0${l}`:l},r=e(n(t.s)),i=e(n(t.r)),o=r.length/2,s=i.length/2,c=n(o),a=n(s);return`30${n(s+o+4)}02${a}${i}02${c}${r}`}},Pt=BigInt(0),gt=BigInt(1);BigInt(2);const Yi=BigInt(3);BigInt(4);function pl(t){const e=fl(t),{Fp:n}=e,r=e.toBytes||((g,h,d)=>{const y=h.toAffine();return de(Uint8Array.from([4]),n.toBytes(y.x),n.toBytes(y.y))}),i=e.fromBytes||(g=>{const h=g.subarray(1),d=n.fromBytes(h.subarray(0,n.BYTES)),y=n.fromBytes(h.subarray(n.BYTES,2*n.BYTES));return{x:d,y}});function o(g){const{a:h,b:d}=e,y=n.sqr(g),v=n.mul(y,g);return n.add(n.add(v,n.mul(g,h)),d)}if(!n.eql(n.sqr(e.Gy),o(e.Gx)))throw new Error("bad generator point: equation left != right");function s(g){return typeof g=="bigint"&&Pt<g&&g<e.n}function c(g){if(!s(g))throw new Error("Expected valid bigint: 0 < bigint < curve.n")}function a(g){const{allowedPrivateKeyLengths:h,nByteLength:d,wrapPrivateKey:y,n:v}=e;if(h&&typeof g!="bigint"){if(he(g)&&(g=Oe(g)),typeof g!="string"||!h.includes(g.length))throw new Error("Invalid key");g=g.padStart(d*2,"0")}let S;try{S=typeof g=="bigint"?g:ct(nt("private key",g,d))}catch{throw new Error(`private key must be ${d} bytes, hex or bigint, not ${typeof g}`)}return y&&(S=J(S,v)),c(S),S}const u=new Map;function l(g){if(!(g instanceof f))throw new Error("ProjectivePoint expected")}class f{constructor(h,d,y){if(this.px=h,this.py=d,this.pz=y,h==null||!n.isValid(h))throw new Error("x required");if(d==null||!n.isValid(d))throw new Error("y required");if(y==null||!n.isValid(y))throw new Error("z required")}static fromAffine(h){const{x:d,y}=h||{};if(!h||!n.isValid(d)||!n.isValid(y))throw new Error("invalid affine point");if(h instanceof f)throw new Error("projective point not allowed");const v=S=>n.eql(S,n.ZERO);return v(d)&&v(y)?f.ZERO:new f(d,y,n.ONE)}get x(){return this.toAffine().x}get y(){return this.toAffine().y}static normalizeZ(h){const d=n.invertBatch(h.map(y=>y.pz));return h.map((y,v)=>y.toAffine(d[v])).map(f.fromAffine)}static fromHex(h){const d=f.fromAffine(i(nt("pointHex",h)));return d.assertValidity(),d}static fromPrivateKey(h){return f.BASE.multiply(a(h))}_setWindowSize(h){this._WINDOW_SIZE=h,u.delete(this)}assertValidity(){if(this.is0()){if(e.allowInfinityPoint&&!n.is0(this.py))return;throw new Error("bad point: ZERO")}const{x:h,y:d}=this.toAffine();if(!n.isValid(h)||!n.isValid(d))throw new Error("bad point: x or y not FE");const y=n.sqr(d),v=o(h);if(!n.eql(y,v))throw new Error("bad point: equation left != right");if(!this.isTorsionFree())throw new Error("bad point: not in prime-order subgroup")}hasEvenY(){const{y:h}=this.toAffine();if(n.isOdd)return!n.isOdd(h);throw new Error("Field doesn't support isOdd")}equals(h){l(h);const{px:d,py:y,pz:v}=this,{px:S,py:_,pz:B}=h,E=n.eql(n.mul(d,B),n.mul(S,v)),x=n.eql(n.mul(y,B),n.mul(_,v));return E&&x}negate(){return new f(this.px,n.neg(this.py),this.pz)}double(){const{a:h,b:d}=e,y=n.mul(d,Yi),{px:v,py:S,pz:_}=this;let B=n.ZERO,E=n.ZERO,x=n.ZERO,A=n.mul(v,v),q=n.mul(S,S),R=n.mul(_,_),O=n.mul(v,S);return O=n.add(O,O),x=n.mul(v,_),x=n.add(x,x),B=n.mul(h,x),E=n.mul(y,R),E=n.add(B,E),B=n.sub(q,E),E=n.add(q,E),E=n.mul(B,E),B=n.mul(O,B),x=n.mul(y,x),R=n.mul(h,R),O=n.sub(A,R),O=n.mul(h,O),O=n.add(O,x),x=n.add(A,A),A=n.add(x,A),A=n.add(A,R),A=n.mul(A,O),E=n.add(E,A),R=n.mul(S,_),R=n.add(R,R),A=n.mul(R,O),B=n.sub(B,A),x=n.mul(R,q),x=n.add(x,x),x=n.add(x,x),new f(B,E,x)}add(h){l(h);const{px:d,py:y,pz:v}=this,{px:S,py:_,pz:B}=h;let E=n.ZERO,x=n.ZERO,A=n.ZERO;const q=e.a,R=n.mul(e.b,Yi);let O=n.mul(d,S),N=n.mul(y,_),U=n.mul(v,B),j=n.add(d,y),w=n.add(S,_);j=n.mul(j,w),w=n.add(O,N),j=n.sub(j,w),w=n.add(d,v);let m=n.add(S,B);return w=n.mul(w,m),m=n.add(O,U),w=n.sub(w,m),m=n.add(y,v),E=n.add(_,B),m=n.mul(m,E),E=n.add(N,U),m=n.sub(m,E),A=n.mul(q,w),E=n.mul(R,U),A=n.add(E,A),E=n.sub(N,A),A=n.add(N,A),x=n.mul(E,A),N=n.add(O,O),N=n.add(N,O),U=n.mul(q,U),w=n.mul(R,w),N=n.add(N,U),U=n.sub(O,U),U=n.mul(q,U),w=n.add(w,U),O=n.mul(N,w),x=n.add(x,O),O=n.mul(m,w),E=n.mul(j,E),E=n.sub(E,O),O=n.mul(j,N),A=n.mul(m,A),A=n.add(A,O),new f(E,x,A)}subtract(h){return this.add(h.negate())}is0(){return this.equals(f.ZERO)}wNAF(h){return b.wNAFCached(this,u,h,d=>{const y=n.invertBatch(d.map(v=>v.pz));return d.map((v,S)=>v.toAffine(y[S])).map(f.fromAffine)})}multiplyUnsafe(h){const d=f.ZERO;if(h===Pt)return d;if(c(h),h===gt)return this;const{endo:y}=e;if(!y)return b.unsafeLadder(this,h);let{k1neg:v,k1:S,k2neg:_,k2:B}=y.splitScalar(h),E=d,x=d,A=this;for(;S>Pt||B>Pt;)S&gt&&(E=E.add(A)),B&gt&&(x=x.add(A)),A=A.double(),S>>=gt,B>>=gt;return v&&(E=E.negate()),_&&(x=x.negate()),x=new f(n.mul(x.px,y.beta),x.py,x.pz),E.add(x)}multiply(h){c(h);let d=h,y,v;const{endo:S}=e;if(S){const{k1neg:_,k1:B,k2neg:E,k2:x}=S.splitScalar(d);let{p:A,f:q}=this.wNAF(B),{p:R,f:O}=this.wNAF(x);A=b.constTimeNegate(_,A),R=b.constTimeNegate(E,R),R=new f(n.mul(R.px,S.beta),R.py,R.pz),y=A.add(R),v=q.add(O)}else{const{p:_,f:B}=this.wNAF(d);y=_,v=B}return f.normalizeZ([y,v])[0]}multiplyAndAddUnsafe(h,d,y){const v=f.BASE,S=(B,E)=>E===Pt||E===gt||!B.equals(v)?B.multiplyUnsafe(E):B.multiply(E),_=S(this,d).add(S(h,y));return _.is0()?void 0:_}toAffine(h){const{px:d,py:y,pz:v}=this,S=this.is0();h==null&&(h=S?n.ONE:n.inv(v));const _=n.mul(d,h),B=n.mul(y,h),E=n.mul(v,h);if(S)return{x:n.ZERO,y:n.ZERO};if(!n.eql(E,n.ONE))throw new Error("invZ was invalid");return{x:_,y:B}}isTorsionFree(){const{h,isTorsionFree:d}=e;if(h===gt)return!0;if(d)return d(f,this);throw new Error("isTorsionFree() has not been declared for the elliptic curve")}clearCofactor(){const{h,clearCofactor:d}=e;return h===gt?this:d?d(f,this):this.multiplyUnsafe(e.h)}toRawBytes(h=!0){return this.assertValidity(),r(f,this,h)}toHex(h=!0){return Oe(this.toRawBytes(h))}}f.BASE=new f(e.Gx,e.Gy,n.ONE),f.ZERO=new f(n.ZERO,n.ONE,n.ZERO);const p=e.nBitLength,b=ll(f,e.endo?Math.ceil(p/2):p);return{CURVE:e,ProjectivePoint:f,normPrivateKeyToScalar:a,weierstrassEquation:o,isWithinCurveOrder:s}}function gl(t){const e=as(t);return Ge(e,{hash:"hash",hmac:"function",randomBytes:"function"},{bits2int:"function",bits2int_modN:"function",lowS:"boolean"}),Object.freeze({lowS:!0,...e})}function yl(t){const e=gl(t),{Fp:n,n:r}=e,i=n.BYTES+1,o=2*n.BYTES+1;function s(w){return Pt<w&&w<n.ORDER}function c(w){return J(w,r)}function a(w){return yr(w,r)}const{ProjectivePoint:u,normPrivateKeyToScalar:l,weierstrassEquation:f,isWithinCurveOrder:p}=pl({...e,toBytes(w,m,$){const I=m.toAffine(),T=n.toBytes(I.x),L=de;return $?L(Uint8Array.from([m.hasEvenY()?2:3]),T):L(Uint8Array.from([4]),T,n.toBytes(I.y))},fromBytes(w){const m=w.length,$=w[0],I=w.subarray(1);if(m===i&&($===2||$===3)){const T=ct(I);if(!s(T))throw new Error("Point is not on curve");const L=f(T);let C;try{C=n.sqrt(L)}catch(z){const G=z instanceof Error?": "+z.message:"";throw new Error("Point is not on curve"+G)}const P=(C&gt)===gt;return($&1)===1!==P&&(C=n.neg(C)),{x:T,y:C}}else if(m===o&&$===4){const T=n.fromBytes(I.subarray(0,n.BYTES)),L=n.fromBytes(I.subarray(n.BYTES,2*n.BYTES));return{x:T,y:L}}else throw new Error(`Point of length ${m} was invalid. Expected ${i} compressed bytes or ${o} uncompressed bytes`)}}),b=w=>Oe(re(w,e.nByteLength));function g(w){const m=r>>gt;return w>m}function h(w){return g(w)?c(-w):w}const d=(w,m,$)=>ct(w.slice(m,$));class y{constructor(m,$,I){this.r=m,this.s=$,this.recovery=I,this.assertValidity()}static fromCompact(m){const $=e.nByteLength;return m=nt("compactSignature",m,$*2),new y(d(m,0,$),d(m,$,2*$))}static fromDER(m){const{r:$,s:I}=le.toSig(nt("DER",m));return new y($,I)}assertValidity(){if(!p(this.r))throw new Error("r must be 0 < r < CURVE.n");if(!p(this.s))throw new Error("s must be 0 < s < CURVE.n")}addRecoveryBit(m){return new y(this.r,this.s,m)}recoverPublicKey(m){const{r:$,s:I,recovery:T}=this,L=x(nt("msgHash",m));if(T==null||![0,1,2,3].includes(T))throw new Error("recovery id invalid");const C=T===2||T===3?$+e.n:$;if(C>=n.ORDER)throw new Error("recovery id 2 or 3 invalid");const P=T&1?"03":"02",z=u.fromHex(P+b(C)),G=a(C),at=c(-L*G),wt=c(I*G),et=u.BASE.multiplyAndAddUnsafe(z,at,wt);if(!et)throw new Error("point at infinify");return et.assertValidity(),et}hasHighS(){return g(this.s)}normalizeS(){return this.hasHighS()?new y(this.r,c(-this.s),this.recovery):this}toDERRawBytes(){return _e(this.toDERHex())}toDERHex(){return le.hexFromSig({r:this.r,s:this.s})}toCompactRawBytes(){return _e(this.toCompactHex())}toCompactHex(){return b(this.r)+b(this.s)}}const v={isValidPrivateKey(w){try{return l(w),!0}catch{return!1}},normPrivateKeyToScalar:l,randomPrivateKey:()=>{const w=ss(e.n);return cl(e.randomBytes(w),e.n)},precompute(w=8,m=u.BASE){return m._setWindowSize(w),m.multiply(BigInt(3)),m}};function S(w,m=!0){return u.fromPrivateKey(w).toRawBytes(m)}function _(w){const m=he(w),$=typeof w=="string",I=(m||$)&&w.length;return m?I===i||I===o:$?I===2*i||I===2*o:w instanceof u}function B(w,m,$=!0){if(_(w))throw new Error("first arg must be private key");if(!_(m))throw new Error("second arg must be public key");return u.fromHex(m).multiply(l(w)).toRawBytes($)}const E=e.bits2int||function(w){const m=ct(w),$=w.length*8-e.nBitLength;return $>0?m>>BigInt($):m},x=e.bits2int_modN||function(w){return c(E(w))},A=Mr(e.nBitLength);function q(w){if(typeof w!="bigint")throw new Error("bigint expected");if(!(Pt<=w&&w<A))throw new Error(`bigint expected < 2^${e.nBitLength}`);return re(w,e.nByteLength)}function R(w,m,$=O){if(["recovered","canonical"].some(st=>st in $))throw new Error("sign() legacy options not supported");const{hash:I,randomBytes:T}=e;let{lowS:L,prehash:C,extraEntropy:P}=$;L==null&&(L=!0),w=nt("msgHash",w),C&&(w=nt("prehashed msgHash",I(w)));const z=x(w),G=l(m),at=[q(G),q(z)];if(P!=null&&P!==!1){const st=P===!0?T(n.BYTES):P;at.push(nt("extraEntropy",st))}const wt=de(...at),et=z;function Wt(st){const ht=E(st);if(!p(ht))return;const se=a(ht),V=u.BASE.multiply(ht).toAffine(),ft=c(V.x);if(ft===Pt)return;const Rt=c(se*c(et+ft*G));if(Rt===Pt)return;let Ne=(V.x===ft?0:2)|Number(V.y&gt),Ue=Rt;return L&&g(Rt)&&(Ue=h(Rt),Ne^=1),new y(ft,Ue,Ne)}return{seed:wt,k2sig:Wt}}const O={lowS:e.lowS,prehash:!1},N={lowS:e.lowS,prehash:!1};function U(w,m,$=O){const{seed:I,k2sig:T}=R(w,m,$),L=e;return rs(L.hash.outputLen,L.nByteLength,L.hmac)(I,T)}u.BASE._setWindowSize(8);function j(w,m,$,I=N){var T;const L=w;if(m=nt("msgHash",m),$=nt("publicKey",$),"strict"in I)throw new Error("options.strict was renamed to lowS");const{lowS:C,prehash:P}=I;let z,G;try{if(typeof L=="string"||he(L))try{z=y.fromDER(L)}catch(V){if(!(V instanceof le.Err))throw V;z=y.fromCompact(L)}else if(typeof L=="object"&&typeof L.r=="bigint"&&typeof L.s=="bigint"){const{r:V,s:ft}=L;z=new y(V,ft)}else throw new Error("PARSE");G=u.fromHex($)}catch(V){if(V.message==="PARSE")throw new Error("signature must be Signature instance, Uint8Array or hex string");return!1}if(C&&z.hasHighS())return!1;P&&(m=e.hash(m));const{r:at,s:wt}=z,et=x(m),Wt=a(wt),st=c(et*Wt),ht=c(at*Wt),se=(T=u.BASE.multiplyAndAddUnsafe(G,st,ht))==null?void 0:T.toAffine();return se?c(se.x)===at:!1}return{CURVE:e,getPublicKey:S,getSharedSecret:B,sign:U,verify:j,ProjectivePoint:u,Signature:y,utils:v}}class cs extends Qo{constructor(e,n){super(),this.finished=!1,this.destroyed=!1,Ru(e);const r=Hr(n);if(this.iHash=e.create(),typeof this.iHash.update!="function")throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;const i=this.blockLen,o=new Uint8Array(i);o.set(r.length>i?e.create().update(r).digest():r);for(let s=0;s<o.length;s++)o[s]^=54;this.iHash.update(o),this.oHash=e.create();for(let s=0;s<o.length;s++)o[s]^=106;this.oHash.update(o),o.fill(0)}update(e){return ln(this),this.iHash.update(e),this}digestInto(e){ln(this),We(e,this.outputLen),this.finished=!0,this.iHash.digestInto(e),this.oHash.update(e),this.oHash.digestInto(e),this.destroy()}digest(){const e=new Uint8Array(this.oHash.outputLen);return this.digestInto(e),e}_cloneInto(e){e||(e=Object.create(Object.getPrototypeOf(this),{}));const{oHash:n,iHash:r,finished:i,destroyed:o,blockLen:s,outputLen:c}=this;return e=e,e.finished=i,e.destroyed=o,e.blockLen=s,e.outputLen=c,e.oHash=n._cloneInto(e.oHash),e.iHash=r._cloneInto(e.iHash),e}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}}const us=(t,e,n)=>new cs(t,e).update(n).digest();us.create=(t,e)=>new cs(t,e);function bl(t){return{hash:t,hmac:(e,...n)=>us(t,e,Uu(...n)),randomBytes:ts}}function wl(t,e){const n=r=>yl({...t,...bl(r)});return Object.freeze({...n(e),create:n})}const $n=BigInt("0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffefffffc2f"),dn=BigInt("0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141"),ls=BigInt(1),pn=BigInt(2),Xi=(t,e)=>(t+e/pn)/e;function fs(t){const e=$n,n=BigInt(3),r=BigInt(6),i=BigInt(11),o=BigInt(22),s=BigInt(23),c=BigInt(44),a=BigInt(88),u=t*t*t%e,l=u*u*t%e,f=dt(l,n,e)*l%e,p=dt(f,n,e)*l%e,b=dt(p,pn,e)*u%e,g=dt(b,i,e)*b%e,h=dt(g,o,e)*g%e,d=dt(h,c,e)*h%e,y=dt(d,a,e)*d%e,v=dt(y,c,e)*h%e,S=dt(v,n,e)*l%e,_=dt(S,s,e)*g%e,B=dt(_,r,e)*u%e,E=dt(B,pn,e);if(!br.eql(br.sqr(E),t))throw new Error("Cannot find square root");return E}const br=al($n,void 0,void 0,{sqrt:fs}),Vr=wl({a:BigInt(0),b:BigInt(7),Fp:br,n:dn,Gx:BigInt("55066263022277343669578718895168534326250603453777594175500187360389116729240"),Gy:BigInt("32670510020758816978083085130507043184471273380659243275938904335757337482424"),h:BigInt(1),lowS:!0,endo:{beta:BigInt("0x7ae96a2b657c07106e64479eac3434e99cf0497512f58995c1396c28719501ee"),splitScalar:t=>{const e=dn,n=BigInt("0x3086d221a7d46bcde86c90e49284eb15"),r=-ls*BigInt("0xe4437ed6010e88286f547fa90abfe4c3"),i=BigInt("0x114ca50f7a8e2f3f657c1108d9d44cfd8"),o=n,s=BigInt("0x100000000000000000000000000000000"),c=Xi(o*t,e),a=Xi(-r*t,e);let u=J(t-c*n-a*i,e),l=J(-c*r-a*o,e);const f=u>s,p=l>s;if(f&&(u=e-u),p&&(l=e-l),u>s||l>s)throw new Error("splitScalar: Endomorphism failed, k="+t);return{k1neg:f,k1:u,k2neg:p,k2:l}}}},hn),Bn=BigInt(0),hs=t=>typeof t=="bigint"&&Bn<t&&t<$n,ml=t=>typeof t=="bigint"&&Bn<t&&t<dn,Ji={};function gn(t,...e){let n=Ji[t];if(n===void 0){const r=hn(Uint8Array.from(t,i=>i.charCodeAt(0)));n=de(r,r),Ji[t]=n}return hn(de(n,...e))}const Fr=t=>t.toRawBytes(!0).slice(1),wr=t=>re(t,32),Gn=t=>J(t,$n),He=t=>J(t,dn),Kr=Vr.ProjectivePoint,vl=(t,e,n)=>Kr.BASE.multiplyAndAddUnsafe(t,e,n);function mr(t){let e=Vr.utils.normPrivateKeyToScalar(t),n=Kr.fromPrivateKey(e);return{scalar:n.hasEvenY()?e:He(-e),bytes:Fr(n)}}function ds(t){if(!hs(t))throw new Error("bad x: need 0 < x < p");const e=Gn(t*t),n=Gn(e*t+BigInt(7));let r=fs(n);r%pn!==Bn&&(r=Gn(-r));const i=new Kr(t,r,ls);return i.assertValidity(),i}function ps(...t){return He(ct(gn("BIP0340/challenge",...t)))}function El(t){return mr(t).bytes}function xl(t,e,n=ts(32)){const r=nt("message",t),{bytes:i,scalar:o}=mr(e),s=nt("auxRand",n,32),c=wr(o^ct(gn("BIP0340/aux",s))),a=gn("BIP0340/nonce",c,i,r),u=He(ct(a));if(u===Bn)throw new Error("sign failed: k is zero");const{bytes:l,scalar:f}=mr(u),p=ps(l,i,r),b=new Uint8Array(64);if(b.set(l,0),b.set(wr(He(f+p*o)),32),!gs(b,r,i))throw new Error("sign: Invalid signature produced");return b}function gs(t,e,n){const r=nt("signature",t,64),i=nt("message",e),o=nt("publicKey",n,32);try{const s=ds(ct(o)),c=ct(r.subarray(0,32));if(!hs(c))return!1;const a=ct(r.subarray(32,64));if(!ml(a))return!1;const u=ps(wr(c),Fr(s),i),l=vl(s,a,He(-u));return!(!l||!l.hasEvenY()||l.toAffine().x!==c)}catch{return!1}}const Yn={getPublicKey:El,sign:xl,verify:gs,utils:{randomPrivateKey:Vr.utils.randomPrivateKey,lift_x:ds,pointToBytes:Fr,numberToBytesBE:re,bytesToNumberBE:ct,taggedHash:gn,mod:J}};function Sl(t){return t instanceof Uint8Array||t!=null&&typeof t=="object"&&t.constructor.name==="Uint8Array"}function Al(...t){const e=o=>o,n=(o,s)=>c=>o(s(c)),r=t.map(o=>o.encode).reduceRight(n,e),i=t.map(o=>o.decode).reduce(n,e);return{encode:r,decode:i}}function $l(t){return{encode:e=>{if(!Array.isArray(e)||e.length&&typeof e[0]!="number")throw new Error("alphabet.encode input should be an array of numbers");return e.map(n=>{if(n<0||n>=t.length)throw new Error(`Digit index outside alphabet: ${n} (alphabet: ${t.length})`);return t[n]})},decode:e=>{if(!Array.isArray(e)||e.length&&typeof e[0]!="string")throw new Error("alphabet.decode input should be array of strings");return e.map(n=>{if(typeof n!="string")throw new Error(`alphabet.decode: not string element=${n}`);const r=t.indexOf(n);if(r===-1)throw new Error(`Unknown letter: "${n}". Allowed: ${t}`);return r})}}}function Bl(t=""){if(typeof t!="string")throw new Error("join separator should be string");return{encode:e=>{if(!Array.isArray(e)||e.length&&typeof e[0]!="string")throw new Error("join.encode input should be array of strings");for(let n of e)if(typeof n!="string")throw new Error(`join.encode: non-string input=${n}`);return e.join(t)},decode:e=>{if(typeof e!="string")throw new Error("join.decode input should be string");return e.split(t)}}}const ys=(t,e)=>e?ys(e,t%e):t,yn=(t,e)=>t+(e-ys(t,e));function vr(t,e,n,r){if(!Array.isArray(t))throw new Error("convertRadix2: data should be array");if(e<=0||e>32)throw new Error(`convertRadix2: wrong from=${e}`);if(n<=0||n>32)throw new Error(`convertRadix2: wrong to=${n}`);if(yn(e,n)>32)throw new Error(`convertRadix2: carry overflow from=${e} to=${n} carryBits=${yn(e,n)}`);let i=0,o=0;const s=2**n-1,c=[];for(const a of t){if(a>=2**e)throw new Error(`convertRadix2: invalid data word=${a} from=${e}`);if(i=i<<e|a,o+e>32)throw new Error(`convertRadix2: carry overflow pos=${o} from=${e}`);for(o+=e;o>=n;o-=n)c.push((i>>o-n&s)>>>0);i&=2**o-1}if(i=i<<n-o&s,!r&&o>=e)throw new Error("Excess padding");if(!r&&i)throw new Error(`Non-zero padding: ${i}`);return r&&o>0&&c.push(i>>>0),c}function Ol(t,e=!1){if(yn(8,t)>32||yn(t,8)>32)throw new Error("radix2: carry overflow");return{encode:n=>{if(!Sl(n))throw new Error("radix2.encode input should be Uint8Array");return vr(Array.from(n),8,t,!e)},decode:n=>{if(!Array.isArray(n)||n.length&&typeof n[0]!="number")throw new Error("radix2.decode input should be array of numbers");return Uint8Array.from(vr(n,t,8,e))}}}function Qi(t){if(typeof t!="function")throw new Error("unsafeWrapper fn should be function");return function(...e){try{return t.apply(null,e)}catch{}}}const Er=Al($l("qpzry9x8gf2tvdw0s3jn54khce6mua7l"),Bl("")),to=[996825010,642813549,513874426,1027748829,705979059];function Pe(t){const e=t>>25;let n=(t&33554431)<<5;for(let r=0;r<to.length;r++)(e>>r&1)===1&&(n^=to[r]);return n}function eo(t,e,n=1){const r=t.length;let i=1;for(let o=0;o<r;o++){const s=t.charCodeAt(o);if(s<33||s>126)throw new Error(`Invalid prefix (${t})`);i=Pe(i)^s>>5}i=Pe(i);for(let o=0;o<r;o++)i=Pe(i)^t.charCodeAt(o)&31;for(let o of e)i=Pe(i)^o;for(let o=0;o<6;o++)i=Pe(i);return i^=n,Er.encode(vr([i%2**30],30,5,!1))}function _l(t){const n=Ol(5),r=n.decode,i=n.encode,o=Qi(r);function s(l,f,p=90){if(typeof l!="string")throw new Error(`bech32.encode prefix should be string, not ${typeof l}`);if(!Array.isArray(f)||f.length&&typeof f[0]!="number")throw new Error(`bech32.encode words should be array of numbers, not ${typeof f}`);if(l.length===0)throw new TypeError(`Invalid prefix length ${l.length}`);const b=l.length+7+f.length;if(p!==!1&&b>p)throw new TypeError(`Length ${b} exceeds limit ${p}`);const g=l.toLowerCase(),h=eo(g,f,1);return`${g}1${Er.encode(f)}${h}`}function c(l,f=90){if(typeof l!="string")throw new Error(`bech32.decode input should be string, not ${typeof l}`);if(l.length<8||f!==!1&&l.length>f)throw new TypeError(`Wrong string length: ${l.length} (${l}). Expected (8..${f})`);const p=l.toLowerCase();if(l!==p&&l!==l.toUpperCase())throw new Error("String must be lowercase or uppercase");const b=p.lastIndexOf("1");if(b===0||b===-1)throw new Error('Letter "1" must be present between prefix and data only');const g=p.slice(0,b),h=p.slice(b+1);if(h.length<6)throw new Error("Data must be at least 6 characters long");const d=Er.decode(h).slice(0,-6),y=eo(g,d,1);if(!h.endsWith(y))throw new Error(`Invalid checksum in ${l}: expected "${y}"`);return{prefix:g,words:d}}const a=Qi(c);function u(l){const{prefix:f,words:p}=c(l,!1);return{prefix:f,words:p,bytes:r(p)}}return{encode:s,decode:c,decodeToBytes:u,decodeUnsafe:a,fromWords:r,fromWordsUnsafe:o,toWords:i}}const no=_l(),Il=new TextEncoder;function kl(t){return fn(hn(Il.encode(t)))}const Wr={sign:(t,e)=>fn(Yn.sign(t,e)),verify:Yn.verify,getPublicKey:t=>fn(Yn.getPublicKey(t))};function Rl(t){return Wr.getPublicKey(t)}function bs(t){const e=JSON.stringify([0,t.pubkey,t.created_at,t.kind,t.tags,t.content]);return kl(e)}function Tl(t,e){return Wr.sign(t,e)}function Ll(t){try{return Wr.verify(t.sig,bs(t),t.pubkey)}catch(e){return console.warn("The following error occurred during verify():",e),!1}}function Nl(t){const{words:e}=no.decode(t),n=new Uint8Array(no.fromWords(e));return fn(n)}function ry(t,e){const n=t.startsWith("nsec1")?Nl(t):t,r=Rl(n);return{async signEvent(i){const o={...i,pubkey:i.pubkey??r,tags:[...i.tags??[],...e?.tags??[]],created_at:i.created_at??Math.floor(Date.now()/1e3)};if(Ul(o))return o;const s=o.id??bs(o),c=o.sig??Tl(s,n);return{...o,id:s,sig:c}},async getPublicKey(){return r}}}function Ul(t){if(typeof t.id!="string"||typeof t.sig!="string"||typeof t.kind!="number"||typeof t.pubkey!="string"||typeof t.content!="string"||typeof t.created_at!="number"||!Array.isArray(t.tags))return!1;for(let e=0;e<t.tags.length;e++){const n=t.tags[e];if(!Array.isArray(n))return!1;for(let r=0;r<n.length;r++)if(typeof n[r]=="object")return!1}return!0}const iy=async t=>Ll(t);function ro(t){if(!Number.isSafeInteger(t)||t<0)throw new Error(`Wrong positive integer: ${t}`)}function ws(t,...e){if(!(t instanceof Uint8Array))throw new Error("Expected Uint8Array");if(e.length>0&&!e.includes(t.length))throw new Error(`Expected Uint8Array of length ${e}, not of length=${t.length}`)}function Cl(t){if(typeof t!="function"||typeof t.create!="function")throw new Error("Hash should be wrapped by utils.wrapConstructor");ro(t.outputLen),ro(t.blockLen)}function bn(t,e=!0){if(t.destroyed)throw new Error("Hash instance has been destroyed");if(e&&t.finished)throw new Error("Hash#digest() has already been called")}function Pl(t,e){ws(t);const n=e.outputLen;if(t.length<n)throw new Error(`digestInto() expects output buffer of length at least ${n}`)}const Xn=typeof globalThis=="object"&&"crypto"in globalThis?globalThis.crypto:void 0;const ms=t=>t instanceof Uint8Array,Jn=t=>new DataView(t.buffer,t.byteOffset,t.byteLength),Et=(t,e)=>t<<32-e|t>>>e,ql=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;if(!ql)throw new Error("Non little-endian hardware is not supported");function Hl(t){if(typeof t!="string")throw new Error(`utf8ToBytes expected string, got ${typeof t}`);return new Uint8Array(new TextEncoder().encode(t))}function Zr(t){if(typeof t=="string"&&(t=Hl(t)),!ms(t))throw new Error(`expected Uint8Array, got ${typeof t}`);return t}function jl(...t){const e=new Uint8Array(t.reduce((r,i)=>r+i.length,0));let n=0;return t.forEach(r=>{if(!ms(r))throw new Error("Uint8Array expected");e.set(r,n),n+=r.length}),e}let vs=class{clone(){return this._cloneInto()}};function zl(t){const e=r=>t().update(Zr(r)).digest(),n=t();return e.outputLen=n.outputLen,e.blockLen=n.blockLen,e.create=()=>t(),e}function Es(t=32){if(Xn&&typeof Xn.getRandomValues=="function")return Xn.getRandomValues(new Uint8Array(t));throw new Error("crypto.getRandomValues must be defined")}function Dl(t,e,n,r){if(typeof t.setBigUint64=="function")return t.setBigUint64(e,n,r);const i=BigInt(32),o=BigInt(4294967295),s=Number(n>>i&o),c=Number(n&o),a=r?4:0,u=r?0:4;t.setUint32(e+a,s,r),t.setUint32(e+u,c,r)}let Ml=class extends vs{constructor(e,n,r,i){super(),this.blockLen=e,this.outputLen=n,this.padOffset=r,this.isLE=i,this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.buffer=new Uint8Array(e),this.view=Jn(this.buffer)}update(e){bn(this);const{view:n,buffer:r,blockLen:i}=this;e=Zr(e);const o=e.length;for(let s=0;s<o;){const c=Math.min(i-this.pos,o-s);if(c===i){const a=Jn(e);for(;i<=o-s;s+=i)this.process(a,s);continue}r.set(e.subarray(s,s+c),this.pos),this.pos+=c,s+=c,this.pos===i&&(this.process(n,0),this.pos=0)}return this.length+=e.length,this.roundClean(),this}digestInto(e){bn(this),Pl(e,this),this.finished=!0;const{buffer:n,view:r,blockLen:i,isLE:o}=this;let{pos:s}=this;n[s++]=128,this.buffer.subarray(s).fill(0),this.padOffset>i-s&&(this.process(r,0),s=0);for(let f=s;f<i;f++)n[f]=0;Dl(r,i-8,BigInt(this.length*8),o),this.process(r,0);const c=Jn(e),a=this.outputLen;if(a%4)throw new Error("_sha2: outputLen should be aligned to 32bit");const u=a/4,l=this.get();if(u>l.length)throw new Error("_sha2: outputLen bigger than state");for(let f=0;f<u;f++)c.setUint32(4*f,l[f],o)}digest(){const{buffer:e,outputLen:n}=this;this.digestInto(e);const r=e.slice(0,n);return this.destroy(),r}_cloneInto(e){e||(e=new this.constructor),e.set(...this.get());const{blockLen:n,buffer:r,length:i,finished:o,destroyed:s,pos:c}=this;return e.length=i,e.pos=c,e.finished=o,e.destroyed=s,i%n&&e.buffer.set(r),e}};const Vl=(t,e,n)=>t&e^~t&n,Fl=(t,e,n)=>t&e^t&n^e&n,Kl=new Uint32Array([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),Yt=new Uint32Array([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),Xt=new Uint32Array(64);let Wl=class extends Ml{constructor(){super(64,32,8,!1),this.A=Yt[0]|0,this.B=Yt[1]|0,this.C=Yt[2]|0,this.D=Yt[3]|0,this.E=Yt[4]|0,this.F=Yt[5]|0,this.G=Yt[6]|0,this.H=Yt[7]|0}get(){const{A:e,B:n,C:r,D:i,E:o,F:s,G:c,H:a}=this;return[e,n,r,i,o,s,c,a]}set(e,n,r,i,o,s,c,a){this.A=e|0,this.B=n|0,this.C=r|0,this.D=i|0,this.E=o|0,this.F=s|0,this.G=c|0,this.H=a|0}process(e,n){for(let f=0;f<16;f++,n+=4)Xt[f]=e.getUint32(n,!1);for(let f=16;f<64;f++){const p=Xt[f-15],b=Xt[f-2],g=Et(p,7)^Et(p,18)^p>>>3,h=Et(b,17)^Et(b,19)^b>>>10;Xt[f]=h+Xt[f-7]+g+Xt[f-16]|0}let{A:r,B:i,C:o,D:s,E:c,F:a,G:u,H:l}=this;for(let f=0;f<64;f++){const p=Et(c,6)^Et(c,11)^Et(c,25),b=l+p+Vl(c,a,u)+Kl[f]+Xt[f]|0,h=(Et(r,2)^Et(r,13)^Et(r,22))+Fl(r,i,o)|0;l=u,u=a,a=c,c=s+b|0,s=o,o=i,i=r,r=b+h|0}r=r+this.A|0,i=i+this.B|0,o=o+this.C|0,s=s+this.D|0,c=c+this.E|0,a=a+this.F|0,u=u+this.G|0,l=l+this.H|0,this.set(r,i,o,s,c,a,u,l)}roundClean(){Xt.fill(0)}destroy(){this.set(0,0,0,0,0,0,0,0),this.buffer.fill(0)}};const xr=zl(()=>new Wl);const xs=BigInt(0),On=BigInt(1),Zl=BigInt(2),_n=t=>t instanceof Uint8Array,Gl=Array.from({length:256},(t,e)=>e.toString(16).padStart(2,"0"));function Ie(t){if(!_n(t))throw new Error("Uint8Array expected");let e="";for(let n=0;n<t.length;n++)e+=Gl[t[n]];return e}function Ss(t){const e=t.toString(16);return e.length&1?`0${e}`:e}function Gr(t){if(typeof t!="string")throw new Error("hex string expected, got "+typeof t);return BigInt(t===""?"0":`0x${t}`)}function ke(t){if(typeof t!="string")throw new Error("hex string expected, got "+typeof t);const e=t.length;if(e%2)throw new Error("padded hex string expected, got unpadded hex of length "+e);const n=new Uint8Array(e/2);for(let r=0;r<n.length;r++){const i=r*2,o=t.slice(i,i+2),s=Number.parseInt(o,16);if(Number.isNaN(s)||s<0)throw new Error("Invalid byte sequence");n[r]=s}return n}function ut(t){return Gr(Ie(t))}function Yr(t){if(!_n(t))throw new Error("Uint8Array expected");return Gr(Ie(Uint8Array.from(t).reverse()))}function ie(t,e){return ke(t.toString(16).padStart(e*2,"0"))}function Xr(t,e){return ie(t,e).reverse()}function Yl(t){return ke(Ss(t))}function rt(t,e,n){let r;if(typeof e=="string")try{r=ke(e)}catch(o){throw new Error(`${t} must be valid hex string, got "${e}". Cause: ${o}`)}else if(_n(e))r=Uint8Array.from(e);else throw new Error(`${t} must be hex string or Uint8Array`);const i=r.length;if(typeof n=="number"&&i!==n)throw new Error(`${t} expected ${n} bytes, got ${i}`);return r}function pe(...t){const e=new Uint8Array(t.reduce((r,i)=>r+i.length,0));let n=0;return t.forEach(r=>{if(!_n(r))throw new Error("Uint8Array expected");e.set(r,n),n+=r.length}),e}function Xl(t,e){if(t.length!==e.length)return!1;for(let n=0;n<t.length;n++)if(t[n]!==e[n])return!1;return!0}function Jl(t){if(typeof t!="string")throw new Error(`utf8ToBytes expected string, got ${typeof t}`);return new Uint8Array(new TextEncoder().encode(t))}function Ql(t){let e;for(e=0;t>xs;t>>=On,e+=1);return e}function tf(t,e){return t>>BigInt(e)&On}const ef=(t,e,n)=>t|(n?On:xs)<<BigInt(e),Jr=t=>(Zl<<BigInt(t-1))-On,Qn=t=>new Uint8Array(t),io=t=>Uint8Array.from(t);function As(t,e,n){if(typeof t!="number"||t<2)throw new Error("hashLen must be a number");if(typeof e!="number"||e<2)throw new Error("qByteLen must be a number");if(typeof n!="function")throw new Error("hmacFn must be a function");let r=Qn(t),i=Qn(t),o=0;const s=()=>{r.fill(1),i.fill(0),o=0},c=(...f)=>n(i,r,...f),a=(f=Qn())=>{i=c(io([0]),f),r=c(),f.length!==0&&(i=c(io([1]),f),r=c())},u=()=>{if(o++>=1e3)throw new Error("drbg: tried 1000 values");let f=0;const p=[];for(;f<e;){r=c();const b=r.slice();p.push(b),f+=r.length}return pe(...p)};return(f,p)=>{s(),a(f);let b;for(;!(b=p(u()));)a();return s(),b}}const nf={bigint:t=>typeof t=="bigint",function:t=>typeof t=="function",boolean:t=>typeof t=="boolean",string:t=>typeof t=="string",stringOrUint8Array:t=>typeof t=="string"||t instanceof Uint8Array,isSafeInteger:t=>Number.isSafeInteger(t),array:t=>Array.isArray(t),field:(t,e)=>e.Fp.isValid(t),hash:t=>typeof t=="function"&&Number.isSafeInteger(t.outputLen)};function Ye(t,e,n={}){const r=(i,o,s)=>{const c=nf[o];if(typeof c!="function")throw new Error(`Invalid validator "${o}", expected function`);const a=t[i];if(!(s&&a===void 0)&&!c(a,t))throw new Error(`Invalid param ${String(i)}=${a} (${typeof a}), expected ${o}`)};for(const[i,o]of Object.entries(e))r(i,o,!1);for(const[i,o]of Object.entries(n))r(i,o,!0);return t}const rf=Object.freeze(Object.defineProperty({__proto__:null,bitGet:tf,bitLen:Ql,bitMask:Jr,bitSet:ef,bytesToHex:Ie,bytesToNumberBE:ut,bytesToNumberLE:Yr,concatBytes:pe,createHmacDrbg:As,ensureBytes:rt,equalBytes:Xl,hexToBytes:ke,hexToNumber:Gr,numberToBytesBE:ie,numberToBytesLE:Xr,numberToHexUnpadded:Ss,numberToVarBytesBE:Yl,utf8ToBytes:Jl,validateObject:Ye},Symbol.toStringTag,{value:"Module"}));const X=BigInt(0),W=BigInt(1),ue=BigInt(2),of=BigInt(3),Sr=BigInt(4),oo=BigInt(5),so=BigInt(8);BigInt(9);BigInt(16);function Q(t,e){const n=t%e;return n>=X?n:e+n}function sf(t,e,n){if(n<=X||e<X)throw new Error("Expected power/modulo > 0");if(n===W)return X;let r=W;for(;e>X;)e&W&&(r=r*t%n),t=t*t%n,e>>=W;return r}function pt(t,e,n){let r=t;for(;e-- >X;)r*=r,r%=n;return r}function Ar(t,e){if(t===X||e<=X)throw new Error(`invert: expected positive integers, got n=${t} mod=${e}`);let n=Q(t,e),r=e,i=X,o=W;for(;n!==X;){const c=r/n,a=r%n,u=i-o*c;r=n,n=a,i=o,o=u}if(r!==W)throw new Error("invert: does not exist");return Q(i,e)}function af(t){const e=(t-W)/ue;let n,r,i;for(n=t-W,r=0;n%ue===X;n/=ue,r++);for(i=ue;i<t&&sf(i,e,t)!==t-W;i++);if(r===1){const s=(t+W)/Sr;return function(a,u){const l=a.pow(u,s);if(!a.eql(a.sqr(l),u))throw new Error("Cannot find square root");return l}}const o=(n+W)/ue;return function(c,a){if(c.pow(a,e)===c.neg(c.ONE))throw new Error("Cannot find square root");let u=r,l=c.pow(c.mul(c.ONE,i),n),f=c.pow(a,o),p=c.pow(a,n);for(;!c.eql(p,c.ONE);){if(c.eql(p,c.ZERO))return c.ZERO;let b=1;for(let h=c.sqr(p);b<u&&!c.eql(h,c.ONE);b++)h=c.sqr(h);const g=c.pow(l,W<<BigInt(u-b-1));l=c.sqr(g),f=c.mul(f,g),p=c.mul(p,l),u=b}return f}}function cf(t){if(t%Sr===of){const e=(t+W)/Sr;return function(r,i){const o=r.pow(i,e);if(!r.eql(r.sqr(o),i))throw new Error("Cannot find square root");return o}}if(t%so===oo){const e=(t-oo)/so;return function(r,i){const o=r.mul(i,ue),s=r.pow(o,e),c=r.mul(i,s),a=r.mul(r.mul(c,ue),s),u=r.mul(c,r.sub(a,r.ONE));if(!r.eql(r.sqr(u),i))throw new Error("Cannot find square root");return u}}return af(t)}const uf=["create","isValid","is0","neg","inv","sqrt","sqr","eql","add","sub","mul","pow","div","addN","subN","mulN","sqrN"];function lf(t){const e={ORDER:"bigint",MASK:"bigint",BYTES:"isSafeInteger",BITS:"isSafeInteger"},n=uf.reduce((r,i)=>(r[i]="function",r),e);return Ye(t,n)}function ff(t,e,n){if(n<X)throw new Error("Expected power > 0");if(n===X)return t.ONE;if(n===W)return e;let r=t.ONE,i=e;for(;n>X;)n&W&&(r=t.mul(r,i)),i=t.sqr(i),n>>=W;return r}function hf(t,e){const n=new Array(e.length),r=e.reduce((o,s,c)=>t.is0(s)?o:(n[c]=o,t.mul(o,s)),t.ONE),i=t.inv(r);return e.reduceRight((o,s,c)=>t.is0(s)?o:(n[c]=t.mul(o,n[c]),t.mul(o,s)),i),n}function $s(t,e){const n=e!==void 0?e:t.toString(2).length,r=Math.ceil(n/8);return{nBitLength:n,nByteLength:r}}function df(t,e,n=!1,r={}){if(t<=X)throw new Error(`Expected Field ORDER > 0, got ${t}`);const{nBitLength:i,nByteLength:o}=$s(t,e);if(o>2048)throw new Error("Field lengths over 2048 bytes are not supported");const s=cf(t),c=Object.freeze({ORDER:t,BITS:i,BYTES:o,MASK:Jr(i),ZERO:X,ONE:W,create:a=>Q(a,t),isValid:a=>{if(typeof a!="bigint")throw new Error(`Invalid field element: expected bigint, got ${typeof a}`);return X<=a&&a<t},is0:a=>a===X,isOdd:a=>(a&W)===W,neg:a=>Q(-a,t),eql:(a,u)=>a===u,sqr:a=>Q(a*a,t),add:(a,u)=>Q(a+u,t),sub:(a,u)=>Q(a-u,t),mul:(a,u)=>Q(a*u,t),pow:(a,u)=>ff(c,a,u),div:(a,u)=>Q(a*Ar(u,t),t),sqrN:a=>a*a,addN:(a,u)=>a+u,subN:(a,u)=>a-u,mulN:(a,u)=>a*u,inv:a=>Ar(a,t),sqrt:r.sqrt||(a=>s(c,a)),invertBatch:a=>hf(c,a),cmov:(a,u,l)=>l?u:a,toBytes:a=>n?Xr(a,o):ie(a,o),fromBytes:a=>{if(a.length!==o)throw new Error(`Fp.fromBytes: expected ${o}, got ${a.length}`);return n?Yr(a):ut(a)}});return Object.freeze(c)}function Bs(t){if(typeof t!="bigint")throw new Error("field order must be bigint");const e=t.toString(2).length;return Math.ceil(e/8)}function Os(t){const e=Bs(t);return e+Math.ceil(e/2)}function pf(t,e,n=!1){const r=t.length,i=Bs(e),o=Os(e);if(r<16||r<o||r>1024)throw new Error(`expected ${o}-1024 bytes of input, got ${r}`);const s=n?ut(t):Yr(t),c=Q(s,e-W)+W;return n?Xr(c,i):ie(c,i)}const gf=BigInt(0),tr=BigInt(1);function yf(t,e){const n=(i,o)=>{const s=o.negate();return i?s:o},r=i=>{const o=Math.ceil(e/i)+1,s=2**(i-1);return{windows:o,windowSize:s}};return{constTimeNegate:n,unsafeLadder(i,o){let s=t.ZERO,c=i;for(;o>gf;)o&tr&&(s=s.add(c)),c=c.double(),o>>=tr;return s},precomputeWindow(i,o){const{windows:s,windowSize:c}=r(o),a=[];let u=i,l=u;for(let f=0;f<s;f++){l=u,a.push(l);for(let p=1;p<c;p++)l=l.add(u),a.push(l);u=l.double()}return a},wNAF(i,o,s){const{windows:c,windowSize:a}=r(i);let u=t.ZERO,l=t.BASE;const f=BigInt(2**i-1),p=2**i,b=BigInt(i);for(let g=0;g<c;g++){const h=g*a;let d=Number(s&f);s>>=b,d>a&&(d-=p,s+=tr);const y=h,v=h+Math.abs(d)-1,S=g%2!==0,_=d<0;d===0?l=l.add(n(S,o[y])):u=u.add(n(_,o[v]))}return{p:u,f:l}},wNAFCached(i,o,s,c){const a=i._WINDOW_SIZE||1;let u=o.get(i);return u||(u=this.precomputeWindow(i,a),a!==1&&o.set(i,c(u))),this.wNAF(a,u,s)}}}function _s(t){return lf(t.Fp),Ye(t,{n:"bigint",h:"bigint",Gx:"field",Gy:"field"},{nBitLength:"isSafeInteger",nByteLength:"isSafeInteger"}),Object.freeze({...$s(t.n,t.nBitLength),...t,p:t.Fp.ORDER})}function bf(t){const e=_s(t);Ye(e,{a:"field",b:"field"},{allowedPrivateKeyLengths:"array",wrapPrivateKey:"boolean",isTorsionFree:"function",clearCofactor:"function",allowInfinityPoint:"boolean",fromBytes:"function",toBytes:"function"});const{endo:n,Fp:r,a:i}=e;if(n){if(!r.eql(i,r.ZERO))throw new Error("Endomorphism can only be defined for Koblitz curves that have a=0");if(typeof n!="object"||typeof n.beta!="bigint"||typeof n.splitScalar!="function")throw new Error("Expected endomorphism with beta: bigint and splitScalar: function")}return Object.freeze({...e})}const{bytesToNumberBE:wf,hexToBytes:mf}=rf,fe={Err:class extends Error{constructor(e=""){super(e)}},_parseInt(t){const{Err:e}=fe;if(t.length<2||t[0]!==2)throw new e("Invalid signature integer tag");const n=t[1],r=t.subarray(2,n+2);if(!n||r.length!==n)throw new e("Invalid signature integer: wrong length");if(r[0]&128)throw new e("Invalid signature integer: negative");if(r[0]===0&&!(r[1]&128))throw new e("Invalid signature integer: unnecessary leading zero");return{d:wf(r),l:t.subarray(n+2)}},toSig(t){const{Err:e}=fe,n=typeof t=="string"?mf(t):t;if(!(n instanceof Uint8Array))throw new Error("ui8a expected");let r=n.length;if(r<2||n[0]!=48)throw new e("Invalid signature tag");if(n[1]!==r-2)throw new e("Invalid signature: incorrect length");const{d:i,l:o}=fe._parseInt(n.subarray(2)),{d:s,l:c}=fe._parseInt(o);if(c.length)throw new e("Invalid signature: left bytes after parsing");return{r:i,s}},hexFromSig(t){const e=u=>Number.parseInt(u[0],16)&8?"00"+u:u,n=u=>{const l=u.toString(16);return l.length&1?`0${l}`:l},r=e(n(t.s)),i=e(n(t.r)),o=r.length/2,s=i.length/2,c=n(o),a=n(s);return`30${n(s+o+4)}02${a}${i}02${c}${r}`}},qt=BigInt(0),yt=BigInt(1);BigInt(2);const ao=BigInt(3);BigInt(4);function vf(t){const e=bf(t),{Fp:n}=e,r=e.toBytes||((g,h,d)=>{const y=h.toAffine();return pe(Uint8Array.from([4]),n.toBytes(y.x),n.toBytes(y.y))}),i=e.fromBytes||(g=>{const h=g.subarray(1),d=n.fromBytes(h.subarray(0,n.BYTES)),y=n.fromBytes(h.subarray(n.BYTES,2*n.BYTES));return{x:d,y}});function o(g){const{a:h,b:d}=e,y=n.sqr(g),v=n.mul(y,g);return n.add(n.add(v,n.mul(g,h)),d)}if(!n.eql(n.sqr(e.Gy),o(e.Gx)))throw new Error("bad generator point: equation left != right");function s(g){return typeof g=="bigint"&&qt<g&&g<e.n}function c(g){if(!s(g))throw new Error("Expected valid bigint: 0 < bigint < curve.n")}function a(g){const{allowedPrivateKeyLengths:h,nByteLength:d,wrapPrivateKey:y,n:v}=e;if(h&&typeof g!="bigint"){if(g instanceof Uint8Array&&(g=Ie(g)),typeof g!="string"||!h.includes(g.length))throw new Error("Invalid key");g=g.padStart(d*2,"0")}let S;try{S=typeof g=="bigint"?g:ut(rt("private key",g,d))}catch{throw new Error(`private key must be ${d} bytes, hex or bigint, not ${typeof g}`)}return y&&(S=Q(S,v)),c(S),S}const u=new Map;function l(g){if(!(g instanceof f))throw new Error("ProjectivePoint expected")}class f{constructor(h,d,y){if(this.px=h,this.py=d,this.pz=y,h==null||!n.isValid(h))throw new Error("x required");if(d==null||!n.isValid(d))throw new Error("y required");if(y==null||!n.isValid(y))throw new Error("z required")}static fromAffine(h){const{x:d,y}=h||{};if(!h||!n.isValid(d)||!n.isValid(y))throw new Error("invalid affine point");if(h instanceof f)throw new Error("projective point not allowed");const v=S=>n.eql(S,n.ZERO);return v(d)&&v(y)?f.ZERO:new f(d,y,n.ONE)}get x(){return this.toAffine().x}get y(){return this.toAffine().y}static normalizeZ(h){const d=n.invertBatch(h.map(y=>y.pz));return h.map((y,v)=>y.toAffine(d[v])).map(f.fromAffine)}static fromHex(h){const d=f.fromAffine(i(rt("pointHex",h)));return d.assertValidity(),d}static fromPrivateKey(h){return f.BASE.multiply(a(h))}_setWindowSize(h){this._WINDOW_SIZE=h,u.delete(this)}assertValidity(){if(this.is0()){if(e.allowInfinityPoint&&!n.is0(this.py))return;throw new Error("bad point: ZERO")}const{x:h,y:d}=this.toAffine();if(!n.isValid(h)||!n.isValid(d))throw new Error("bad point: x or y not FE");const y=n.sqr(d),v=o(h);if(!n.eql(y,v))throw new Error("bad point: equation left != right");if(!this.isTorsionFree())throw new Error("bad point: not in prime-order subgroup")}hasEvenY(){const{y:h}=this.toAffine();if(n.isOdd)return!n.isOdd(h);throw new Error("Field doesn't support isOdd")}equals(h){l(h);const{px:d,py:y,pz:v}=this,{px:S,py:_,pz:B}=h,E=n.eql(n.mul(d,B),n.mul(S,v)),x=n.eql(n.mul(y,B),n.mul(_,v));return E&&x}negate(){return new f(this.px,n.neg(this.py),this.pz)}double(){const{a:h,b:d}=e,y=n.mul(d,ao),{px:v,py:S,pz:_}=this;let B=n.ZERO,E=n.ZERO,x=n.ZERO,A=n.mul(v,v),q=n.mul(S,S),R=n.mul(_,_),O=n.mul(v,S);return O=n.add(O,O),x=n.mul(v,_),x=n.add(x,x),B=n.mul(h,x),E=n.mul(y,R),E=n.add(B,E),B=n.sub(q,E),E=n.add(q,E),E=n.mul(B,E),B=n.mul(O,B),x=n.mul(y,x),R=n.mul(h,R),O=n.sub(A,R),O=n.mul(h,O),O=n.add(O,x),x=n.add(A,A),A=n.add(x,A),A=n.add(A,R),A=n.mul(A,O),E=n.add(E,A),R=n.mul(S,_),R=n.add(R,R),A=n.mul(R,O),B=n.sub(B,A),x=n.mul(R,q),x=n.add(x,x),x=n.add(x,x),new f(B,E,x)}add(h){l(h);const{px:d,py:y,pz:v}=this,{px:S,py:_,pz:B}=h;let E=n.ZERO,x=n.ZERO,A=n.ZERO;const q=e.a,R=n.mul(e.b,ao);let O=n.mul(d,S),N=n.mul(y,_),U=n.mul(v,B),j=n.add(d,y),w=n.add(S,_);j=n.mul(j,w),w=n.add(O,N),j=n.sub(j,w),w=n.add(d,v);let m=n.add(S,B);return w=n.mul(w,m),m=n.add(O,U),w=n.sub(w,m),m=n.add(y,v),E=n.add(_,B),m=n.mul(m,E),E=n.add(N,U),m=n.sub(m,E),A=n.mul(q,w),E=n.mul(R,U),A=n.add(E,A),E=n.sub(N,A),A=n.add(N,A),x=n.mul(E,A),N=n.add(O,O),N=n.add(N,O),U=n.mul(q,U),w=n.mul(R,w),N=n.add(N,U),U=n.sub(O,U),U=n.mul(q,U),w=n.add(w,U),O=n.mul(N,w),x=n.add(x,O),O=n.mul(m,w),E=n.mul(j,E),E=n.sub(E,O),O=n.mul(j,N),A=n.mul(m,A),A=n.add(A,O),new f(E,x,A)}subtract(h){return this.add(h.negate())}is0(){return this.equals(f.ZERO)}wNAF(h){return b.wNAFCached(this,u,h,d=>{const y=n.invertBatch(d.map(v=>v.pz));return d.map((v,S)=>v.toAffine(y[S])).map(f.fromAffine)})}multiplyUnsafe(h){const d=f.ZERO;if(h===qt)return d;if(c(h),h===yt)return this;const{endo:y}=e;if(!y)return b.unsafeLadder(this,h);let{k1neg:v,k1:S,k2neg:_,k2:B}=y.splitScalar(h),E=d,x=d,A=this;for(;S>qt||B>qt;)S&yt&&(E=E.add(A)),B&yt&&(x=x.add(A)),A=A.double(),S>>=yt,B>>=yt;return v&&(E=E.negate()),_&&(x=x.negate()),x=new f(n.mul(x.px,y.beta),x.py,x.pz),E.add(x)}multiply(h){c(h);let d=h,y,v;const{endo:S}=e;if(S){const{k1neg:_,k1:B,k2neg:E,k2:x}=S.splitScalar(d);let{p:A,f:q}=this.wNAF(B),{p:R,f:O}=this.wNAF(x);A=b.constTimeNegate(_,A),R=b.constTimeNegate(E,R),R=new f(n.mul(R.px,S.beta),R.py,R.pz),y=A.add(R),v=q.add(O)}else{const{p:_,f:B}=this.wNAF(d);y=_,v=B}return f.normalizeZ([y,v])[0]}multiplyAndAddUnsafe(h,d,y){const v=f.BASE,S=(B,E)=>E===qt||E===yt||!B.equals(v)?B.multiplyUnsafe(E):B.multiply(E),_=S(this,d).add(S(h,y));return _.is0()?void 0:_}toAffine(h){const{px:d,py:y,pz:v}=this,S=this.is0();h==null&&(h=S?n.ONE:n.inv(v));const _=n.mul(d,h),B=n.mul(y,h),E=n.mul(v,h);if(S)return{x:n.ZERO,y:n.ZERO};if(!n.eql(E,n.ONE))throw new Error("invZ was invalid");return{x:_,y:B}}isTorsionFree(){const{h,isTorsionFree:d}=e;if(h===yt)return!0;if(d)return d(f,this);throw new Error("isTorsionFree() has not been declared for the elliptic curve")}clearCofactor(){const{h,clearCofactor:d}=e;return h===yt?this:d?d(f,this):this.multiplyUnsafe(e.h)}toRawBytes(h=!0){return this.assertValidity(),r(f,this,h)}toHex(h=!0){return Ie(this.toRawBytes(h))}}f.BASE=new f(e.Gx,e.Gy,n.ONE),f.ZERO=new f(n.ZERO,n.ONE,n.ZERO);const p=e.nBitLength,b=yf(f,e.endo?Math.ceil(p/2):p);return{CURVE:e,ProjectivePoint:f,normPrivateKeyToScalar:a,weierstrassEquation:o,isWithinCurveOrder:s}}function Ef(t){const e=_s(t);return Ye(e,{hash:"hash",hmac:"function",randomBytes:"function"},{bits2int:"function",bits2int_modN:"function",lowS:"boolean"}),Object.freeze({lowS:!0,...e})}function xf(t){const e=Ef(t),{Fp:n,n:r}=e,i=n.BYTES+1,o=2*n.BYTES+1;function s(w){return qt<w&&w<n.ORDER}function c(w){return Q(w,r)}function a(w){return Ar(w,r)}const{ProjectivePoint:u,normPrivateKeyToScalar:l,weierstrassEquation:f,isWithinCurveOrder:p}=vf({...e,toBytes(w,m,$){const I=m.toAffine(),T=n.toBytes(I.x),L=pe;return $?L(Uint8Array.from([m.hasEvenY()?2:3]),T):L(Uint8Array.from([4]),T,n.toBytes(I.y))},fromBytes(w){const m=w.length,$=w[0],I=w.subarray(1);if(m===i&&($===2||$===3)){const T=ut(I);if(!s(T))throw new Error("Point is not on curve");const L=f(T);let C=n.sqrt(L);const P=(C&yt)===yt;return($&1)===1!==P&&(C=n.neg(C)),{x:T,y:C}}else if(m===o&&$===4){const T=n.fromBytes(I.subarray(0,n.BYTES)),L=n.fromBytes(I.subarray(n.BYTES,2*n.BYTES));return{x:T,y:L}}else throw new Error(`Point of length ${m} was invalid. Expected ${i} compressed bytes or ${o} uncompressed bytes`)}}),b=w=>Ie(ie(w,e.nByteLength));function g(w){const m=r>>yt;return w>m}function h(w){return g(w)?c(-w):w}const d=(w,m,$)=>ut(w.slice(m,$));class y{constructor(m,$,I){this.r=m,this.s=$,this.recovery=I,this.assertValidity()}static fromCompact(m){const $=e.nByteLength;return m=rt("compactSignature",m,$*2),new y(d(m,0,$),d(m,$,2*$))}static fromDER(m){const{r:$,s:I}=fe.toSig(rt("DER",m));return new y($,I)}assertValidity(){if(!p(this.r))throw new Error("r must be 0 < r < CURVE.n");if(!p(this.s))throw new Error("s must be 0 < s < CURVE.n")}addRecoveryBit(m){return new y(this.r,this.s,m)}recoverPublicKey(m){const{r:$,s:I,recovery:T}=this,L=x(rt("msgHash",m));if(T==null||![0,1,2,3].includes(T))throw new Error("recovery id invalid");const C=T===2||T===3?$+e.n:$;if(C>=n.ORDER)throw new Error("recovery id 2 or 3 invalid");const P=(T&1)===0?"02":"03",z=u.fromHex(P+b(C)),G=a(C),at=c(-L*G),wt=c(I*G),et=u.BASE.multiplyAndAddUnsafe(z,at,wt);if(!et)throw new Error("point at infinify");return et.assertValidity(),et}hasHighS(){return g(this.s)}normalizeS(){return this.hasHighS()?new y(this.r,c(-this.s),this.recovery):this}toDERRawBytes(){return ke(this.toDERHex())}toDERHex(){return fe.hexFromSig({r:this.r,s:this.s})}toCompactRawBytes(){return ke(this.toCompactHex())}toCompactHex(){return b(this.r)+b(this.s)}}const v={isValidPrivateKey(w){try{return l(w),!0}catch{return!1}},normPrivateKeyToScalar:l,randomPrivateKey:()=>{const w=Os(e.n);return pf(e.randomBytes(w),e.n)},precompute(w=8,m=u.BASE){return m._setWindowSize(w),m.multiply(BigInt(3)),m}};function S(w,m=!0){return u.fromPrivateKey(w).toRawBytes(m)}function _(w){const m=w instanceof Uint8Array,$=typeof w=="string",I=(m||$)&&w.length;return m?I===i||I===o:$?I===2*i||I===2*o:w instanceof u}function B(w,m,$=!0){if(_(w))throw new Error("first arg must be private key");if(!_(m))throw new Error("second arg must be public key");return u.fromHex(m).multiply(l(w)).toRawBytes($)}const E=e.bits2int||function(w){const m=ut(w),$=w.length*8-e.nBitLength;return $>0?m>>BigInt($):m},x=e.bits2int_modN||function(w){return c(E(w))},A=Jr(e.nBitLength);function q(w){if(typeof w!="bigint")throw new Error("bigint expected");if(!(qt<=w&&w<A))throw new Error(`bigint expected < 2^${e.nBitLength}`);return ie(w,e.nByteLength)}function R(w,m,$=O){if(["recovered","canonical"].some(st=>st in $))throw new Error("sign() legacy options not supported");const{hash:I,randomBytes:T}=e;let{lowS:L,prehash:C,extraEntropy:P}=$;L==null&&(L=!0),w=rt("msgHash",w),C&&(w=rt("prehashed msgHash",I(w)));const z=x(w),G=l(m),at=[q(G),q(z)];if(P!=null){const st=P===!0?T(n.BYTES):P;at.push(rt("extraEntropy",st))}const wt=pe(...at),et=z;function Wt(st){const ht=E(st);if(!p(ht))return;const se=a(ht),V=u.BASE.multiply(ht).toAffine(),ft=c(V.x);if(ft===qt)return;const Rt=c(se*c(et+ft*G));if(Rt===qt)return;let Ne=(V.x===ft?0:2)|Number(V.y&yt),Ue=Rt;return L&&g(Rt)&&(Ue=h(Rt),Ne^=1),new y(ft,Ue,Ne)}return{seed:wt,k2sig:Wt}}const O={lowS:e.lowS,prehash:!1},N={lowS:e.lowS,prehash:!1};function U(w,m,$=O){const{seed:I,k2sig:T}=R(w,m,$),L=e;return As(L.hash.outputLen,L.nByteLength,L.hmac)(I,T)}u.BASE._setWindowSize(8);function j(w,m,$,I=N){const T=w;if(m=rt("msgHash",m),$=rt("publicKey",$),"strict"in I)throw new Error("options.strict was renamed to lowS");const{lowS:L,prehash:C}=I;let P,z;try{if(typeof T=="string"||T instanceof Uint8Array)try{P=y.fromDER(T)}catch(V){if(!(V instanceof fe.Err))throw V;P=y.fromCompact(T)}else if(typeof T=="object"&&typeof T.r=="bigint"&&typeof T.s=="bigint"){const{r:V,s:ft}=T;P=new y(V,ft)}else throw new Error("PARSE");z=u.fromHex($)}catch(V){if(V.message==="PARSE")throw new Error("signature must be Signature instance, Uint8Array or hex string");return!1}if(L&&P.hasHighS())return!1;C&&(m=e.hash(m));const{r:G,s:at}=P,wt=x(m),et=a(at),Wt=c(wt*et),st=c(G*et),ht=u.BASE.multiplyAndAddUnsafe(z,Wt,st)?.toAffine();return ht?c(ht.x)===G:!1}return{CURVE:e,getPublicKey:S,getSharedSecret:B,sign:U,verify:j,ProjectivePoint:u,Signature:y,utils:v}}let Is=class extends vs{constructor(e,n){super(),this.finished=!1,this.destroyed=!1,Cl(e);const r=Zr(n);if(this.iHash=e.create(),typeof this.iHash.update!="function")throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;const i=this.blockLen,o=new Uint8Array(i);o.set(r.length>i?e.create().update(r).digest():r);for(let s=0;s<o.length;s++)o[s]^=54;this.iHash.update(o),this.oHash=e.create();for(let s=0;s<o.length;s++)o[s]^=106;this.oHash.update(o),o.fill(0)}update(e){return bn(this),this.iHash.update(e),this}digestInto(e){bn(this),ws(e,this.outputLen),this.finished=!0,this.iHash.digestInto(e),this.oHash.update(e),this.oHash.digestInto(e),this.destroy()}digest(){const e=new Uint8Array(this.oHash.outputLen);return this.digestInto(e),e}_cloneInto(e){e||(e=Object.create(Object.getPrototypeOf(this),{}));const{oHash:n,iHash:r,finished:i,destroyed:o,blockLen:s,outputLen:c}=this;return e=e,e.finished=i,e.destroyed=o,e.blockLen=s,e.outputLen=c,e.oHash=n._cloneInto(e.oHash),e.iHash=r._cloneInto(e.iHash),e}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}};const ks=(t,e,n)=>new Is(t,e).update(n).digest();ks.create=(t,e)=>new Is(t,e);function Sf(t){return{hash:t,hmac:(e,...n)=>ks(t,e,jl(...n)),randomBytes:Es}}function Af(t,e){const n=r=>xf({...t,...Sf(r)});return Object.freeze({...n(e),create:n})}const In=BigInt("0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffefffffc2f"),wn=BigInt("0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141"),Rs=BigInt(1),mn=BigInt(2),co=(t,e)=>(t+e/mn)/e;function Ts(t){const e=In,n=BigInt(3),r=BigInt(6),i=BigInt(11),o=BigInt(22),s=BigInt(23),c=BigInt(44),a=BigInt(88),u=t*t*t%e,l=u*u*t%e,f=pt(l,n,e)*l%e,p=pt(f,n,e)*l%e,b=pt(p,mn,e)*u%e,g=pt(b,i,e)*b%e,h=pt(g,o,e)*g%e,d=pt(h,c,e)*h%e,y=pt(d,a,e)*d%e,v=pt(y,c,e)*h%e,S=pt(v,n,e)*l%e,_=pt(S,s,e)*g%e,B=pt(_,r,e)*u%e,E=pt(B,mn,e);if(!$r.eql($r.sqr(E),t))throw new Error("Cannot find square root");return E}const $r=df(In,void 0,void 0,{sqrt:Ts}),Te=Af({a:BigInt(0),b:BigInt(7),Fp:$r,n:wn,Gx:BigInt("55066263022277343669578718895168534326250603453777594175500187360389116729240"),Gy:BigInt("32670510020758816978083085130507043184471273380659243275938904335757337482424"),h:BigInt(1),lowS:!0,endo:{beta:BigInt("0x7ae96a2b657c07106e64479eac3434e99cf0497512f58995c1396c28719501ee"),splitScalar:t=>{const e=wn,n=BigInt("0x3086d221a7d46bcde86c90e49284eb15"),r=-Rs*BigInt("0xe4437ed6010e88286f547fa90abfe4c3"),i=BigInt("0x114ca50f7a8e2f3f657c1108d9d44cfd8"),o=n,s=BigInt("0x100000000000000000000000000000000"),c=co(o*t,e),a=co(-r*t,e);let u=Q(t-c*n-a*i,e),l=Q(-c*r-a*o,e);const f=u>s,p=l>s;if(f&&(u=e-u),p&&(l=e-l),u>s||l>s)throw new Error("splitScalar: Endomorphism failed, k="+t);return{k1neg:f,k1:u,k2neg:p,k2:l}}}},xr),kn=BigInt(0),Ls=t=>typeof t=="bigint"&&kn<t&&t<In,$f=t=>typeof t=="bigint"&&kn<t&&t<wn,uo={};function vn(t,...e){let n=uo[t];if(n===void 0){const r=xr(Uint8Array.from(t,i=>i.charCodeAt(0)));n=pe(r,r),uo[t]=n}return xr(pe(n,...e))}const Qr=t=>t.toRawBytes(!0).slice(1),Br=t=>ie(t,32),er=t=>Q(t,In),je=t=>Q(t,wn),ti=Te.ProjectivePoint,Bf=(t,e,n)=>ti.BASE.multiplyAndAddUnsafe(t,e,n);function Or(t){let e=Te.utils.normPrivateKeyToScalar(t),n=ti.fromPrivateKey(e);return{scalar:n.hasEvenY()?e:je(-e),bytes:Qr(n)}}function Ns(t){if(!Ls(t))throw new Error("bad x: need 0 < x < p");const e=er(t*t),n=er(e*t+BigInt(7));let r=Ts(n);r%mn!==kn&&(r=er(-r));const i=new ti(t,r,Rs);return i.assertValidity(),i}function Us(...t){return je(ut(vn("BIP0340/challenge",...t)))}function Of(t){return Or(t).bytes}function _f(t,e,n=Es(32)){const r=rt("message",t),{bytes:i,scalar:o}=Or(e),s=rt("auxRand",n,32),c=Br(o^ut(vn("BIP0340/aux",s))),a=vn("BIP0340/nonce",c,i,r),u=je(ut(a));if(u===kn)throw new Error("sign failed: k is zero");const{bytes:l,scalar:f}=Or(u),p=Us(l,i,r),b=new Uint8Array(64);if(b.set(l,0),b.set(Br(je(f+p*o)),32),!Cs(b,r,i))throw new Error("sign: Invalid signature produced");return b}function Cs(t,e,n){const r=rt("signature",t,64),i=rt("message",e),o=rt("publicKey",n,32);try{const s=Ns(ut(o)),c=ut(r.subarray(0,32));if(!Ls(c))return!1;const a=ut(r.subarray(32,64));if(!$f(a))return!1;const u=Us(Br(c),Qr(s),i),l=Bf(s,a,je(-u));return!(!l||!l.hasEvenY()||l.toAffine().x!==c)}catch{return!1}}const St={getPublicKey:Of,sign:_f,verify:Cs,utils:{randomPrivateKey:Te.utils.randomPrivateKey,lift_x:Ns,pointToBytes:Qr,numberToBytesBE:ie,bytesToNumberBE:ut,taggedHash:vn,mod:Q}},nr=typeof globalThis=="object"&&"crypto"in globalThis?globalThis.crypto:void 0;const ei=t=>t instanceof Uint8Array,rr=t=>new DataView(t.buffer,t.byteOffset,t.byteLength),xt=(t,e)=>t<<32-e|t>>>e,If=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;if(!If)throw new Error("Non little-endian hardware is not supported");const kf=Array.from({length:256},(t,e)=>e.toString(16).padStart(2,"0"));function F(t){if(!ei(t))throw new Error("Uint8Array expected");let e="";for(let n=0;n<t.length;n++)e+=kf[t[n]];return e}function ge(t){if(typeof t!="string")throw new Error("hex string expected, got "+typeof t);const e=t.length;if(e%2)throw new Error("padded hex string expected, got unpadded hex of length "+e);const n=new Uint8Array(e/2);for(let r=0;r<n.length;r++){const i=r*2,o=t.slice(i,i+2),s=Number.parseInt(o,16);if(Number.isNaN(s)||s<0)throw new Error("Invalid byte sequence");n[r]=s}return n}function Rf(t){if(typeof t!="string")throw new Error(`utf8ToBytes expected string, got ${typeof t}`);return new Uint8Array(new TextEncoder().encode(t))}function ze(t){if(typeof t=="string"&&(t=Rf(t)),!ei(t))throw new Error(`expected Uint8Array, got ${typeof t}`);return t}function Rn(...t){const e=new Uint8Array(t.reduce((r,i)=>r+i.length,0));let n=0;return t.forEach(r=>{if(!ei(r))throw new Error("Uint8Array expected");e.set(r,n),n+=r.length}),e}class Ps{clone(){return this._cloneInto()}}function qs(t){const e=r=>t().update(ze(r)).digest(),n=t();return e.outputLen=n.outputLen,e.blockLen=n.blockLen,e.create=()=>t(),e}function Hs(t=32){if(nr&&typeof nr.getRandomValues=="function")return nr.getRandomValues(new Uint8Array(t));throw new Error("crypto.getRandomValues must be defined")}function _r(t){if(!Number.isSafeInteger(t)||t<0)throw new Error(`Wrong positive integer: ${t}`)}function Tf(t){if(typeof t!="boolean")throw new Error(`Expected boolean, not ${t}`)}function js(t,...e){if(!(t instanceof Uint8Array))throw new Error("Expected Uint8Array");if(e.length>0&&!e.includes(t.length))throw new Error(`Expected Uint8Array of length ${e}, not of length=${t.length}`)}function Lf(t){if(typeof t!="function"||typeof t.create!="function")throw new Error("Hash should be wrapped by utils.wrapConstructor");_r(t.outputLen),_r(t.blockLen)}function Nf(t,e=!0){if(t.destroyed)throw new Error("Hash instance has been destroyed");if(e&&t.finished)throw new Error("Hash#digest() has already been called")}function Uf(t,e){js(t);const n=e.outputLen;if(t.length<n)throw new Error(`digestInto() expects output buffer of length at least ${n}`)}const At={number:_r,bool:Tf,bytes:js,hash:Lf,exists:Nf,output:Uf};function Cf(t,e,n,r){if(typeof t.setBigUint64=="function")return t.setBigUint64(e,n,r);const i=BigInt(32),o=BigInt(4294967295),s=Number(n>>i&o),c=Number(n&o),a=r?4:0,u=r?0:4;t.setUint32(e+a,s,r),t.setUint32(e+u,c,r)}class Pf extends Ps{constructor(e,n,r,i){super(),this.blockLen=e,this.outputLen=n,this.padOffset=r,this.isLE=i,this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.buffer=new Uint8Array(e),this.view=rr(this.buffer)}update(e){At.exists(this);const{view:n,buffer:r,blockLen:i}=this;e=ze(e);const o=e.length;for(let s=0;s<o;){const c=Math.min(i-this.pos,o-s);if(c===i){const a=rr(e);for(;i<=o-s;s+=i)this.process(a,s);continue}r.set(e.subarray(s,s+c),this.pos),this.pos+=c,s+=c,this.pos===i&&(this.process(n,0),this.pos=0)}return this.length+=e.length,this.roundClean(),this}digestInto(e){At.exists(this),At.output(e,this),this.finished=!0;const{buffer:n,view:r,blockLen:i,isLE:o}=this;let{pos:s}=this;n[s++]=128,this.buffer.subarray(s).fill(0),this.padOffset>i-s&&(this.process(r,0),s=0);for(let f=s;f<i;f++)n[f]=0;Cf(r,i-8,BigInt(this.length*8),o),this.process(r,0);const c=rr(e),a=this.outputLen;if(a%4)throw new Error("_sha2: outputLen should be aligned to 32bit");const u=a/4,l=this.get();if(u>l.length)throw new Error("_sha2: outputLen bigger than state");for(let f=0;f<u;f++)c.setUint32(4*f,l[f],o)}digest(){const{buffer:e,outputLen:n}=this;this.digestInto(e);const r=e.slice(0,n);return this.destroy(),r}_cloneInto(e){e||(e=new this.constructor),e.set(...this.get());const{blockLen:n,buffer:r,length:i,finished:o,destroyed:s,pos:c}=this;return e.length=i,e.pos=c,e.finished=o,e.destroyed=s,i%n&&e.buffer.set(r),e}}const qf=(t,e,n)=>t&e^~t&n,Hf=(t,e,n)=>t&e^t&n^e&n,jf=new Uint32Array([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),Jt=new Uint32Array([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),Qt=new Uint32Array(64);class zs extends Pf{constructor(){super(64,32,8,!1),this.A=Jt[0]|0,this.B=Jt[1]|0,this.C=Jt[2]|0,this.D=Jt[3]|0,this.E=Jt[4]|0,this.F=Jt[5]|0,this.G=Jt[6]|0,this.H=Jt[7]|0}get(){const{A:e,B:n,C:r,D:i,E:o,F:s,G:c,H:a}=this;return[e,n,r,i,o,s,c,a]}set(e,n,r,i,o,s,c,a){this.A=e|0,this.B=n|0,this.C=r|0,this.D=i|0,this.E=o|0,this.F=s|0,this.G=c|0,this.H=a|0}process(e,n){for(let f=0;f<16;f++,n+=4)Qt[f]=e.getUint32(n,!1);for(let f=16;f<64;f++){const p=Qt[f-15],b=Qt[f-2],g=xt(p,7)^xt(p,18)^p>>>3,h=xt(b,17)^xt(b,19)^b>>>10;Qt[f]=h+Qt[f-7]+g+Qt[f-16]|0}let{A:r,B:i,C:o,D:s,E:c,F:a,G:u,H:l}=this;for(let f=0;f<64;f++){const p=xt(c,6)^xt(c,11)^xt(c,25),b=l+p+qf(c,a,u)+jf[f]+Qt[f]|0,h=(xt(r,2)^xt(r,13)^xt(r,22))+Hf(r,i,o)|0;l=u,u=a,a=c,c=s+b|0,s=o,o=i,i=r,r=b+h|0}r=r+this.A|0,i=i+this.B|0,o=o+this.C|0,s=s+this.D|0,c=c+this.E|0,a=a+this.F|0,u=u+this.G|0,l=l+this.H|0,this.set(r,i,o,s,c,a,u,l)}roundClean(){Qt.fill(0)}destroy(){this.set(0,0,0,0,0,0,0,0),this.buffer.fill(0)}}class zf extends zs{constructor(){super(),this.A=-1056596264,this.B=914150663,this.C=812702999,this.D=-150054599,this.E=-4191439,this.F=1750603025,this.G=1694076839,this.H=-1090891868,this.outputLen=28}}const Mt=qs(()=>new zs);qs(()=>new zf);function Le(t){if(!Number.isSafeInteger(t))throw new Error(`Wrong integer: ${t}`)}function Vt(...t){const e=(i,o)=>s=>i(o(s)),n=Array.from(t).reverse().reduce((i,o)=>i?e(i,o.encode):o.encode,void 0),r=t.reduce((i,o)=>i?e(i,o.decode):o.decode,void 0);return{encode:n,decode:r}}function Ft(t){return{encode:e=>{if(!Array.isArray(e)||e.length&&typeof e[0]!="number")throw new Error("alphabet.encode input should be an array of numbers");return e.map(n=>{if(Le(n),n<0||n>=t.length)throw new Error(`Digit index outside alphabet: ${n} (alphabet: ${t.length})`);return t[n]})},decode:e=>{if(!Array.isArray(e)||e.length&&typeof e[0]!="string")throw new Error("alphabet.decode input should be array of strings");return e.map(n=>{if(typeof n!="string")throw new Error(`alphabet.decode: not string element=${n}`);const r=t.indexOf(n);if(r===-1)throw new Error(`Unknown letter: "${n}". Allowed: ${t}`);return r})}}}function Kt(t=""){if(typeof t!="string")throw new Error("join separator should be string");return{encode:e=>{if(!Array.isArray(e)||e.length&&typeof e[0]!="string")throw new Error("join.encode input should be array of strings");for(let n of e)if(typeof n!="string")throw new Error(`join.encode: non-string input=${n}`);return e.join(t)},decode:e=>{if(typeof e!="string")throw new Error("join.decode input should be string");return e.split(t)}}}function Tn(t,e="="){if(Le(t),typeof e!="string")throw new Error("padding chr should be string");return{encode(n){if(!Array.isArray(n)||n.length&&typeof n[0]!="string")throw new Error("padding.encode input should be array of strings");for(let r of n)if(typeof r!="string")throw new Error(`padding.encode: non-string input=${r}`);for(;n.length*t%8;)n.push(e);return n},decode(n){if(!Array.isArray(n)||n.length&&typeof n[0]!="string")throw new Error("padding.encode input should be array of strings");for(let i of n)if(typeof i!="string")throw new Error(`padding.decode: non-string input=${i}`);let r=n.length;if(r*t%8)throw new Error("Invalid padding: string should have whole number of bytes");for(;r>0&&n[r-1]===e;r--)if(!((r-1)*t%8))throw new Error("Invalid padding: string has too much padding");return n.slice(0,r)}}}function Ds(t){if(typeof t!="function")throw new Error("normalize fn should be function");return{encode:e=>e,decode:e=>t(e)}}function lo(t,e,n){if(e<2)throw new Error(`convertRadix: wrong from=${e}, base cannot be less than 2`);if(n<2)throw new Error(`convertRadix: wrong to=${n}, base cannot be less than 2`);if(!Array.isArray(t))throw new Error("convertRadix: data should be array");if(!t.length)return[];let r=0;const i=[],o=Array.from(t);for(o.forEach(s=>{if(Le(s),s<0||s>=e)throw new Error(`Wrong integer: ${s}`)});;){let s=0,c=!0;for(let a=r;a<o.length;a++){const u=o[a],l=e*s+u;if(!Number.isSafeInteger(l)||e*s/e!==s||l-u!==e*s)throw new Error("convertRadix: carry overflow");if(s=l%n,o[a]=Math.floor(l/n),!Number.isSafeInteger(o[a])||o[a]*n+s!==l)throw new Error("convertRadix: carry overflow");if(c)o[a]?c=!1:r=a;else continue}if(i.push(s),c)break}for(let s=0;s<t.length-1&&t[s]===0;s++)i.push(0);return i.reverse()}const Ms=(t,e)=>e?Ms(e,t%e):t,En=(t,e)=>t+(e-Ms(t,e));function Ir(t,e,n,r){if(!Array.isArray(t))throw new Error("convertRadix2: data should be array");if(e<=0||e>32)throw new Error(`convertRadix2: wrong from=${e}`);if(n<=0||n>32)throw new Error(`convertRadix2: wrong to=${n}`);if(En(e,n)>32)throw new Error(`convertRadix2: carry overflow from=${e} to=${n} carryBits=${En(e,n)}`);let i=0,o=0;const s=2**n-1,c=[];for(const a of t){if(Le(a),a>=2**e)throw new Error(`convertRadix2: invalid data word=${a} from=${e}`);if(i=i<<e|a,o+e>32)throw new Error(`convertRadix2: carry overflow pos=${o} from=${e}`);for(o+=e;o>=n;o-=n)c.push((i>>o-n&s)>>>0);i&=2**o-1}if(i=i<<n-o&s,!r&&o>=e)throw new Error("Excess padding");if(!r&&i)throw new Error(`Non-zero padding: ${i}`);return r&&o>0&&c.push(i>>>0),c}function Df(t){return Le(t),{encode:e=>{if(!(e instanceof Uint8Array))throw new Error("radix.encode input should be Uint8Array");return lo(Array.from(e),2**8,t)},decode:e=>{if(!Array.isArray(e)||e.length&&typeof e[0]!="number")throw new Error("radix.decode input should be array of strings");return Uint8Array.from(lo(e,t,2**8))}}}function oe(t,e=!1){if(Le(t),t<=0||t>32)throw new Error("radix2: bits should be in (0..32]");if(En(8,t)>32||En(t,8)>32)throw new Error("radix2: carry overflow");return{encode:n=>{if(!(n instanceof Uint8Array))throw new Error("radix2.encode input should be Uint8Array");return Ir(Array.from(n),8,t,!e)},decode:n=>{if(!Array.isArray(n)||n.length&&typeof n[0]!="number")throw new Error("radix2.decode input should be array of strings");return Uint8Array.from(Ir(n,t,8,e))}}}function fo(t){if(typeof t!="function")throw new Error("unsafeWrapper fn should be function");return function(...e){try{return t.apply(null,e)}catch{}}}const Mf=Vt(oe(4),Ft("0123456789ABCDEF"),Kt("")),Vf=Vt(oe(5),Ft("ABCDEFGHIJKLMNOPQRSTUVWXYZ234567"),Tn(5),Kt(""));Vt(oe(5),Ft("0123456789ABCDEFGHIJKLMNOPQRSTUV"),Tn(5),Kt(""));Vt(oe(5),Ft("0123456789ABCDEFGHJKMNPQRSTVWXYZ"),Kt(""),Ds(t=>t.toUpperCase().replace(/O/g,"0").replace(/[IL]/g,"1")));const _t=Vt(oe(6),Ft("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"),Tn(6),Kt("")),Ff=Vt(oe(6),Ft("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_"),Tn(6),Kt("")),ni=t=>Vt(Df(58),Ft(t),Kt("")),kr=ni("123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz");ni("123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ");ni("rpshnaf39wBUDNEGHJKLM4PQRST7VWXYZ2bcdeCg65jkm8oFqi1tuvAxyz");const ho=[0,2,3,5,6,7,9,10,11],Kf={encode(t){let e="";for(let n=0;n<t.length;n+=8){const r=t.subarray(n,n+8);e+=kr.encode(r).padStart(ho[r.length],"1")}return e},decode(t){let e=[];for(let n=0;n<t.length;n+=11){const r=t.slice(n,n+11),i=ho.indexOf(r.length),o=kr.decode(r);for(let s=0;s<o.length-i;s++)if(o[s]!==0)throw new Error("base58xmr: wrong padding");e=e.concat(Array.from(o.slice(o.length-i)))}return Uint8Array.from(e)}},Rr=Vt(Ft("qpzry9x8gf2tvdw0s3jn54khce6mua7l"),Kt("")),po=[996825010,642813549,513874426,1027748829,705979059];function qe(t){const e=t>>25;let n=(t&33554431)<<5;for(let r=0;r<po.length;r++)(e>>r&1)===1&&(n^=po[r]);return n}function go(t,e,n=1){const r=t.length;let i=1;for(let o=0;o<r;o++){const s=t.charCodeAt(o);if(s<33||s>126)throw new Error(`Invalid prefix (${t})`);i=qe(i)^s>>5}i=qe(i);for(let o=0;o<r;o++)i=qe(i)^t.charCodeAt(o)&31;for(let o of e)i=qe(i)^o;for(let o=0;o<6;o++)i=qe(i);return i^=n,Rr.encode(Ir([i%2**30],30,5,!1))}function Vs(t){const e=t==="bech32"?1:734539939,n=oe(5),r=n.decode,i=n.encode,o=fo(r);function s(l,f,p=90){if(typeof l!="string")throw new Error(`bech32.encode prefix should be string, not ${typeof l}`);if(!Array.isArray(f)||f.length&&typeof f[0]!="number")throw new Error(`bech32.encode words should be array of numbers, not ${typeof f}`);const b=l.length+7+f.length;if(p!==!1&&b>p)throw new TypeError(`Length ${b} exceeds limit ${p}`);return l=l.toLowerCase(),`${l}1${Rr.encode(f)}${go(l,f,e)}`}function c(l,f=90){if(typeof l!="string")throw new Error(`bech32.decode input should be string, not ${typeof l}`);if(l.length<8||f!==!1&&l.length>f)throw new TypeError(`Wrong string length: ${l.length} (${l}). Expected (8..${f})`);const p=l.toLowerCase();if(l!==p&&l!==l.toUpperCase())throw new Error("String must be lowercase or uppercase");l=p;const b=l.lastIndexOf("1");if(b===0||b===-1)throw new Error('Letter "1" must be present between prefix and data only');const g=l.slice(0,b),h=l.slice(b+1);if(h.length<6)throw new Error("Data must be at least 6 characters long");const d=Rr.decode(h).slice(0,-6),y=go(g,d,e);if(!h.endsWith(y))throw new Error(`Invalid checksum in ${l}: expected "${y}"`);return{prefix:g,words:d}}const a=fo(c);function u(l){const{prefix:f,words:p}=c(l,!1);return{prefix:f,words:p,bytes:r(p)}}return{encode:s,decode:c,decodeToBytes:u,decodeUnsafe:a,fromWords:r,fromWordsUnsafe:o,toWords:i}}const Re=Vs("bech32");Vs("bech32m");const Wf={encode:t=>new TextDecoder().decode(t),decode:t=>new TextEncoder().encode(t)},Zf=Vt(oe(4),Ft("0123456789abcdef"),Kt(""),Ds(t=>{if(typeof t!="string"||t.length%2)throw new TypeError(`hex.decode: expected string, got ${typeof t} with length ${t.length}`);return t.toLowerCase()})),Gf={utf8:Wf,hex:Zf,base16:Mf,base32:Vf,base64:_t,base64url:Ff,base58:kr,base58xmr:Kf};`${Object.keys(Gf).join(", ")}`;function ir(t){if(!Number.isSafeInteger(t)||t<0)throw new Error(`positive integer expected, not ${t}`)}function yo(t){if(typeof t!="boolean")throw new Error(`boolean expected, not ${t}`)}function Yf(t){return t instanceof Uint8Array||t!=null&&typeof t=="object"&&t.constructor.name==="Uint8Array"}function $t(t,...e){if(!Yf(t))throw new Error("Uint8Array expected");if(e.length>0&&!e.includes(t.length))throw new Error(`Uint8Array expected of length ${e}, not of length=${t.length}`)}const it=t=>new Uint32Array(t.buffer,t.byteOffset,Math.floor(t.byteLength/4)),Xf=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;if(!Xf)throw new Error("Non little-endian hardware is not supported");const Jf=Array.from({length:256},(t,e)=>e.toString(16).padStart(2,"0"));function ye(t){$t(t);let e="";for(let n=0;n<t.length;n++)e+=Jf[t[n]];return e}const Lt={_0:48,_9:57,_A:65,_F:70,_a:97,_f:102};function bo(t){if(t>=Lt._0&&t<=Lt._9)return t-Lt._0;if(t>=Lt._A&&t<=Lt._F)return t-(Lt._A-10);if(t>=Lt._a&&t<=Lt._f)return t-(Lt._a-10)}function Fs(t){if(typeof t!="string")throw new Error("hex string expected, got "+typeof t);const e=t.length,n=e/2;if(e%2)throw new Error("padded hex string expected, got unpadded hex of length "+e);const r=new Uint8Array(n);for(let i=0,o=0;i<n;i++,o+=2){const s=bo(t.charCodeAt(o)),c=bo(t.charCodeAt(o+1));if(s===void 0||c===void 0){const a=t[o]+t[o+1];throw new Error('hex string expected, got non-hex character "'+a+'" at index '+o)}r[i]=s*16+c}return r}function Qf(t,e){if(e==null||typeof e!="object")throw new Error("options must be defined");return Object.assign(t,e)}function th(t,e){if(t.length!==e.length)return!1;let n=0;for(let r=0;r<t.length;r++)n|=t[r]^e[r];return n===0}const eh=(t,e)=>(Object.assign(e,t),e),ne=16,nh=283;function ri(t){return t<<1^nh&-(t>>7)}function ve(t,e){let n=0;for(;e>0;e>>=1)n^=t&-(e&1),t=ri(t);return n}const Tr=(()=>{let t=new Uint8Array(256);for(let n=0,r=1;n<256;n++,r^=ri(r))t[n]=r;const e=new Uint8Array(256);e[0]=99;for(let n=0;n<255;n++){let r=t[255-n];r|=r<<8,e[t[n]]=(r^r>>4^r>>5^r>>6^r>>7^99)&255}return e})(),rh=Tr.map((t,e)=>Tr.indexOf(e)),ih=t=>t<<24|t>>>8,or=t=>t<<8|t>>>24;function Ks(t,e){if(t.length!==256)throw new Error("Wrong sbox length");const n=new Uint32Array(256).map((u,l)=>e(t[l])),r=n.map(or),i=r.map(or),o=i.map(or),s=new Uint32Array(256*256),c=new Uint32Array(256*256),a=new Uint16Array(256*256);for(let u=0;u<256;u++)for(let l=0;l<256;l++){const f=u*256+l;s[f]=n[u]^r[l],c[f]=i[u]^o[l],a[f]=t[u]<<8|t[l]}return{sbox:t,sbox2:a,T0:n,T1:r,T2:i,T3:o,T01:s,T23:c}}const ii=Ks(Tr,t=>ve(t,3)<<24|t<<16|t<<8|ve(t,2)),Ws=Ks(rh,t=>ve(t,11)<<24|ve(t,13)<<16|ve(t,9)<<8|ve(t,14)),oh=(()=>{const t=new Uint8Array(16);for(let e=0,n=1;e<16;e++,n=ri(n))t[e]=n;return t})();function Zs(t){$t(t);const e=t.length;if(![16,24,32].includes(e))throw new Error(`aes: wrong key size: should be 16, 24 or 32, got: ${e}`);const{sbox2:n}=ii,r=it(t),i=r.length,o=c=>Bt(n,c,c,c,c),s=new Uint32Array(e+28);s.set(r);for(let c=i;c<s.length;c++){let a=s[c-1];c%i===0?a=o(ih(a))^oh[c/i-1]:i>6&&c%i===4&&(a=o(a)),s[c]=s[c-i]^a}return s}function sh(t){const e=Zs(t),n=e.slice(),r=e.length,{sbox2:i}=ii,{T0:o,T1:s,T2:c,T3:a}=Ws;for(let u=0;u<r;u+=4)for(let l=0;l<4;l++)n[u+l]=e[r-u-4+l];e.fill(0);for(let u=4;u<r-4;u++){const l=n[u],f=Bt(i,l,l,l,l);n[u]=o[f&255]^s[f>>>8&255]^c[f>>>16&255]^a[f>>>24]}return n}function te(t,e,n,r,i,o){return t[n<<8&65280|r>>>8&255]^e[i>>>8&65280|o>>>24&255]}function Bt(t,e,n,r,i){return t[e&255|n&65280]|t[r>>>16&255|i>>>16&65280]<<16}function wo(t,e,n,r,i){const{sbox2:o,T01:s,T23:c}=ii;let a=0;e^=t[a++],n^=t[a++],r^=t[a++],i^=t[a++];const u=t.length/4-2;for(let g=0;g<u;g++){const h=t[a++]^te(s,c,e,n,r,i),d=t[a++]^te(s,c,n,r,i,e),y=t[a++]^te(s,c,r,i,e,n),v=t[a++]^te(s,c,i,e,n,r);e=h,n=d,r=y,i=v}const l=t[a++]^Bt(o,e,n,r,i),f=t[a++]^Bt(o,n,r,i,e),p=t[a++]^Bt(o,r,i,e,n),b=t[a++]^Bt(o,i,e,n,r);return{s0:l,s1:f,s2:p,s3:b}}function ah(t,e,n,r,i){const{sbox2:o,T01:s,T23:c}=Ws;let a=0;e^=t[a++],n^=t[a++],r^=t[a++],i^=t[a++];const u=t.length/4-2;for(let g=0;g<u;g++){const h=t[a++]^te(s,c,e,i,r,n),d=t[a++]^te(s,c,n,e,i,r),y=t[a++]^te(s,c,r,n,e,i),v=t[a++]^te(s,c,i,r,n,e);e=h,n=d,r=y,i=v}const l=t[a++]^Bt(o,e,i,r,n),f=t[a++]^Bt(o,n,e,i,r),p=t[a++]^Bt(o,r,n,e,i),b=t[a++]^Bt(o,i,r,n,e);return{s0:l,s1:f,s2:p,s3:b}}function Gs(t,e){if(!e)return new Uint8Array(t);if($t(e),e.length<t)throw new Error(`aes: wrong destination length, expected at least ${t}, got: ${e.length}`);return e}function ch(t){if($t(t),t.length%ne!==0)throw new Error(`aes/(cbc-ecb).decrypt ciphertext should consist of blocks with size ${ne}`)}function uh(t,e,n){let r=t.length;const i=r%ne;if(!e&&i!==0)throw new Error("aec/(cbc-ecb): unpadded plaintext with disabled padding");const o=it(t);if(e){let a=ne-i;a||(a=ne),r=r+a}const s=Gs(r,n),c=it(s);return{b:o,o:c,out:s}}function lh(t,e){if(!e)return t;const n=t.length;if(!n)throw new Error("aes/pcks5: empty ciphertext not allowed");const r=t[n-1];if(r<=0||r>16)throw new Error(`aes/pcks5: wrong padding byte: ${r}`);const i=t.subarray(0,-r);for(let o=0;o<r;o++)if(t[n-o-1]!==r)throw new Error("aes/pcks5: wrong padding");return i}function fh(t){const e=new Uint8Array(16),n=it(e);e.set(t);const r=ne-t.length;for(let i=ne-r;i<ne;i++)e[i]=r;return n}const Ys=eh({blockSize:16,nonceLength:16},function(e,n,r={}){$t(e),$t(n,16);const i=!r.disablePadding;return{encrypt:(o,s)=>{const c=Zs(e),{b:a,o:u,out:l}=uh(o,i,s),f=it(n);let p=f[0],b=f[1],g=f[2],h=f[3],d=0;for(;d+4<=a.length;)p^=a[d+0],b^=a[d+1],g^=a[d+2],h^=a[d+3],{s0:p,s1:b,s2:g,s3:h}=wo(c,p,b,g,h),u[d++]=p,u[d++]=b,u[d++]=g,u[d++]=h;if(i){const y=fh(o.subarray(d*4));p^=y[0],b^=y[1],g^=y[2],h^=y[3],{s0:p,s1:b,s2:g,s3:h}=wo(c,p,b,g,h),u[d++]=p,u[d++]=b,u[d++]=g,u[d++]=h}return c.fill(0),l},decrypt:(o,s)=>{ch(o);const c=sh(e),a=it(n),u=Gs(o.length,s),l=it(o),f=it(u);let p=a[0],b=a[1],g=a[2],h=a[3];for(let d=0;d+4<=l.length;){const y=p,v=b,S=g,_=h;p=l[d+0],b=l[d+1],g=l[d+2],h=l[d+3];const{s0:B,s1:E,s2:x,s3:A}=ah(c,p,b,g,h);f[d++]=B^y,f[d++]=E^v,f[d++]=x^S,f[d++]=A^_}return c.fill(0),lh(u,i)}}}),Xs=t=>Uint8Array.from(t.split("").map(e=>e.charCodeAt(0))),hh=Xs("expand 16-byte k"),dh=Xs("expand 32-byte k"),ph=it(hh),Js=it(dh);Js.slice();function H(t,e){return t<<e|t>>>32-e}function Lr(t){return t.byteOffset%4===0}const Qe=64,gh=16,Qs=2**32-1,mo=new Uint32Array;function yh(t,e,n,r,i,o,s,c){const a=i.length,u=new Uint8Array(Qe),l=it(u),f=Lr(i)&&Lr(o),p=f?it(i):mo,b=f?it(o):mo;for(let g=0;g<a;s++){if(t(e,n,r,l,s,c),s>=Qs)throw new Error("arx: counter overflow");const h=Math.min(Qe,a-g);if(f&&h===Qe){const d=g/4;if(g%4!==0)throw new Error("arx: invalid block position");for(let y=0,v;y<gh;y++)v=d+y,b[v]=p[v]^l[y];g+=Qe;continue}for(let d=0,y;d<h;d++)y=g+d,o[y]=i[y]^u[d];g+=h}}function bh(t,e){const{allowShortKeys:n,extendNonceFn:r,counterLength:i,counterRight:o,rounds:s}=Qf({allowShortKeys:!1,counterLength:8,counterRight:!1,rounds:20},e);if(typeof t!="function")throw new Error("core must be a function");return ir(i),ir(s),yo(o),yo(n),(c,a,u,l,f=0)=>{$t(c),$t(a),$t(u);const p=u.length;if(l||(l=new Uint8Array(p)),$t(l),ir(f),f<0||f>=Qs)throw new Error("arx: counter overflow");if(l.length<p)throw new Error(`arx: output (${l.length}) is shorter than data (${p})`);const b=[];let g=c.length,h,d;if(g===32)h=c.slice(),b.push(h),d=Js;else if(g===16&&n)h=new Uint8Array(32),h.set(c),h.set(c,16),d=ph,b.push(h);else throw new Error(`arx: invalid 32-byte key, got length=${g}`);Lr(a)||(a=a.slice(),b.push(a));const y=it(h);if(r){if(a.length!==24)throw new Error("arx: extended nonce must be 24 bytes");r(d,y,it(a.subarray(0,16)),y),a=a.subarray(16)}const v=16-i;if(v!==a.length)throw new Error(`arx: nonce must be ${v} or 16 bytes`);if(v!==12){const _=new Uint8Array(12);_.set(a,o?0:12-a.length),a=_,b.push(a)}const S=it(a);for(yh(t,d,y,S,u,l,f,s);b.length>0;)b.pop().fill(0);return l}}function wh(t,e,n,r,i,o=20){let s=t[0],c=t[1],a=t[2],u=t[3],l=e[0],f=e[1],p=e[2],b=e[3],g=e[4],h=e[5],d=e[6],y=e[7],v=i,S=n[0],_=n[1],B=n[2],E=s,x=c,A=a,q=u,R=l,O=f,N=p,U=b,j=g,w=h,m=d,$=y,I=v,T=S,L=_,C=B;for(let z=0;z<o;z+=2)E=E+R|0,I=H(I^E,16),j=j+I|0,R=H(R^j,12),E=E+R|0,I=H(I^E,8),j=j+I|0,R=H(R^j,7),x=x+O|0,T=H(T^x,16),w=w+T|0,O=H(O^w,12),x=x+O|0,T=H(T^x,8),w=w+T|0,O=H(O^w,7),A=A+N|0,L=H(L^A,16),m=m+L|0,N=H(N^m,12),A=A+N|0,L=H(L^A,8),m=m+L|0,N=H(N^m,7),q=q+U|0,C=H(C^q,16),$=$+C|0,U=H(U^$,12),q=q+U|0,C=H(C^q,8),$=$+C|0,U=H(U^$,7),E=E+O|0,C=H(C^E,16),m=m+C|0,O=H(O^m,12),E=E+O|0,C=H(C^E,8),m=m+C|0,O=H(O^m,7),x=x+N|0,I=H(I^x,16),$=$+I|0,N=H(N^$,12),x=x+N|0,I=H(I^x,8),$=$+I|0,N=H(N^$,7),A=A+U|0,T=H(T^A,16),j=j+T|0,U=H(U^j,12),A=A+U|0,T=H(T^A,8),j=j+T|0,U=H(U^j,7),q=q+R|0,L=H(L^q,16),w=w+L|0,R=H(R^w,12),q=q+R|0,L=H(L^q,8),w=w+L|0,R=H(R^w,7);let P=0;r[P++]=s+E|0,r[P++]=c+x|0,r[P++]=a+A|0,r[P++]=u+q|0,r[P++]=l+R|0,r[P++]=f+O|0,r[P++]=p+N|0,r[P++]=b+U|0,r[P++]=g+j|0,r[P++]=h+w|0,r[P++]=d+m|0,r[P++]=y+$|0,r[P++]=v+I|0,r[P++]=S+T|0,r[P++]=_+L|0,r[P++]=B+C|0}const ta=bh(wh,{counterRight:!1,counterLength:4,allowShortKeys:!1});class ea extends Ps{constructor(e,n){super(),this.finished=!1,this.destroyed=!1,At.hash(e);const r=ze(n);if(this.iHash=e.create(),typeof this.iHash.update!="function")throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;const i=this.blockLen,o=new Uint8Array(i);o.set(r.length>i?e.create().update(r).digest():r);for(let s=0;s<o.length;s++)o[s]^=54;this.iHash.update(o),this.oHash=e.create();for(let s=0;s<o.length;s++)o[s]^=106;this.oHash.update(o),o.fill(0)}update(e){return At.exists(this),this.iHash.update(e),this}digestInto(e){At.exists(this),At.bytes(e,this.outputLen),this.finished=!0,this.iHash.digestInto(e),this.oHash.update(e),this.oHash.digestInto(e),this.destroy()}digest(){const e=new Uint8Array(this.oHash.outputLen);return this.digestInto(e),e}_cloneInto(e){e||(e=Object.create(Object.getPrototypeOf(this),{}));const{oHash:n,iHash:r,finished:i,destroyed:o,blockLen:s,outputLen:c}=this;return e=e,e.finished=i,e.destroyed=o,e.blockLen=s,e.outputLen=c,e.oHash=n._cloneInto(e.oHash),e.iHash=r._cloneInto(e.iHash),e}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}}const Ln=(t,e,n)=>new ea(t,e).update(n).digest();Ln.create=(t,e)=>new ea(t,e);function mh(t,e,n){return At.hash(t),Ln(t,ze(n),ze(e))}const sr=new Uint8Array([0]),vo=new Uint8Array;function vh(t,e,n,r=32){if(At.hash(t),At.number(r),r>255*t.outputLen)throw new Error("Length should be <= 255*HashLen");const i=Math.ceil(r/t.outputLen);n===void 0&&(n=vo);const o=new Uint8Array(i*t.outputLen),s=Ln.create(t,e),c=s._cloneInto(),a=new Uint8Array(s.outputLen);for(let u=0;u<i;u++)sr[0]=u+1,c.update(u===0?vo:a).update(n).update(sr).digestInto(a),o.set(a,t.outputLen*u),s._cloneInto(c);return s.destroy(),c.destroy(),a.fill(0),sr.fill(0),o.slice(0,r)}var Eh=Object.defineProperty,D=(t,e)=>{for(var n in e)Eh(t,n,{get:e[n],enumerable:!0})},be=Symbol("verified"),xh=t=>t instanceof Object;function oi(t){if(!xh(t)||typeof t.kind!="number"||typeof t.content!="string"||typeof t.created_at!="number"||typeof t.pubkey!="string"||!t.pubkey.match(/^[a-f0-9]{64}$/)||!Array.isArray(t.tags))return!1;for(let e=0;e<t.tags.length;e++){let n=t.tags[e];if(!Array.isArray(n))return!1;for(let r=0;r<n.length;r++)if(typeof n[r]!="string")return!1}return!0}var Sh={};D(Sh,{Queue:()=>Oh,QueueNode:()=>na,binarySearch:()=>si,bytesToHex:()=>F,hexToBytes:()=>ge,insertEventIntoAscendingList:()=>Bh,insertEventIntoDescendingList:()=>$h,normalizeURL:()=>Ah,utf8Decoder:()=>jt,utf8Encoder:()=>mt});var jt=new TextDecoder("utf-8"),mt=new TextEncoder;function Ah(t){try{t.indexOf("://")===-1&&(t="wss://"+t);let e=new URL(t);return e.protocol==="http:"?e.protocol="ws:":e.protocol==="https:"&&(e.protocol="wss:"),e.pathname=e.pathname.replace(/\/+/g,"/"),e.pathname.endsWith("/")&&(e.pathname=e.pathname.slice(0,-1)),(e.port==="80"&&e.protocol==="ws:"||e.port==="443"&&e.protocol==="wss:")&&(e.port=""),e.searchParams.sort(),e.hash="",e.toString()}catch{throw new Error(`Invalid URL: ${t}`)}}function $h(t,e){const[n,r]=si(t,i=>e.id===i.id?0:e.created_at===i.created_at?-1:i.created_at-e.created_at);return r||t.splice(n,0,e),t}function Bh(t,e){const[n,r]=si(t,i=>e.id===i.id?0:e.created_at===i.created_at?-1:e.created_at-i.created_at);return r||t.splice(n,0,e),t}function si(t,e){let n=0,r=t.length-1;for(;n<=r;){const i=Math.floor((n+r)/2),o=e(t[i]);if(o===0)return[i,!0];o<0?r=i-1:n=i+1}return[n,!1]}var na=class{value;next=null;prev=null;constructor(t){this.value=t}},Oh=class{first;last;constructor(){this.first=null,this.last=null}enqueue(t){const e=new na(t);return this.last?this.last===this.first?(this.last=e,this.last.prev=this.first,this.first.next=e):(e.prev=this.last,this.last.next=e,this.last=e):(this.first=e,this.last=e),!0}dequeue(){if(!this.first)return null;if(this.first===this.last){const e=this.first;return this.first=null,this.last=null,e.value}const t=this.first;return this.first=t.next,this.first&&(this.first.prev=null),t.value}},_h=class{generateSecretKey(){return St.utils.randomPrivateKey()}getPublicKey(e){return F(St.getPublicKey(e))}finalizeEvent(e,n){const r=e;return r.pubkey=F(St.getPublicKey(n)),r.id=rn(r),r.sig=F(St.sign(rn(r),n)),r[be]=!0,r}verifyEvent(e){if(typeof e[be]=="boolean")return e[be];const n=rn(e);if(n!==e.id)return e[be]=!1,!1;try{const r=St.verify(e.sig,n,e.pubkey);return e[be]=r,r}catch{return e[be]=!1,!1}}};function Ih(t){if(!oi(t))throw new Error("can't serialize event with wrong or missing properties");return JSON.stringify([0,t.pubkey,t.created_at,t.kind,t.tags,t.content])}function rn(t){let e=Mt(mt.encode(Ih(t)));return F(e)}var Nn=new _h,kh=Nn.generateSecretKey,ai=Nn.getPublicKey,kt=Nn.finalizeEvent,ci=Nn.verifyEvent,Rh={};D(Rh,{Application:()=>Md,BadgeAward:()=>Hh,BadgeDefinition:()=>Cd,BlockedRelaysList:()=>wd,BlossomServerList:()=>$d,BookmarkList:()=>gd,Bookmarksets:()=>Ld,Calendar:()=>Yd,CalendarEventRSVP:()=>Xd,ChannelCreation:()=>ca,ChannelHideMessage:()=>fa,ChannelMessage:()=>la,ChannelMetadata:()=>ua,ChannelMuteUser:()=>ha,ChatMessage:()=>jh,ClassifiedListing:()=>Kd,ClientAuth:()=>pa,Comment:()=>Gh,CommunitiesList:()=>yd,CommunityDefinition:()=>ep,CommunityPostApproval:()=>rd,Contacts:()=>Ch,CreateOrUpdateProduct:()=>Hd,CreateOrUpdateStall:()=>qd,Curationsets:()=>Nd,Date:()=>Zd,DirectMessageRelaysList:()=>Sd,DraftClassifiedListing:()=>Wd,DraftLong:()=>zd,Emojisets:()=>Dd,EncryptedDirectMessage:()=>Ph,EventDeletion:()=>qh,FavoriteRelays:()=>vd,FileMessage:()=>Dh,FileMetadata:()=>Zh,FileServerPreference:()=>Ad,Followsets:()=>kd,ForumThread:()=>zh,GenericRepost:()=>di,Genericlists:()=>Rd,GiftWrap:()=>da,GroupMetadata:()=>np,HTTPAuth:()=>pi,Handlerinformation:()=>tp,Handlerrecommendation:()=>Qd,Highlights:()=>ld,InterestsList:()=>Ed,Interestsets:()=>Pd,JobFeedback:()=>sd,JobRequest:()=>id,JobResult:()=>od,Label:()=>nd,LightningPubRPC:()=>Od,LiveChatMessage:()=>Yh,LiveEvent:()=>Vd,LongFormArticle:()=>jd,Metadata:()=>Nh,Mutelist:()=>hd,NWCWalletInfo:()=>Bd,NWCWalletRequest:()=>ga,NWCWalletResponse:()=>_d,NormalVideo:()=>Vh,NostrConnect:()=>Id,OpenTimestamps:()=>Kh,Photo:()=>Mh,Pinlist:()=>dd,Poll:()=>Wh,PollResponse:()=>fd,PrivateDirectMessage:()=>aa,ProblemTracker:()=>Qh,ProfileBadges:()=>Ud,PublicChatsList:()=>bd,Reaction:()=>hi,RecommendRelay:()=>Uh,RelayList:()=>pd,RelayReview:()=>Jd,Relaysets:()=>Td,Report:()=>td,Reporting:()=>ed,Repost:()=>fi,Seal:()=>sa,SearchRelaysList:()=>md,ShortTextNote:()=>oa,ShortVideo:()=>Fh,Time:()=>Gd,UserEmojiList:()=>xd,UserStatuses:()=>Fd,Voice:()=>Xh,VoiceComment:()=>Jh,Zap:()=>ud,ZapGoal:()=>ad,ZapRequest:()=>cd,classifyKind:()=>Th,isAddressableKind:()=>li,isEphemeralKind:()=>ia,isKind:()=>Lh,isRegularKind:()=>ra,isReplaceableKind:()=>ui});function ra(t){return t<1e4&&t!==0&&t!==3}function ui(t){return t===0||t===3||1e4<=t&&t<2e4}function ia(t){return 2e4<=t&&t<3e4}function li(t){return 3e4<=t&&t<4e4}function Th(t){return ra(t)?"regular":ui(t)?"replaceable":ia(t)?"ephemeral":li(t)?"parameterized":"unknown"}function Lh(t,e){const n=e instanceof Array?e:[e];return oi(t)&&n.includes(t.kind)||!1}var Nh=0,oa=1,Uh=2,Ch=3,Ph=4,qh=5,fi=6,hi=7,Hh=8,jh=9,zh=11,sa=13,aa=14,Dh=15,di=16,Mh=20,Vh=21,Fh=22,ca=40,ua=41,la=42,fa=43,ha=44,Kh=1040,da=1059,Wh=1068,Zh=1063,Gh=1111,Yh=1311,Xh=1222,Jh=1244,Qh=1971,td=1984,ed=1984,nd=1985,rd=4550,id=5999,od=6999,sd=7e3,ad=9041,cd=9734,ud=9735,ld=9802,fd=1018,hd=1e4,dd=10001,pd=10002,gd=10003,yd=10004,bd=10005,wd=10006,md=10007,vd=10012,Ed=10015,xd=10030,Sd=10050,Ad=10096,$d=10063,Bd=13194,Od=21e3,pa=22242,ga=23194,_d=23195,Id=24133,pi=27235,kd=3e4,Rd=30001,Td=30002,Ld=30003,Nd=30004,Ud=30008,Cd=30009,Pd=30015,qd=30017,Hd=30018,jd=30023,zd=30024,Dd=30030,Md=30078,Vd=30311,Fd=30315,Kd=30402,Wd=30403,Zd=31922,Gd=31923,Yd=31924,Xd=31925,Jd=31987,Qd=31989,tp=31990,ep=34550,np=39e3,rp={};D(rp,{getHex64:()=>gi,getInt:()=>ya,getSubscriptionId:()=>ip,matchEventId:()=>op,matchEventKind:()=>ap,matchEventPubkey:()=>sp});function gi(t,e){let n=e.length+3,r=t.indexOf(`"${e}":`)+n,i=t.slice(r).indexOf('"')+r+1;return t.slice(i,i+64)}function ya(t,e){let n=e.length,r=t.indexOf(`"${e}":`)+n+3,i=t.slice(r),o=Math.min(i.indexOf(","),i.indexOf("}"));return parseInt(i.slice(0,o),10)}function ip(t){let e=t.slice(0,22).indexOf('"EVENT"');if(e===-1)return null;let n=t.slice(e+7+1).indexOf('"');if(n===-1)return null;let r=e+7+1+n,i=t.slice(r+1,80).indexOf('"');if(i===-1)return null;let o=r+1+i;return t.slice(r+1,o)}function op(t,e){return e===gi(t,"id")}function sp(t,e){return e===gi(t,"pubkey")}function ap(t,e){return e===ya(t,"kind")}var cp={};D(cp,{makeAuthEvent:()=>up});function up(t,e){return{kind:pa,created_at:Math.floor(Date.now()/1e3),tags:[["relay",t],["challenge",e]],content:""}}var lp;try{lp=WebSocket}catch{}var fp;try{fp=WebSocket}catch{}var hp={};D(hp,{BECH32_REGEX:()=>ba,Bech32MaxSize:()=>yi,NostrTypeGuard:()=>dp,decode:()=>Un,decodeNostrURI:()=>gp,encodeBytes:()=>Pn,naddrEncode:()=>Ep,neventEncode:()=>vp,noteEncode:()=>wp,nprofileEncode:()=>mp,npubEncode:()=>bp,nsecEncode:()=>yp});var dp={isNProfile:t=>/^nprofile1[a-z\d]+$/.test(t||""),isNEvent:t=>/^nevent1[a-z\d]+$/.test(t||""),isNAddr:t=>/^naddr1[a-z\d]+$/.test(t||""),isNSec:t=>/^nsec1[a-z\d]{58}$/.test(t||""),isNPub:t=>/^npub1[a-z\d]{58}$/.test(t||""),isNote:t=>/^note1[a-z\d]+$/.test(t||""),isNcryptsec:t=>/^ncryptsec1[a-z\d]+$/.test(t||"")},yi=5e3,ba=/[\x21-\x7E]{1,83}1[023456789acdefghjklmnpqrstuvwxyz]{6,}/;function pp(t){const e=new Uint8Array(4);return e[0]=t>>24&255,e[1]=t>>16&255,e[2]=t>>8&255,e[3]=t&255,e}function gp(t){try{return t.startsWith("nostr:")&&(t=t.substring(6)),Un(t)}catch{return{type:"invalid",data:null}}}function Un(t){let{prefix:e,words:n}=Re.decode(t,yi),r=new Uint8Array(Re.fromWords(n));switch(e){case"nprofile":{let i=ar(r);if(!i[0]?.[0])throw new Error("missing TLV 0 for nprofile");if(i[0][0].length!==32)throw new Error("TLV 0 should be 32 bytes");return{type:"nprofile",data:{pubkey:F(i[0][0]),relays:i[1]?i[1].map(o=>jt.decode(o)):[]}}}case"nevent":{let i=ar(r);if(!i[0]?.[0])throw new Error("missing TLV 0 for nevent");if(i[0][0].length!==32)throw new Error("TLV 0 should be 32 bytes");if(i[2]&&i[2][0].length!==32)throw new Error("TLV 2 should be 32 bytes");if(i[3]&&i[3][0].length!==4)throw new Error("TLV 3 should be 4 bytes");return{type:"nevent",data:{id:F(i[0][0]),relays:i[1]?i[1].map(o=>jt.decode(o)):[],author:i[2]?.[0]?F(i[2][0]):void 0,kind:i[3]?.[0]?parseInt(F(i[3][0]),16):void 0}}}case"naddr":{let i=ar(r);if(!i[0]?.[0])throw new Error("missing TLV 0 for naddr");if(!i[2]?.[0])throw new Error("missing TLV 2 for naddr");if(i[2][0].length!==32)throw new Error("TLV 2 should be 32 bytes");if(!i[3]?.[0])throw new Error("missing TLV 3 for naddr");if(i[3][0].length!==4)throw new Error("TLV 3 should be 4 bytes");return{type:"naddr",data:{identifier:jt.decode(i[0][0]),pubkey:F(i[2][0]),kind:parseInt(F(i[3][0]),16),relays:i[1]?i[1].map(o=>jt.decode(o)):[]}}}case"nsec":return{type:e,data:r};case"npub":case"note":return{type:e,data:F(r)};default:throw new Error(`unknown prefix ${e}`)}}function ar(t){let e={},n=t;for(;n.length>0;){let r=n[0],i=n[1],o=n.slice(2,2+i);if(n=n.slice(2+i),o.length<i)throw new Error(`not enough data to read on TLV ${r}`);e[r]=e[r]||[],e[r].push(o)}return e}function yp(t){return Pn("nsec",t)}function bp(t){return Pn("npub",ge(t))}function wp(t){return Pn("note",ge(t))}function Cn(t,e){let n=Re.toWords(e);return Re.encode(t,n,yi)}function Pn(t,e){return Cn(t,e)}function mp(t){let e=bi({0:[ge(t.pubkey)],1:(t.relays||[]).map(n=>mt.encode(n))});return Cn("nprofile",e)}function vp(t){let e;t.kind!==void 0&&(e=pp(t.kind));let n=bi({0:[ge(t.id)],1:(t.relays||[]).map(r=>mt.encode(r)),2:t.author?[ge(t.author)]:[],3:e?[new Uint8Array(e)]:[]});return Cn("nevent",n)}function Ep(t){let e=new ArrayBuffer(4);new DataView(e).setUint32(0,t.kind,!1);let n=bi({0:[mt.encode(t.identifier)],1:(t.relays||[]).map(r=>mt.encode(r)),2:[ge(t.pubkey)],3:[new Uint8Array(e)]});return Cn("naddr",n)}function bi(t){let e=[];return Object.entries(t).reverse().forEach(([n,r])=>{r.forEach(i=>{let o=new Uint8Array(i.length+2);o.set([parseInt(n)],0),o.set([i.length],1),o.set(i,2),e.push(o)})}),Rn(...e)}var xp={};D(xp,{decrypt:()=>Sp,encrypt:()=>wa});function wa(t,e,n){const r=t instanceof Uint8Array?F(t):t,i=Te.getSharedSecret(r,"02"+e),o=ma(i);let s=Uint8Array.from(Hs(16)),c=mt.encode(n),a=Ys(o,s).encrypt(c),u=_t.encode(new Uint8Array(a)),l=_t.encode(new Uint8Array(s.buffer));return`${u}?iv=${l}`}function Sp(t,e,n){const r=t instanceof Uint8Array?F(t):t;let[i,o]=n.split("?iv="),s=Te.getSharedSecret(r,"02"+e),c=ma(s),a=_t.decode(o),u=_t.decode(i),l=Ys(c,a).decrypt(u);return jt.decode(l)}function ma(t){return t.slice(1,33)}var Ap={};D(Ap,{NIP05_REGEX:()=>wi,isNip05:()=>$p,isValid:()=>_p,queryProfile:()=>va,searchDomain:()=>Op,useFetchImplementation:()=>Bp});var wi=/^(?:([\w.+-]+)@)?([\w_-]+(\.[\w_-]+)+)$/,$p=t=>wi.test(t||""),qn;try{qn=fetch}catch{}function Bp(t){qn=t}async function Op(t,e=""){try{const n=`https://${t}/.well-known/nostr.json?name=${e}`,r=await qn(n,{redirect:"manual"});if(r.status!==200)throw Error("Wrong response code");return(await r.json()).names}catch{return{}}}async function va(t){const e=t.match(wi);if(!e)return null;const[,n="_",r]=e;try{const i=`https://${r}/.well-known/nostr.json?name=${n}`,o=await qn(i,{redirect:"manual"});if(o.status!==200)throw Error("Wrong response code");const s=await o.json(),c=s.names[n];return c?{pubkey:c,relays:s.relays?.[c]}:null}catch{return null}}async function _p(t,e){const n=await va(e);return n?n.pubkey===t:!1}var Ip={};D(Ip,{parse:()=>kp});function kp(t){const e={reply:void 0,root:void 0,mentions:[],profiles:[],quotes:[]};let n,r;for(let i=t.tags.length-1;i>=0;i--){const o=t.tags[i];if(o[0]==="e"&&o[1]){const[s,c,a,u,l]=o,f={id:c,relays:a?[a]:[],author:l};if(u==="root"){e.root=f;continue}if(u==="reply"){e.reply=f;continue}if(u==="mention"){e.mentions.push(f);continue}n?r=f:n=f,e.mentions.push(f);continue}if(o[0]==="q"&&o[1]){const[s,c,a]=o;e.quotes.push({id:c,relays:a?[a]:[]})}if(o[0]==="p"&&o[1]){e.profiles.push({pubkey:o[1],relays:o[2]?[o[2]]:[]});continue}}return e.root||(e.root=r||n||e.reply),e.reply||(e.reply=n||e.root),[e.reply,e.root].forEach(i=>{if(!i)return;let o=e.mentions.indexOf(i);if(o!==-1&&e.mentions.splice(o,1),i.author){let s=e.profiles.find(c=>c.pubkey===i.author);s&&s.relays&&(i.relays||(i.relays=[]),s.relays.forEach(c=>{i.relays?.indexOf(c)===-1&&i.relays.push(c)}),s.relays=i.relays)}}),e.mentions.forEach(i=>{if(i.author){let o=e.profiles.find(s=>s.pubkey===i.author);o&&o.relays&&(i.relays||(i.relays=[]),o.relays.forEach(s=>{i.relays.indexOf(s)===-1&&i.relays.push(s)}),o.relays=i.relays)}}),e}var Rp={};D(Rp,{fetchRelayInformation:()=>Lp,useFetchImplementation:()=>Tp});var Ea;try{Ea=fetch}catch{}function Tp(t){Ea=t}async function Lp(t){return await(await fetch(t.replace("ws://","http://").replace("wss://","https://"),{headers:{Accept:"application/nostr+json"}})).json()}var Np={};D(Np,{fastEventHash:()=>Sa,getPow:()=>xa,minePow:()=>Up});function xa(t){let e=0;for(let n=0;n<64;n+=8){const r=parseInt(t.substring(n,n+8),16);if(r===0)e+=32;else{e+=Math.clz32(r);break}}return e}function Up(t,e){let n=0;const r=t,i=["nonce",n.toString(),e.toString()];for(r.tags.push(i);;){const o=Math.floor(new Date().getTime()/1e3);if(o!==r.created_at&&(n=0,r.created_at=o),i[1]=(++n).toString(),r.id=Sa(r),xa(r.id)>=e)break}return r}function Sa(t){return F(Mt(mt.encode(JSON.stringify([0,t.pubkey,t.created_at,t.kind,t.tags,t.content]))))}var Cp={};D(Cp,{unwrapEvent:()=>Zp,unwrapManyEvents:()=>Gp,wrapEvent:()=>Ca,wrapManyEvents:()=>Wp});var Pp={};D(Pp,{createRumor:()=>Ta,createSeal:()=>La,createWrap:()=>Na,unwrapEvent:()=>Si,unwrapManyEvents:()=>Ua,wrapEvent:()=>xn,wrapManyEvents:()=>Fp});var qp={};D(qp,{decrypt:()=>xi,encrypt:()=>Ei,getConversationKey:()=>mi,v2:()=>Mp});var Aa=1,$a=65535;function mi(t,e){const n=Te.getSharedSecret(t,"02"+e).subarray(1,33);return mh(Mt,n,"nip44-v2")}function Ba(t,e){const n=vh(Mt,t,e,76);return{chacha_key:n.subarray(0,32),chacha_nonce:n.subarray(32,44),hmac_key:n.subarray(44,76)}}function vi(t){if(!Number.isSafeInteger(t)||t<1)throw new Error("expected positive integer");if(t<=32)return 32;const e=1<<Math.floor(Math.log2(t-1))+1,n=e<=256?32:e/8;return n*(Math.floor((t-1)/n)+1)}function Hp(t){if(!Number.isSafeInteger(t)||t<Aa||t>$a)throw new Error("invalid plaintext size: must be between 1 and 65535 bytes");const e=new Uint8Array(2);return new DataView(e.buffer).setUint16(0,t,!1),e}function jp(t){const e=mt.encode(t),n=e.length,r=Hp(n),i=new Uint8Array(vi(n)-n);return Rn(r,e,i)}function zp(t){const e=new DataView(t.buffer).getUint16(0),n=t.subarray(2,2+e);if(e<Aa||e>$a||n.length!==e||t.length!==2+vi(e))throw new Error("invalid padding");return jt.decode(n)}function Oa(t,e,n){if(n.length!==32)throw new Error("AAD associated data must be 32 bytes");const r=Rn(n,e);return Ln(Mt,t,r)}function Dp(t){if(typeof t!="string")throw new Error("payload must be a valid string");const e=t.length;if(e<132||e>87472)throw new Error("invalid payload length: "+e);if(t[0]==="#")throw new Error("unknown encryption version");let n;try{n=_t.decode(t)}catch(o){throw new Error("invalid base64: "+o.message)}const r=n.length;if(r<99||r>65603)throw new Error("invalid data length: "+r);const i=n[0];if(i!==2)throw new Error("unknown encryption version "+i);return{nonce:n.subarray(1,33),ciphertext:n.subarray(33,-32),mac:n.subarray(-32)}}function Ei(t,e,n=Hs(32)){const{chacha_key:r,chacha_nonce:i,hmac_key:o}=Ba(e,n),s=jp(t),c=ta(r,i,s),a=Oa(o,c,n);return _t.encode(Rn(new Uint8Array([2]),n,c,a))}function xi(t,e){const{nonce:n,ciphertext:r,mac:i}=Dp(t),{chacha_key:o,chacha_nonce:s,hmac_key:c}=Ba(e,n),a=Oa(c,r,n);if(!th(a,i))throw new Error("invalid MAC");const u=ta(o,s,r);return zp(u)}var Mp={utils:{getConversationKey:mi,calcPaddedLen:vi},encrypt:Ei,decrypt:xi},Vp=2880*60,_a=()=>Math.round(Date.now()/1e3),Ia=()=>Math.round(_a()-Math.random()*Vp),ka=(t,e)=>mi(t,e),Ra=(t,e,n)=>Ei(JSON.stringify(t),ka(e,n)),Eo=(t,e)=>JSON.parse(xi(t.content,ka(e,t.pubkey)));function Ta(t,e){const n={created_at:_a(),content:"",tags:[],...t,pubkey:ai(e)};return n.id=rn(n),n}function La(t,e,n){return kt({kind:sa,content:Ra(t,e,n),created_at:Ia(),tags:[]},e)}function Na(t,e){const n=kh();return kt({kind:da,content:Ra(t,n,e),created_at:Ia(),tags:[["p",e]]},n)}function xn(t,e,n){const r=Ta(t,e),i=La(r,e,n);return Na(i,n)}function Fp(t,e,n){if(!n||n.length===0)throw new Error("At least one recipient is required.");const r=ai(e),i=[xn(t,e,r)];return n.forEach(o=>{i.push(xn(t,e,o))}),i}function Si(t,e){const n=Eo(t,e);return Eo(n,e)}function Ua(t,e){let n=[];return t.forEach(r=>{n.push(Si(r,e))}),n.sort((r,i)=>r.created_at-i.created_at),n}function Kp(t,e,n,r){const i={created_at:Math.ceil(Date.now()/1e3),kind:aa,tags:[],content:e};return(Array.isArray(t)?t:[t]).forEach(({publicKey:s,relayUrl:c})=>{i.tags.push(c?["p",s,c]:["p",s])}),r&&i.tags.push(["e",r.eventId,r.relayUrl||"","reply"]),n&&i.tags.push(["subject",n]),i}function Ca(t,e,n,r,i){const o=Kp(e,n,r,i);return xn(o,t,e.publicKey)}function Wp(t,e,n,r,i){if(!e||e.length===0)throw new Error("At least one recipient is required.");return[{publicKey:ai(t)},...e].map(s=>Ca(t,s,n,r,i))}var Zp=Si,Gp=Ua,Yp={};D(Yp,{finishRepostEvent:()=>Xp,getRepostedEvent:()=>Jp,getRepostedEventPointer:()=>Pa});function Xp(t,e,n,r){let i;const o=[...t.tags??[],["e",e.id,n],["p",e.pubkey]];return e.kind===oa?i=fi:(i=di,o.push(["k",String(e.kind)])),kt({kind:i,tags:o,content:t.content===""||e.tags?.find(s=>s[0]==="-")?"":JSON.stringify(e),created_at:t.created_at},r)}function Pa(t){if(![fi,di].includes(t.kind))return;let e,n;for(let r=t.tags.length-1;r>=0&&(e===void 0||n===void 0);r--){const i=t.tags[r];i.length>=2&&(i[0]==="e"&&e===void 0?e=i:i[0]==="p"&&n===void 0&&(n=i))}if(e!==void 0)return{id:e[1],relays:[e[2],n?.[2]].filter(r=>typeof r=="string"),author:n?.[1]}}function Jp(t,{skipVerification:e}={}){const n=Pa(t);if(n===void 0||t.content==="")return;let r;try{r=JSON.parse(t.content)}catch{return}if(r.id===n.id&&!(!e&&!ci(r)))return r}var Qp={};D(Qp,{NOSTR_URI_REGEX:()=>Ai,parse:()=>eg,test:()=>tg});var Ai=new RegExp(`nostr:(${ba.source})`);function tg(t){return typeof t=="string"&&new RegExp(`^${Ai.source}$`).test(t)}function eg(t){const e=t.match(new RegExp(`^${Ai.source}$`));if(!e)throw new Error(`Invalid Nostr URI: ${t}`);return{uri:e[0],value:e[1],decoded:Un(e[1])}}var ng={};D(ng,{finishReactionEvent:()=>rg,getReactedEventPointer:()=>ig});function rg(t,e,n){const r=e.tags.filter(i=>i.length>=2&&(i[0]==="e"||i[0]==="p"));return kt({...t,kind:hi,tags:[...t.tags??[],...r,["e",e.id],["p",e.pubkey]],content:t.content??"+"},n)}function ig(t){if(t.kind!==hi)return;let e,n;for(let r=t.tags.length-1;r>=0&&(e===void 0||n===void 0);r--){const i=t.tags[r];i.length>=2&&(i[0]==="e"&&e===void 0?e=i:i[0]==="p"&&n===void 0&&(n=i))}if(!(e===void 0||n===void 0))return{id:e[1],relays:[e[2],n[2]].filter(r=>r!==void 0),author:n[1]}}var og={};D(og,{parse:()=>ag});var xo=/\W/m,So=/[^\w\/] |[^\w\/]$|$|,| /m,sg=42;function*ag(t){let e=[];if(typeof t!="string"){for(let o=0;o<t.tags.length;o++){const s=t.tags[o];s[0]==="emoji"&&s.length>=3&&e.push({type:"emoji",shortcode:s[1],url:s[2]})}t=t.content}const n=t.length;let r=0,i=0;t:for(;i<n;){const o=t.indexOf(":",i),s=t.indexOf("#",i);if(o===-1&&s===-1)break t;if(o===-1||s>=0&&s<o){if(s===0||t[s-1]===" "){const c=t.slice(s+1,s+sg).match(xo),a=c?s+1+c.index:n;yield{type:"text",text:t.slice(r,s)},yield{type:"hashtag",value:t.slice(s+1,a)},i=a,r=i;continue t}i=s+1;continue t}if(t.slice(o-5,o)==="nostr"){const c=t.slice(o+60).match(xo),a=c?o+60+c.index:n;try{let u,{data:l,type:f}=Un(t.slice(o+1,a));switch(f){case"npub":u={pubkey:l};break;case"note":u={id:l};break;case"nsec":i=a+1;continue;default:u=l}r!==o-5&&(yield{type:"text",text:t.slice(r,o-5)}),yield{type:"reference",pointer:u},i=a,r=i;continue t}catch{i=o+1;continue t}}else if(t.slice(o-5,o)==="https"||t.slice(o-4,o)==="http"){const c=t.slice(o+4).match(So),a=c?o+4+c.index:n,u=t[o-1]==="s"?5:4;try{let l=new URL(t.slice(o-u,a));if(l.hostname.indexOf(".")===-1)throw new Error("invalid url");if(r!==o-u&&(yield{type:"text",text:t.slice(r,o-u)}),/\.(png|jpe?g|gif|webp|heic|svg)$/i.test(l.pathname)){yield{type:"image",url:l.toString()},i=a,r=i;continue t}if(/\.(mp4|avi|webm|mkv|mov)$/i.test(l.pathname)){yield{type:"video",url:l.toString()},i=a,r=i;continue t}if(/\.(mp3|aac|ogg|opus|wav|flac)$/i.test(l.pathname)){yield{type:"audio",url:l.toString()},i=a,r=i;continue t}yield{type:"url",url:l.toString()},i=a,r=i;continue t}catch{i=a+1;continue t}}else if(t.slice(o-3,o)==="wss"||t.slice(o-2,o)==="ws"){const c=t.slice(o+4).match(So),a=c?o+4+c.index:n,u=t[o-1]==="s"?3:2;try{let l=new URL(t.slice(o-u,a));if(l.hostname.indexOf(".")===-1)throw new Error("invalid ws url");r!==o-u&&(yield{type:"text",text:t.slice(r,o-u)}),yield{type:"relay",url:l.toString()},i=a,r=i;continue t}catch{i=a+1;continue t}}else{for(let c=0;c<e.length;c++){const a=e[c];if(t[o+a.shortcode.length+1]===":"&&t.slice(o+1,o+a.shortcode.length+1)===a.shortcode){r!==o&&(yield{type:"text",text:t.slice(r,o)}),yield a,i=o+a.shortcode.length+2,r=i;continue t}}i=o+1;continue t}}r!==n&&(yield{type:"text",text:t.slice(r)})}var cg={};D(cg,{channelCreateEvent:()=>ug,channelHideMessageEvent:()=>hg,channelMessageEvent:()=>fg,channelMetadataEvent:()=>lg,channelMuteUserEvent:()=>dg});var ug=(t,e)=>{let n;if(typeof t.content=="object")n=JSON.stringify(t.content);else if(typeof t.content=="string")n=t.content;else return;return kt({kind:ca,tags:[...t.tags??[]],content:n,created_at:t.created_at},e)},lg=(t,e)=>{let n;if(typeof t.content=="object")n=JSON.stringify(t.content);else if(typeof t.content=="string")n=t.content;else return;return kt({kind:ua,tags:[["e",t.channel_create_event_id],...t.tags??[]],content:n,created_at:t.created_at},e)},fg=(t,e)=>{const n=[["e",t.channel_create_event_id,t.relay_url,"root"]];return t.reply_to_channel_message_event_id&&n.push(["e",t.reply_to_channel_message_event_id,t.relay_url,"reply"]),kt({kind:la,tags:[...n,...t.tags??[]],content:t.content,created_at:t.created_at},e)},hg=(t,e)=>{let n;if(typeof t.content=="object")n=JSON.stringify(t.content);else if(typeof t.content=="string")n=t.content;else return;return kt({kind:fa,tags:[["e",t.channel_message_event_id],...t.tags??[]],content:n,created_at:t.created_at},e)},dg=(t,e)=>{let n;if(typeof t.content=="object")n=JSON.stringify(t.content);else if(typeof t.content=="string")n=t.content;else return;return kt({kind:ha,tags:[["p",t.pubkey_to_mute],...t.tags??[]],content:n,created_at:t.created_at},e)},pg={};D(pg,{EMOJI_SHORTCODE_REGEX:()=>qa,matchAll:()=>gg,regex:()=>$i,replaceAll:()=>yg});var qa=/:(\w+):/,$i=()=>new RegExp(`\\B${qa.source}\\B`,"g");function*gg(t){const e=t.matchAll($i());for(const n of e)try{const[r,i]=n;yield{shortcode:r,name:i,start:n.index,end:n.index+r.length}}catch{}}function yg(t,e){return t.replaceAll($i(),(n,r)=>e({shortcode:n,name:r}))}var bg={};D(bg,{useFetchImplementation:()=>wg,validateGithub:()=>mg});var Bi;try{Bi=fetch}catch{}function wg(t){Bi=t}async function mg(t,e,n){try{return await(await Bi(`https://gist.github.com/${e}/${n}/raw`)).text()===`Verifying that I control the following Nostr public key: ${t}`}catch{return!1}}var vg={};D(vg,{makeNwcRequestEvent:()=>xg,parseConnectionString:()=>Eg});function Eg(t){const{host:e,pathname:n,searchParams:r}=new URL(t),i=n||e,o=r.get("relay"),s=r.get("secret");if(!i||!o||!s)throw new Error("invalid connection string");return{pubkey:i,relay:o,secret:s}}async function xg(t,e,n){const i=wa(e,t,JSON.stringify({method:"pay_invoice",params:{invoice:n}})),o={kind:ga,created_at:Math.round(Date.now()/1e3),content:i,tags:[["p",t]]};return kt(o,e)}var Sg={};D(Sg,{normalizeIdentifier:()=>Ag});function Ag(t){return t=t.trim().toLowerCase(),t=t.normalize("NFKC"),Array.from(t).map(e=>new RegExp("\\p{Letter}","u").test(e)||new RegExp("\\p{Number}","u").test(e)?e:"-").join("")}var $g={};D($g,{getSatoshisAmountFromBolt11:()=>Rg,getZapEndpoint:()=>Og,makeZapReceipt:()=>kg,makeZapRequest:()=>_g,useFetchImplementation:()=>Bg,validateZapRequest:()=>Ig});var Oi;try{Oi=fetch}catch{}function Bg(t){Oi=t}async function Og(t){try{let e="",{lud06:n,lud16:r}=JSON.parse(t.content);if(r){let[s,c]=r.split("@");e=new URL(`/.well-known/lnurlp/${s}`,`https://${c}`).toString()}else if(n){let{words:s}=Re.decode(n,1e3),c=Re.fromWords(s);e=jt.decode(c)}else return null;let o=await(await Oi(e)).json();if(o.allowsNostr&&o.nostrPubkey)return o.callback}catch{}return null}function _g(t){let e={kind:9734,created_at:Math.round(Date.now()/1e3),content:t.comment||"",tags:[["p","pubkey"in t?t.pubkey:t.event.pubkey],["amount",t.amount.toString()],["relays",...t.relays]]};if("event"in t){if(e.tags.push(["e",t.event.id]),ui(t.event.kind)){const n=["a",`${t.event.kind}:${t.event.pubkey}:`];e.tags.push(n)}else if(li(t.event.kind)){let n=t.event.tags.find(([i,o])=>i==="d"&&o);if(!n)throw new Error("d tag not found or is empty");const r=["a",`${t.event.kind}:${t.event.pubkey}:${n[1]}`];e.tags.push(r)}e.tags.push(["k",t.event.kind.toString()])}return e}function Ig(t){let e;try{e=JSON.parse(t)}catch{return"Invalid zap request JSON."}if(!oi(e))return"Zap request is not a valid Nostr event.";if(!ci(e))return"Invalid signature on zap request.";let n=e.tags.find(([o,s])=>o==="p"&&s);if(!n)return"Zap request doesn't have a 'p' tag.";if(!n[1].match(/^[a-f0-9]{64}$/))return"Zap request 'p' tag is not valid hex.";let r=e.tags.find(([o,s])=>o==="e"&&s);return r&&!r[1].match(/^[a-f0-9]{64}$/)?"Zap request 'e' tag is not valid hex.":e.tags.find(([o,s])=>o==="relays"&&s)?null:"Zap request doesn't have a 'relays' tag."}function kg({zapRequest:t,preimage:e,bolt11:n,paidAt:r}){let i=JSON.parse(t),o=i.tags.filter(([c])=>c==="e"||c==="p"||c==="a"),s={kind:9735,created_at:Math.round(r.getTime()/1e3),content:"",tags:[...o,["P",i.pubkey],["bolt11",n],["description",t]]};return e&&s.tags.push(["preimage",e]),s}function Rg(t){if(t.length<50)return 0;t=t.substring(0,50);const e=t.lastIndexOf("1");if(e===-1)return 0;const n=t.substring(0,e);if(!n.startsWith("lnbc"))return 0;const r=n.substring(4);if(r.length<1)return 0;const i=r[r.length-1],o=i.charCodeAt(0)-48,s=o>=0&&o<=9;let c=r.length-1;if(s&&c++,c<1)return 0;const a=parseInt(r.substring(0,c));switch(i){case"m":return a*1e5;case"u":return a*100;case"n":return a/10;case"p":return a/1e4;default:return a*1e8}}var Tg={};D(Tg,{Negentropy:()=>ja,NegentropyStorageVector:()=>Ug,NegentropySync:()=>Cg});var cr=97,Se=32,Ha=16,ae={Skip:0,Fingerprint:1,IdList:2},Ht=class{_raw;length;constructor(t){typeof t=="number"?(this._raw=new Uint8Array(t),this.length=0):t instanceof Uint8Array?(this._raw=new Uint8Array(t),this.length=t.length):(this._raw=new Uint8Array(512),this.length=0)}unwrap(){return this._raw.subarray(0,this.length)}get capacity(){return this._raw.byteLength}extend(t){if(t instanceof Ht&&(t=t.unwrap()),typeof t.length!="number")throw Error("bad length");const e=t.length+this.length;if(this.capacity<e){const n=this._raw,r=Math.max(this.capacity*2,e);this._raw=new Uint8Array(r),this._raw.set(n)}this._raw.set(t,this.length),this.length+=t.length}shift(){const t=this._raw[0];return this._raw=this._raw.subarray(1),this.length--,t}shiftN(t=1){const e=this._raw.subarray(0,t);return this._raw=this._raw.subarray(t),this.length-=t,e}};function tn(t){let e=0;for(;;){if(t.length===0)throw Error("parse ends prematurely");let n=t.shift();if(e=e<<7|n&127,(n&128)===0)break}return e}function Nt(t){if(t===0)return new Ht(new Uint8Array([0]));let e=[];for(;t!==0;)e.push(t&127),t>>>=7;e.reverse();for(let n=0;n<e.length-1;n++)e[n]|=128;return new Ht(new Uint8Array(e))}function Lg(t){return on(t,1)[0]}function on(t,e){if(t.length<e)throw Error("parse ends prematurely");return t.shiftN(e)}var Ng=class{buf;constructor(){this.setToZero()}setToZero(){this.buf=new Uint8Array(Se)}add(t){let e=0,n=0,r=new DataView(this.buf.buffer),i=new DataView(t.buffer);for(let o=0;o<8;o++){let s=o*4,c=r.getUint32(s,!0),a=i.getUint32(s,!0),u=c;u+=e,u+=a,u>4294967295&&(n=1),r.setUint32(s,u&4294967295,!0),e=n,n=0}}negate(){let t=new DataView(this.buf.buffer);for(let n=0;n<8;n++){let r=n*4;t.setUint32(r,~t.getUint32(r,!0))}let e=new Uint8Array(Se);e[0]=1,this.add(e)}getFingerprint(t){let e=new Ht;return e.extend(this.buf),e.extend(Nt(t)),Mt(e.unwrap()).subarray(0,Ha)}},Ug=class{items;sealed;constructor(){this.items=[],this.sealed=!1}insert(t,e){if(this.sealed)throw Error("already sealed");const n=Fs(e);if(n.byteLength!==Se)throw Error("bad id size for added item");this.items.push({timestamp:t,id:n})}seal(){if(this.sealed)throw Error("already sealed");this.sealed=!0,this.items.sort(ur);for(let t=1;t<this.items.length;t++)if(ur(this.items[t-1],this.items[t])===0)throw Error("duplicate item inserted")}unseal(){this.sealed=!1}size(){return this._checkSealed(),this.items.length}getItem(t){if(this._checkSealed(),t>=this.items.length)throw Error("out of range");return this.items[t]}iterate(t,e,n){this._checkSealed(),this._checkBounds(t,e);for(let r=t;r<e&&n(this.items[r],r);++r);}findLowerBound(t,e,n){return this._checkSealed(),this._checkBounds(t,e),this._binarySearch(this.items,t,e,r=>ur(r,n)<0)}fingerprint(t,e){let n=new Ng;return n.setToZero(),this.iterate(t,e,r=>(n.add(r.id),!0)),n.getFingerprint(e-t)}_checkSealed(){if(!this.sealed)throw Error("not sealed")}_checkBounds(t,e){if(t>e||e>this.items.length)throw Error("bad range")}_binarySearch(t,e,n,r){let i=n-e;for(;i>0;){let o=e,s=Math.floor(i/2);o+=s,r(t[o])?(e=++o,i-=s+1):i=s}return e}},ja=class{storage;frameSizeLimit;lastTimestampIn;lastTimestampOut;constructor(t,e=6e4){if(e<4096)throw Error("frameSizeLimit too small");this.storage=t,this.frameSizeLimit=e,this.lastTimestampIn=0,this.lastTimestampOut=0}_bound(t,e){return{timestamp:t,id:e||new Uint8Array(0)}}initiate(){let t=new Ht;return t.extend(new Uint8Array([cr])),this.splitRange(0,this.storage.size(),this._bound(Number.MAX_VALUE),t),ye(t.unwrap())}reconcile(t,e,n){const r=new Ht(Fs(t));this.lastTimestampIn=this.lastTimestampOut=0;let i=new Ht;i.extend(new Uint8Array([cr]));let o=Lg(r);if(o<96||o>111)throw Error("invalid negentropy protocol version byte");if(o!==cr)throw Error("unsupported negentropy protocol version requested: "+(o-96));let s=this.storage.size(),c=this._bound(0),a=0,u=!1;for(;r.length!==0;){let l=new Ht,f=()=>{u&&(u=!1,l.extend(this.encodeBound(c)),l.extend(Nt(ae.Skip)))},p=this.decodeBound(r),b=tn(r),g=a,h=this.storage.findLowerBound(a,s,p);if(b===ae.Skip)u=!0;else if(b===ae.Fingerprint){let d=on(r,Ha),y=this.storage.fingerprint(g,h);za(d,y)!==0?(f(),this.splitRange(g,h,p,l)):u=!0}else if(b===ae.IdList){let d=tn(r),y={};for(let v=0;v<d;v++){let S=on(r,Se);y[ye(S)]=S}if(u=!0,this.storage.iterate(g,h,v=>{let S=v.id;const _=ye(S);return y[_]?delete y[ye(S)]:e?.(_),!0}),n)for(let v of Object.values(y))n(ye(v))}else throw Error("unexpected mode");if(this.exceededFrameSizeLimit(i.length+l.length)){let d=this.storage.fingerprint(h,s);i.extend(this.encodeBound(this._bound(Number.MAX_VALUE))),i.extend(Nt(ae.Fingerprint)),i.extend(d);break}else i.extend(l);a=h,c=p}return i.length===1?null:ye(i.unwrap())}splitRange(t,e,n,r){let i=e-t,o=16;if(i<o*2)r.extend(this.encodeBound(n)),r.extend(Nt(ae.IdList)),r.extend(Nt(i)),this.storage.iterate(t,e,s=>(r.extend(s.id),!0));else{let s=Math.floor(i/o),c=i%o,a=t;for(let u=0;u<o;u++){let l=s+(u<c?1:0),f=this.storage.fingerprint(a,a+l);a+=l;let p;if(a===e)p=n;else{let b,g;this.storage.iterate(a-1,a+1,(h,d)=>(d===a-1?b=h:g=h,!0)),p=this.getMinimalBound(b,g)}r.extend(this.encodeBound(p)),r.extend(Nt(ae.Fingerprint)),r.extend(f)}}}exceededFrameSizeLimit(t){return t>this.frameSizeLimit-200}decodeTimestampIn(t){let e=tn(t);return e=e===0?Number.MAX_VALUE:e-1,this.lastTimestampIn===Number.MAX_VALUE||e===Number.MAX_VALUE?(this.lastTimestampIn=Number.MAX_VALUE,Number.MAX_VALUE):(e+=this.lastTimestampIn,this.lastTimestampIn=e,e)}decodeBound(t){let e=this.decodeTimestampIn(t),n=tn(t);if(n>Se)throw Error("bound key too long");let r=on(t,n);return{timestamp:e,id:r}}encodeTimestampOut(t){if(t===Number.MAX_VALUE)return this.lastTimestampOut=Number.MAX_VALUE,Nt(0);let e=t;return t-=this.lastTimestampOut,this.lastTimestampOut=e,Nt(t+1)}encodeBound(t){let e=new Ht;return e.extend(this.encodeTimestampOut(t.timestamp)),e.extend(Nt(t.id.length)),e.extend(t.id),e}getMinimalBound(t,e){if(e.timestamp!==t.timestamp)return this._bound(e.timestamp);{let n=0,r=e.id,i=t.id;for(let o=0;o<Se&&r[o]===i[o];o++)n++;return this._bound(e.timestamp,e.id.subarray(0,n+1))}}};function za(t,e){for(let n=0;n<t.byteLength;n++){if(t[n]<e[n])return-1;if(t[n]>e[n])return 1}return t.byteLength>e.byteLength?1:t.byteLength<e.byteLength?-1:0}function ur(t,e){return t.timestamp===e.timestamp?za(t.id,e.id):t.timestamp-e.timestamp}var Cg=class{relay;storage;neg;filter;subscription;onhave;onneed;constructor(t,e,n,r={}){this.relay=t,this.storage=e,this.neg=new ja(e),this.onhave=r.onhave,this.onneed=r.onneed,this.filter=n,this.subscription=this.relay.prepareSubscription([{}],{label:r.label||"negentropy"}),this.subscription.oncustom=i=>{switch(i[0]){case"NEG-MSG":{i.length<3&&console.warn(`got invalid NEG-MSG from ${this.relay.url}: ${i}`);try{const o=this.neg.reconcile(i[2],this.onhave,this.onneed);o?this.relay.send(`["NEG-MSG", "${this.subscription.id}", "${o}"]`):(this.close(),r.onclose?.())}catch(o){console.error("negentropy reconcile error:",o),r?.onclose?.(`reconcile error: ${o}`)}break}case"NEG-CLOSE":{const o=i[2];console.warn("negentropy error:",o),r.onclose?.(o);break}case"NEG-ERR":r.onclose?.()}}}async start(){const t=this.neg.initiate();this.relay.send(`["NEG-OPEN","${this.subscription.id}",${JSON.stringify(this.filter)},"${t}"]`)}close(){this.relay.send(`["NEG-CLOSE","${this.subscription.id}"]`),this.subscription.close()}},Pg={};D(Pg,{getToken:()=>qg,hashPayload:()=>_i,unpackEventFromToken:()=>Ma,validateEvent:()=>Ga,validateEventKind:()=>Fa,validateEventMethodTag:()=>Wa,validateEventPayloadTag:()=>Za,validateEventTimestamp:()=>Va,validateEventUrlTag:()=>Ka,validateToken:()=>Hg});var Da="Nostr ";async function qg(t,e,n,r=!1,i){const o={kind:pi,tags:[["u",t],["method",e]],created_at:Math.round(new Date().getTime()/1e3),content:""};i&&o.tags.push(["payload",_i(i)]);const s=await n(o);return(r?Da:"")+_t.encode(mt.encode(JSON.stringify(s)))}async function Hg(t,e,n){const r=await Ma(t).catch(o=>{throw o});return await Ga(r,e,n).catch(o=>{throw o})}async function Ma(t){if(!t)throw new Error("Missing token");t=t.replace(Da,"");const e=jt.decode(_t.decode(t));if(!e||e.length===0||!e.startsWith("{"))throw new Error("Invalid token");return JSON.parse(e)}function Va(t){return t.created_at?Math.round(new Date().getTime()/1e3)-t.created_at<60:!1}function Fa(t){return t.kind===pi}function Ka(t,e){const n=t.tags.find(r=>r[0]==="u");return n?n.length>0&&n[1]===e:!1}function Wa(t,e){const n=t.tags.find(r=>r[0]==="method");return n?n.length>0&&n[1].toLowerCase()===e.toLowerCase():!1}function _i(t){const e=Mt(mt.encode(JSON.stringify(t)));return F(e)}function Za(t,e){const n=t.tags.find(i=>i[0]==="payload");if(!n)return!1;const r=_i(e);return n.length>0&&n[1]===r}async function Ga(t,e,n,r){if(!ci(t))throw new Error("Invalid nostr event, signature invalid");if(!Fa(t))throw new Error("Invalid nostr event, kind invalid");if(!Va(t))throw new Error("Invalid nostr event, created_at timestamp invalid");if(!Ka(t,e))throw new Error("Invalid nostr event, url tag invalid");if(!Wa(t,n))throw new Error("Invalid nostr event, method tag invalid");if(r&&typeof r=="object"&&Object.keys(r).length>0&&!Za(t,r))throw new Error("Invalid nostr event, payload tag does not match request body hash");return!0}var jg=1063;function zg(t){const e={content:t.content,created_at:Math.floor(Date.now()/1e3),kind:jg,tags:[["url",t.url],["m",t.m],["x",t.x],["ox",t.ox]]};return t.size&&e.tags.push(["size",t.size]),t.dim&&e.tags.push(["dim",t.dim]),t.i&&e.tags.push(["i",t.i]),t.blurhash&&e.tags.push(["blurhash",t.blurhash]),t.thumb&&e.tags.push(["thumb",t.thumb]),t.image&&e.tags.push(["image",t.image]),t.summary&&e.tags.push(["summary",t.summary]),t.alt&&e.tags.push(["alt",t.alt]),t.fallback&&t.fallback.forEach(n=>e.tags.push(["fallback",n])),e}const fy=Object.freeze(Object.defineProperty({__proto__:null,generateEventTemplate:zg},Symbol.toStringTag,{value:"Module"}));var we=Symbol("verified"),Dg=t=>t instanceof Object;function Mg(t){if(!Dg(t)||typeof t.kind!="number"||typeof t.content!="string"||typeof t.created_at!="number"||typeof t.pubkey!="string"||!t.pubkey.match(/^[a-f0-9]{64}$/)||!Array.isArray(t.tags))return!1;for(let e=0;e<t.tags.length;e++){let n=t.tags[e];if(!Array.isArray(n))return!1;for(let r=0;r<n.length;r++)if(typeof n[r]!="string")return!1}return!0}new TextDecoder("utf-8");var Ii=new TextEncoder,Vg=class{generateSecretKey(){return St.utils.randomPrivateKey()}getPublicKey(t){return F(St.getPublicKey(t))}finalizeEvent(t,e){const n=t;return n.pubkey=F(St.getPublicKey(e)),n.id=lr(n),n.sig=F(St.sign(lr(n),e)),n[we]=!0,n}verifyEvent(t){if(typeof t[we]=="boolean")return t[we];const e=lr(t);if(e!==t.id)return t[we]=!1,!1;try{const n=St.verify(t.sig,e,t.pubkey);return t[we]=n,n}catch{return t[we]=!1,!1}}};function Fg(t){if(!Mg(t))throw new Error("can't serialize event with wrong or missing properties");return JSON.stringify([0,t.pubkey,t.created_at,t.kind,t.tags,t.content])}function lr(t){let e=Mt(Ii.encode(Fg(t)));return F(e)}var Hn=new Vg;Hn.generateSecretKey;Hn.getPublicKey;Hn.finalizeEvent;Hn.verifyEvent;var Kg=27235,Wg="Nostr ";async function Zg(t,e,n,r=!1,i){const o={kind:Kg,tags:[["u",t],["method",e]],created_at:Math.round(new Date().getTime()/1e3),content:""};i&&o.tags.push(["payload",Ya(i)]);const s=await n(o);return(r?Wg:"")+_t.encode(Ii.encode(JSON.stringify(s)))}function Ya(t){const e=Mt(Ii.encode(JSON.stringify(t)));return F(e)}const hy=Object.freeze(Object.defineProperty({__proto__:null,getToken:Zg,hashPayload:Ya},Symbol.toStringTag,{value:"Module"}));export{ry as G,iy as U,ty as W,fy as a,hy as b,ai as g,hp as n,ey as z};

# 統合テスト (Integration Tests)

このディレクトリには、ehagakiアプリケーションの主要な機能フローをテストする統合テストが含まれています。

## 概要

統合テストは、複数のコンポーネントが連携して動作することを検証します。ユニットテストとは異なり、実際のユーザーワークフローに近いシナリオでテストを行います。

## テストファイル

### 1. auth-to-post.integration.test.ts (18テスト)

認証から投稿作成までの完全なフローをテストします。

**テストカテゴリ:**
- **バリデーションフロー統合** (4テスト)
  - 投稿内容の検証
  - エラーメッセージの確認
  - 複数フィールドの検証

- **イベント構築フロー統合** (3テスト)
  - Nostrイベントの作成
  - メタデータの設定
  - 画像URLの埋め込み

- **MIMEタイプ検証統合** (3テスト)
  - ファイルタイプのバリデーション
  - 未対応形式の検出
  - 複数画像の検証

- **ファイルバリデーションとMIMEタイプの統合** (2テスト)
  - ファイルサイズとタイプの同時検証

- **マルチコンポーネント統合** (4テスト)
  - 認証→投稿バリデーション→イベント構築の完全フロー
  - 複数画像の処理
  - エラーハンドリングのE2Eテスト

- **投稿フロー詳細テスト** (2テスト)
  - ハッシュタグの抽出と埋め込み
  - メンションの処理

### 2. file-upload-flow.integration.test.ts (14テスト)

ファイル選択から圧縮、認証、アップロードまでのフローをテストします。

**テストカテゴリ:**
- **画像圧縮統合** (3テスト)
  - 画像圧縮の実行
  - 圧縮オプションの適用
  - 圧縮進捗の追跡

- **Nostr認証統合** (2テスト)
  - 認証ヘッダーの構築
  - 署名の検証

- **ファイルとMIMEタイプ検証の統合** (2テスト)
  - ファイルタイプの検証
  - 無効なファイルの拒否

- **エンドツーエンドアップロードフロー** (3テスト)
  - 圧縮→認証→アップロードの完全フロー
  - 複数ファイルの並列アップロード
  - プログレス追跡

- **エラーハンドリング統合** (2テスト)
  - 圧縮失敗の処理
  - 認証エラーの処理

- **ファイルバリデーション詳細** (2テスト)
  - サイズ制限の検証
  - MIMEタイプとファイル拡張子の一致検証

### 3. auth-service.integration.test.ts (14テスト)

認証サービスのバリデーション、認証、初期化フローをテストします。

**テストカテゴリ:**
- **Nsecバリデーション統合** (4テスト)
  - 有効/無効なNsecの検証
  - 様々なNsecフォーマットのテスト

- **NostrLoginAuth統合** (4テスト)
  - pubkeyの検証
  - ログアウト認証の識別

- **認証バリデーション複合シナリオ** (2テスト)
  - Nsecとnostr-loginの同時利用
  - 無効な状態の検出

- **認証フロー遷移統合** (2テスト)
  - 未認証→認証→認証済みの状態遷移
  - ログアウトフロー

- **エラーハンドリング統合** (2テスト)
  - 公開鍵導出エラー
  - ストレージエラー

### 4. editor-clipboard.integration.test.ts (29テスト) 🆕

エディターのクリップボード操作、URL判定、ハッシュタグ抽出の統合フローをテストします。

**テストカテゴリ:**
- **テキストペースト統合** (4テスト)
  - クリップボードテキストの正規化(改行コード統一)
  - 空行の保持
  - HTMLペーストの処理
  - 連続空行の制限オプション

- **URLリンク判定統合** (6テスト)
  - URL検証→正規化→プロトコルチェックのフロー
  - 画像URL検証→拡張子チェック
  - 無効なプロトコルの拒否
  - サポートされていない画像拡張子の拒否
  - 様々な画像フォーマットの認識
  - URLエンコード処理

- **ハッシュタグ判定統合** (5テスト)
  - テキストからハッシュタグ抽出→ストア更新
  - 日本語ハッシュタグの処理
  - 英数字・アンダースコアを含むハッシュタグ
  - ハッシュタグが無い場合の処理
  - 重複ハッシュタグの重複除去

- **テキストコピー統合** (2テスト)
  - エディタ内容の段落分割→クリップボード形式への変換
  - 空行を含む内容のコピー・ペースト往復

- **複合的なエディタ操作統合** (3テスト)
  - URLとハッシュタグを含むテキストの解析
  - 複数行・複数URL・複数ハッシュタグの処理
  - HTMLペースト→クリーンアップ→ハッシュタグ抽出

- **エラーケース統合** (4テスト)
  - 無効な入力の安全な処理
  - 特殊文字を含む入力
  - 非常に長いテキストの処理
  - URLに似た文字列の誤検出防止

- **エディタ状態管理統合** (2テスト)
  - ハッシュタグストアの更新・クリア
  - 大文字小文字の適切な処理

- **リアルワールドシナリオ統合** (3テスト)
  - Twitterからのペースト処理
  - Markdownテキストのペースト
  - 複数段落とハッシュタグを含む長文

## テスト実行

```bash
# 全ての統合テストを実行
npm test -- integration

# 特定の統合テストファイルを実行
npm test -- auth-to-post.integration
npm test -- file-upload-flow.integration
npm test -- auth-service.integration
npm test -- editor-clipboard.integration
```

## テスト結果 (2025-01-XX)

```
 Test Files  4 passed (4)
      Tests  75 passed (75)
```

すべての統合テストが成功しています。

## テスト設計原則

### 1. 実際のユーザーワークフローに基づく
統合テストは実際のユーザーが行う操作の流れに沿って設計されています。

### 2. 既存のユニットテストの活用
ユニットテストで使用されているモックやテストパターンを再利用し、効率的なテスト作成を実現しています。

### 3. エンドツーエンドのカバレッジ
複数のコンポーネントが連携する完全なフローをテストすることで、統合時の問題を早期に発見できます。

### 4. エラーハンドリングの検証
正常系だけでなく、エラー発生時の適切な処理も検証しています。

### 5. パフォーマンスの考慮
並列処理やプログレス追跡など、パフォーマンスに関わる機能もテスト対象に含めています。

## モック戦略

### PWAのモック
Service Workerやキャッシュ機能は`virtual:pwa-register/svelte`をモックしています。

### Storeのモック
アプリケーション状態は`appStore.svelte.ts`と`editorStore.svelte.ts`をモックしています。

### 外部ライブラリのモック
- `browser-image-compression`: 画像圧縮
- `rx-nostr`: Nostrプロトコル
- `nostr-tools`: Nostrイベント処理

## テストカバレッジ

統合テストは以下の主要機能をカバーしています:

- ✅ 認証フロー (Nsec, nostr-login)
- ✅ 投稿作成と検証
- ✅ ファイルアップロード
- ✅ 画像圧縮
- ✅ MIMEタイプ検証
- ✅ イベント構築
- ✅ エラーハンドリング
- ✅ 状態管理
- ✅ 並列処理

## 今後の拡張

以下の機能の統合テストを追加する可能性があります:

- プロフィール管理
- リレー管理 (複雑なため保留)
- エディタ操作 (複雑なため保留)
- ハッシュタグ管理
- クリップボード処理
- URLクエリパラメータ処理

## 関連ドキュメント

- [ユニットテスト](../README.md)
- [テストセットアップ](../setup.ts)
- [PWAモック](../mocks/pwa-register.ts)
